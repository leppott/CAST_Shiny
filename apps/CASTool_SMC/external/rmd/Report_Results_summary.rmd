---
title: "Report, Summary"
subtitle: "CAST"
author: "`r Sys.getenv('USERNAME')`"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
  word_document:
    toc: yes
  pdf_document:
    toc: true
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(results='asis', echo=FALSE, warning=FALSE)
# Debugging
boo.DEBUG <- FALSE
DEBUG.CaseNumber <- 4
#
# Define pipe
`%>%` <- dplyr::`%>%`
#
if(boo.DEBUG==TRUE){##IF.boo.DEBUG.START
  if(DEBUG.CaseNumber==1){##IF.DEBUG.CaseNumber.START
    TargetSiteID <- "SMC01049"
    dir_results <- "C:/Users/ann.lincoln/Documents/SEP_CAST/Results"
    probsHigh <- 0.75
    probsLow <- 0.25
    report_format="html"
  } else if(DEBUG.CaseNumber==2){
    TargetSiteID <- "907S02774"
    dir_results <- "C:/Users/ann.lincoln/Documents/SEP_CAST/Results"
  } else if(DEBUG.CaseNumber==3){
    TargetSiteID <- "403S01272"
    dir_results <- "C:/Users/ann.lincoln/Documents/SEP_CAST/Results"
  } else if(DEBUG.CaseNumber==4){
    TargetSiteID <- "905S15201"
    dir_data <- "C:/Users/ann.lincoln/Documents/SEP_CAST/Data"
    dir_results <- "C:/Users/ann.lincoln/Documents/SEP_CAST/Results"
    probsHigh <- 0.75
    probsLow <- 0.25
    useAlg <- FALSE
    useBMI <- TRUE
    report_format="html"
    removeOutliers <- TRUE
    useBC <- TRUE # Use Bray-Curtis biological dissimilarity distance matrix
    lagdays=10
    siteQual2Plot = stringr::str_to_sentence("not degraded") # options:"reference","better than","not degraded"
  }##IF.DEBUG.CaseNumber.END
}##IF.boo.DEBUG.END

```

# **REPORT INFORMATION**

```{r report_date}
  myReportDate <- format(Sys.time(), "%Y-%m-%d %H:%M:%S")
  cat(paste("**Report Date and Time:** ",myReportDate,"\n\n",sep=""))
  myUser <- Sys.getenv("USERNAME")
  cat(paste("**Generated By:** ",myUser,"\n\n",sep=""))
  # cat(paste("**CASTfxn Package Version:** ",packageVersion("CASTfxn"),"\n\n",sep=""))
  
  cat("**Selected parameters:**\n\n")
  cat(paste("\tRemove outliers? ",removeOutliers,"\n",sep=""))
  cat(paste("\tUse expected biological similarity filter? ",useBC,"\n",sep=""))
  cat(paste("\tNumber of days lag time between stressor and response sample collection = ",lagdays,"\n",sep=""))
#<<<<<<< 201909_ARL
  cat(paste("\tQuality of site displayed on analysis graphics? ",siteQual2Plot,"\n",sep=""))
  cat(paste("\tLower and upper percentiles for identifying stressors = ",probsLow
#=======
# # siteQual2Plot = stringr::str_to_sentence("not degraded") # options:"reference","better than","not degraded"
#  #cat(paste("\tQuality of site displayed on analysis graphics? ",siteQual2Plot,"\n",sep=""))
#  cat(paste("\tLower and upper quantiles for identifying stressors = ",probsLow
#>>>>>>> master
            , "-", probsHigh, "\n",sep=""))
  # cat(paste("\tLimit above which DO is not identified as a stressor = ",DOlim
  #           , "\n",sep=""))
  # cat(paste("\tLimits between which pH is not identified as a stressor = ",pHlimLow
  #           , " and ", pHlimHigh, "\n\n",sep=""))

```

# **SITE INFORMATION**

```{r SiteID}
#list.dirs(file.path(getwd(), "Results"), full.names=FALSE, recursive=FALSE)

  cat(paste("**Site ID:** ",TargetSiteID,"\n\n",sep=""))
```

```{r map, out.width="70%"}
dir.sub3 <- "SiteInfo"
#TargetSiteID <- "SRCKN001.61"
myMAP <- paste0(TargetSiteID,"_MAP.png")
fn_img <- file.path(dir_results, TargetSiteID, dir.sub3, myMAP)
if(file.exists(fn_img)==TRUE){
  knitr::include_graphics(fn_img)
} else {
  cat("No file exists; map.\n")
}
```

## *Site Photos*

```{r photos, out.width="50%", out.extra='style="padding:10px"'}
dir.sub3 <- "SiteInfo"
dir_SiteID <- file.path(dir_results, TargetSiteID, dir.sub3, "Photos")
fn_all  <- list.files(path=dir_SiteID, full.names = TRUE
                                 , pattern=".jpg|.png|.mp4")
txt_grp_msg <- "media"
#
if(length(fn_all)>0){##IF.boo.pdf.START
  msg_files <- paste0("All ", txt_grp_msg," files are in the '"
                      , paste0("Results/",dir.sub3,"/Photos"), "' folder.\n"
                      , "Images are shown here.\n\n")
  cat(msg_files)
  
  fn_Photos_jpg <- fn_all[grep(".jpg", fn_all)]
  
    if(length(fn_Photos_jpg)==0){
      txt_NoFile <- "No file exists; photos.\n"
      cat(txt_NoFile)
    } else if(file.exists(fn_Photos_jpg[1])==TRUE){
      #
      fn_img <- fn_Photos_jpg
      knitr::include_graphics(fn_img)
      #
    } else {
      cat(txt_NoFile)
    }
  
} else if(length(fn_all)==0){
  msg_files <- paste0("No ", txt_grp_msg," files exist.\n")
  
} else {
  msg_files <- ""
  
}##IF.boo.pdf.START

cat(msg_files)
#
```

## *Site Background*

```{r bkgdplots, out.width="100%", out.extra='style="padding:10px"'}
dir.sub3 <- "SiteInfo"
dir_SiteID <- file.path(dir_results, TargetSiteID, dir.sub3)
fn_all  <- list.files(path=dir_SiteID, full.names = TRUE
                                 , pattern=".png")
txt_grp_msg <- "background bar graphs"
#
if(length(fn_all)>0){##IF.boo.pdf.START
  msg_bkg <- paste0("All ", txt_grp_msg," are in the '"
                    , paste0("Results/",TargetSiteID,"/",dir.sub3)
                    , "' folder.\nSelected graphics are shown here.\n\n")
  cat(msg_bkg)
  
  desiredbkg <- c("DevelopLULC", "HousePopul", "Imperv", "StreamMetricsHydro")
  
  fn_bkgd <- fn_all[grep(".png", fn_all)]
  fn_bkgd <- fn_bkgd[grep("BKGD", fn_bkgd)]
  fn_bkgd <- fn_bkgd[grep("DevelopLULC|HousePopul|Imperv|StreamMetricsHydro", fn_bkgd)]
  
    if(length(fn_bkgd)==0){
      txt_NoFile <- "No file exists; background bar plots.\n"
      cat(txt_NoFile)
    } else if(file.exists(fn_bkgd[1])==TRUE){
      #
      fn_img <- fn_bkgd
      knitr::include_graphics(fn_img)
      #
    } else {
      cat(txt_NoFile)
    }
  
} else if(length(fn_all)==0){
  msg_bkg <- paste0("No ", txt_grp_msg," files exist.\n")
  cat(msg_bkg)
  
} else {
  msg_bkg <- ""
  cat(msg_bkg)
  
}##IF.boo.pdf.START
#
```

## *Site Sample Summary*

```{r sampsummary}
# Read file summarizing the comparator data and provide it in summary form
fnSamps <- file.path(dir_data,"SMCSiteSummary.tab")
dfSamps <- read.delim(fnSamps, header=TRUE, sep="\t")
dfSamps <- dfSamps[dfSamps$StationID_Master==TargetSiteID,]
row.names(dfSamps) <- NULL
dfSamps <- dplyr::select(dfSamps, -SampYear) %>%
    dplyr::rename(Cluster=clust, SampleDate=SampDate) %>%
    dplyr::mutate(SampleDate=lubridate::mdy(SampleDate))
sampColNames <- colnames(dfSamps)
coreColNames <- c("StationID_Master", "COMID", "Cluster", "SampleDate")
sampColNames <- setdiff(sampColNames, coreColNames)

# Get bmiIndex values, if they exist
if (useBMI==TRUE) {
    
    fnBMI <- file.path(dir_data,"SMCBenthicMetricsFinal.tab")
    dfBMI <- read.delim(fnBMI, header=TRUE, sep="\t")
    dfBMI <- dfBMI %>% 
        dplyr::filter(StationID_Master==TargetSiteID) %>%
        dplyr::select(StationID_Master, BMISampID, all_of(bmiIndex))
    if (nrow(dfBMI)>0) { # There are BMI Index values
        dfSamps <- merge(dfSamps, dfBMI
              , by.x = c("StationID_Master","BMISampID")
              , by.y = c("StationID_Master","BMISampID")
              , all.x = TRUE)
    } else { # There are no BMI Index values, so add col and set all to NA
        dfSamps <- dfSamps %>% dplyr::mutate(BMI.Index=NA)
        colnames(dfSamps[,BMI.Index]) <- bmiIndex
    }
    dfSamps[[bmiIndex]] <- ifelse(is.na(dfSamps[[bmiIndex]]),NA
                                  ,round(dfSamps[[bmiIndex]],3))
    rm(fnBMI, dfBMI)

} else {
    dfSamps[[bmiIndex]] <- NA
}


# Get algIndex values, if they exist
if (useAlg==TRUE) {
    fnAlg <- file.path(dir_data,"SMCAlgaeMetricsFinal.tab")
    dfAlg <- read.delim(fnAlg, header=TRUE, sep="\t")
    dfAlg <- dfAlg %>% 
        dplyr::filter(StationID_Master==TargetSiteID) %>%
        dplyr::select(StationID_Master, AlgSampID, eval(algIndex))
    if (nrow(dfAlg)>0) { # There are BMI Index values
        dfSamps <- merge(dfSamps, dfAlg
              , by.x = c("StationID_Master","AlgSampID")
              , by.y = c("StationID_Master","AlgSampID")
              , all.x = TRUE)
    } else { # There are no Alg Index values, so add col and set all to NA
        dfSamps <- dfSamps %>% dplyr::mutate(Alg.Index=NA)
        colnames(dfSamps[,Alg.Index]) <- algIndex
    }
    dfSamps[[algIndex]] <- ifelse(is.na(dfSamps[[algIndex]]),NA
                                  ,round(dfSamps[[algIndex]],3))
    rm(fnAlg, dfAlg)
} else {
    # Need to add the appropriate data columns to the file here
    dfSamps[[algIndex]] <- NA
}

# Get BMISampFlag, if any
fnCompSamps <- file.path(dir_results, TargetSiteID, "SiteInfo"
                         , paste0(TargetSiteID,"_COMPARATORS.tab"))
dfCompSamps <- read.delim(fnCompSamps, header = TRUE, sep = "\t")

dfSiteFlags <- dfCompSamps %>%
    dplyr::filter(StationID_Master == TargetSiteID) %>%
    dplyr::select(RespSampID, RespSampFlag) %>%
    dplyr::rename(BMISampID = RespSampID, BMISampFlag = RespSampFlag)

dfSamps <- merge(dfSamps, dfSiteFlags, all.x = TRUE)

dfSamps <- dfSamps %>%
    dplyr::select(all_of(coreColNames), all_of(bmiIndex), BMISampFlag
                  , all_of(algIndex), all_of(sampColNames))

# How to get flagged index scores? And how to represent them?

compscaption <- paste0("Samples collected from ", TargetSiteID, " over time."
                       , " Red index scores indicate degraded biological quality.")
dfSamps <- dplyr::arrange(dfSamps, "SampleDate", all_of(bmiIndex), all_of(algIndex))

if (report_format=="html") {
#<<<<<<< 201909_ARL
    # if (nrow(dfSamps)>0) {
    dfSamps <- dfSamps %>%
        dplyr::mutate(CSCI=kableExtra::cell_spec(CSCI, "html"
                        , color=ifelse(is.na(CSCI)==TRUE, "black"
                        , ifelse((CSCI<0.79)==TRUE,"red","black"))
                            , bold=ifelse(is.na(CSCI)==TRUE, FALSE
                            , ifelse((CSCI<0.79)==TRUE,TRUE,FALSE)))
                         , MMIhybrid=kableExtra::cell_spec(MMIhybrid,"html"
                            , color=ifelse(is.na(MMIhybrid)==TRUE, "black"
                            , ifelse((MMIhybrid<0.82)==TRUE,"red","black"))
                                , bold=ifelse(is.na(MMIhybrid)==TRUE, FALSE
                                , ifelse((MMIhybrid<0.82)==TRUE,TRUE,FALSE))))
        knitr::kable(dfSamps, escape=FALSE, format=report_format
                , colnames=colnames(dfSamps), caption = compscaption) %>%
            kableExtra::kable_styling(bootstrap_options = "condensed"
                , font_size = 12, full_width = FALSE, position = "left") %>%
            kableExtra::column_spec(1,bold = TRUE) %>%
            kableExtra::collapse_rows(columns=1:4, valign="top")
        
        } else {
            knitr::kable(dfSamps, format=report_format, colnames=colnames(dfSamps)
                         , caption = compscaption) %>%
                kableExtra::kable_styling(bootstrap_options = "condensed"
                                          , font_size = 12, full_width = FALSE
                                          , position = "left") %>%
                kableExtra::column_spec(1,bold = TRUE) %>%
                kableExtra::collapse_rows(columns=1:4, valign="top")
        }
        
        cat("See data gaps for explanation of flag values.")
# } else {
#     cat("No sample data available.")
# }
#=======
#dfSamps <- dfSamps %>%
#    dplyr::mutate(bmiIndex=kableExtra::cell_spec(CSCI, "html"
#                                , color=ifelse(is.na(CSCI)==TRUE, "black"
#                                , ifelse((CSCI<0.79)==TRUE,"red","black"))
#                                , bold=ifelse(is.na(CSCI)==TRUE, FALSE
#                                , ifelse((CSCI<0.79)==TRUE,TRUE,FALSE)))
#                  , algIndex=kableExtra::cell_spec(MMIhybrid,"html"
#                                , color=ifelse(is.na(MMIhybrid)==TRUE, "black"
#                                , ifelse((MMIhybrid<0.82)==TRUE,"red","black"))
#                               , bold=ifelse(is.na(MMIhybrid)==TRUE, FALSE
#                                , ifelse((MMIhybrid<0.82)==TRUE,TRUE,FALSE))))
#    knitr::kable(dfSamps, escape=FALSE, format=report_format
#                 , colnames=colnames(dfSamps), caption = compscaption) %>%
#        kableExtra::kable_styling(bootstrap_options = c("striped","condensed")
#                                  , font_size = 12, full_width = FALSE
#                                  , position = "left") %>%
#        kableExtra::column_spec(1,bold = TRUE) %>%
#        kableExtra::collapse_rows(columns=1:4, valign="top")
#
#} else {
#    knitr::kable(dfSamps, format=report_format, colnames=colnames(dfSamps)
#                 , caption = compscaption) %>%
#        kableExtra::kable_styling(bootstrap_options = c("striped","condensed")
#                                  , font_size = 12, full_width = FALSE
#                                  , position = "left") %>%
#        kableExtra::column_spec(1,bold = TRUE) %>%
#        kableExtra::collapse_rows(columns=1:4, valign="top")
#}
#>>>>>>> master


```

## *Potential Candidate Causes*

```{r BMIStrSelect}

if(useBMI==TRUE){
    
    dir.sub3 <- "CandidateCauses"
    fn_stressBMI <- paste0(TargetSiteID,"_BMI_CandCauses_StressorsEvaluated.tab")
    fn_strUsedBMI <- file.path(dir_results,TargetSiteID,"BMI",dir.sub3,fn_stressBMI)
    fn_stressBMIexcl <- paste0(TargetSiteID,"_BMI_CandCauses_StressorsExcluded.tab")
    fn_strExclBMI <- file.path(dir_results,TargetSiteID,"BMI",dir.sub3,fn_stressBMIexcl)
    
    msgBMIExclReasons <- paste0("Modeled flow metrics may be excluded for analysis for one biological community because they are not expected to impact that community. These same metrics may be included for a different biological community. Dissolved oxygen (DO) may be excluded if it falls below the percentile threshold selected but is above the absolute threshold defined as acceptable. Similarly, pH may be excluded if it falls outside the selected percentile thresholds but inside the absolute values considered acceptable.")
      
        if(file.exists(fn_strUsedBMI)){##IF.boo.pdf.START
            dfStrUsedBMI <- read.delim(fn_strUsedBMI, header = TRUE, sep = "\t")
            stressorlistBMI <- paste(as.vector(dfStrUsedBMI$Label), collapse = "\n\t * ")
            
            if(file.exists(fn_strExclBMI)){
                dfStrExclBMI <- read.delim(fn_strExclBMI, header = TRUE, sep = "\t")
                notstressorlistBMI <- paste(as.vector(dfStrExclBMI$Label)
                                            , collapse = "; ")
                if (notstressorlistBMI[1]=="None") {
                    msgstrexclBMI <- paste0("**No stressors were excluded from "
                                             , "evaluation as potential candidate "
                                             , "causes of benthic macroinvertebrate "
                                             , "impairment.**\n")
                } else {
                    msgstrexclBMI <- paste0("**Stressors excluded as potential candidate "
                                  , "causes of benthic macroinvertebrate impairment "
                                  , "include:** ", notstressorlistBMI, "\n\n"
                                  , msgBMIExclReasons, "\n\n")
                }
            } else { msgstrexclBMI <- paste0("**No stressors were excluded from "
                                             , "evaluation as potential candidate "
                                             , "causes of benthic macroinvertebrate "
                                             , "impairment.**\n")
            }

            msg_strlistBMI <- paste0("**Stressors identified as potential candidate "
                                  , "causes of benthic macroinvertebrate impairment "
                                  , "include:**\n\t* ", stressorlistBMI, "\n\n"
                                  , msgstrexclBMI, "\n\n")
        } else if(!file.exists(fn_strUsedBMI)){
            msg_strlistBMI <- paste0("**No stressors were identified as possible "
                                     , "candidate causes of benthic macroinvertebrate "
                                     , "community impairment.**\n\n")
        } else {
            msg_strlistBMI <- ""
        }##IF.boo.pdf.START
        #
    cat(msg_strlistBMI)
} else {
    cat(paste0("**No benthic macroinvertebrate data are available for "
               , TargetSiteID,".**\n\n"))
}

if(useAlg==TRUE){
    
    dir.sub3 <- "CandidateCauses"
    fn_stressALGAE <- paste0(TargetSiteID, "_ALGAE_CandCauses_StressorsEvaluated.tab")
    fn_strUsedALGAE <- file.path(dir_results, TargetSiteID, "ALGAE", dir.sub3
                                 , fn_stressALGAE)
    fn_stressALGAEexcl <- paste0(TargetSiteID
                                 , "_ALGAE_CandCauses_StressorsExcluded.tab")
    fn_strExclALGAE <- file.path(dir_results, TargetSiteID, "ALGAE", dir.sub3
                                 , fn_stressALGAEexcl)
    
        msgAlgExclReasons <- paste0("Chlorophyll-a, pheophytin-a, and ash-free dry mass from algae are excluded as algal stressors because they represent measures of algae. Modeled flow metrics may be excluded for analysis for one biological community because they are not expected to impact that community. These same metrics may be included for a different biological community. Dissolved oxygen (DO) may be excluded if it falls below the percentile threshold selected but is above the absolute threshold defined as acceptable. Similarly, pH may be excluded if it falls outside the selected percentile thresholds but inside the absolute values considered acceptable.")
      
        if(file.exists(fn_strUsedALGAE)){##IF.boo.pdf.START
            dfStrUsedALG <- read.delim(fn_strUsedALGAE, header = TRUE, sep = "\t")
            stressorlistALG <- paste(as.vector(dfStrUsedALG$Label), collapse = "\n\t* ")
            
            if(file.exists(fn_strExclALGAE)){
                dfStrExclALG <- read.delim(fn_strExclALGAE, header = TRUE, sep = "\t")
                notstressorlistALG <- paste(as.vector(dfStrExclALG$Label)
                                            , collapse = "; ")
                if (notstressorlistALG[1]=="None") {
                    msgstrexclALG <- paste0("**No stressors were excluded from "
                                             , "evaluation as potential candidate "
                                             , "causes of algal community "
                                             , "impairment.**\n")
                } else {
                    msgstrexclALG <- paste0("**Stressors excluded as potential candidate "
                                  , "causes of algal community impairment "
                                  , "include:** ", notstressorlistALG, "\n\n"
                                  , msgAlgExclReasons, ".\n")
                }
            } else { msgstrexclALG <- paste0("**No stressors were excluded from "
                                             , "evaluation as potential candidate "
                                             , "causes of algal community "
                                             , "impairment.**\n")
            }

            msg_strlistALG <- paste0("**Stressors identified as potential candidate "
                                  , "causes of algal community impairment "
                                  , "include:**\n\t* ", stressorlistALG, "\n\n"
                                  , msgstrexclALG, "\n\n")
        } else if(!file.exists(fn_strUsedALGAE)){
            msg_strlistALG <- paste0("**No stressors were identified as possible " 
                                     , "candidate causes of algal community "
                                     , "impairment.**\n\n")
        } else {
            msg_strlistALG <- ""
        }##IF.boo.pdf.START
        #
    cat(msg_strlistALG)
} else {
    cat(paste0("**No algae data are available for ", TargetSiteID,".**\n\n"))
}
```

```{r files_BMIStrBoxes}

if(useBMI==TRUE){
    dir.sub3 <- "CandidateCauses"
    txt_grp_file <- "CandCauses"
    txt_grp_msg <- "stressor box"
    fn_target <- paste0(TargetSiteID,"_BMI_", txt_grp_file, "_ALL.pdf")
    fn_all <- list.files(file.path(dir_results, TargetSiteID, "BMI", dir.sub3))
    boo_file <- fn_target %in% fn_all
    #
    if(boo_file==TRUE){##IF.boo.pdf.START
      msg_strboxdir <- paste0("All ", txt_grp_msg," plots are in the file '"
                          , fn_target,"' in the'"
                          , paste0("Results/",TargetSiteID,"/BMI/",dir.sub3)
                          , "' folder.\n")
    } else if(boo_file==FALSE){
      msg_strboxdir <- paste0("No ", txt_grp_msg," plots exist.\n")
    } else {
      msg_strboxdir <- ""
    }##IF.boo.pdf.START
    #
    cat(msg_strboxdir)

} else if(useAlg==TRUE){
    dir.sub3 <- "CandidateCauses"
    txt_grp_file <- "CandCauses"
    txt_grp_msg <- "stressor box"
    fn_target <- paste0(TargetSiteID,"_ALGAE_", txt_grp_file, "_ALL.pdf")
    fn_all <- list.files(file.path(dir_results, TargetSiteID, "ALGAE", dir.sub3))
    boo_file <- fn_target %in% fn_all
    #
    if(boo_file==TRUE){##IF.boo.pdf.START
      msg_strboxdir <- paste0("All ", txt_grp_msg," plots are in the file '"
                          , fn_target,"' in the'"
                          , paste0("Results/",TargetSiteID,"/ALGAE/",dir.sub3)
                          , "' folder.\n")
    } else if(boo_file==FALSE){
      msg_strboxdir <- paste0("No ", txt_grp_msg," plots exist.\n")
    } else {
      msg_strboxdir <- ""
    }##IF.boo.pdf.START
    #
    cat(msg_strboxdir)

} else {
    cat("")
}

```

```{r StrBoxPlots, out.width="100%", out.extra='style="padding:10px"'}

if(useBMI==TRUE){
    dir.sub3 <- "CandidateCauses"
    dir_SiteID <- file.path(dir_results, TargetSiteID, "BMI", dir.sub3)
    fn_BoxPlots  <- list.files(path=dir_SiteID, full.names = TRUE
                                     , pattern="_BMI_CandCauses")
    fn_BoxPlots_jpg <- fn_BoxPlots[grep(".png", fn_BoxPlots)]
    if(length(fn_BoxPlots_jpg)==0){
      txt_NoFile <- ""
      cat(txt_NoFile)
    } else if(file.exists(fn_BoxPlots_jpg[1])==TRUE){
      #
      cat(paste("Box plots are arranged by stressor category. Stressors requiring"
                , " further evaluation fall outside the ", probsLow, "-", probsHigh
                , " quantile range.\n\n",sep=""))
    
      fn_img <- fn_BoxPlots_jpg
      knitr::include_graphics(fn_img)
      #
    } else {
      cat(txt_NoFile)
    }
} else if (useAlg==TRUE) {
    dir.sub3 <- "CandidateCauses"
    dir_SiteID <- file.path(dir_results, TargetSiteID, "ALGAE", dir.sub3)
    fn_BoxPlots  <- list.files(path=dir_SiteID, full.names = TRUE
                                     , pattern="_ALGAE_CandCauses")
    fn_BoxPlots_jpg <- fn_BoxPlots[grep(".png", fn_BoxPlots)]
    
    if(length(fn_BoxPlots_jpg)==0){
      txt_NoFile <- ""
      cat(txt_NoFile)
    } else if(file.exists(fn_BoxPlots_jpg[1])==TRUE){
      #
      cat(paste("Box plots are arranged by stressor category. Stressors requiring"
                , " further evaluation fall outside the ", probsLow, "-", probsHigh
                , " quantile range.\n\n",sep=""))
    
      fn_img <- fn_BoxPlots_jpg
      knitr::include_graphics(fn_img)
      #
    } else {
      cat(txt_NoFile)
    }    
} else {
    cat("")
}

```

# **BMI RESULTS**

## *Biological Index Distributions*

```{r bmi_box, out.width="70%", out.extra='style="padding:10px"'}

if(useBMI==TRUE){
    dir.sub3 <- "SiteInfo"
    #TargetSiteID <- "SRCKN001.61"
    myBMIbox <- paste0(TargetSiteID,"_BMI_IndexBoxplots.png")
    fn_img <- file.path(dir_results, TargetSiteID, dir.sub3, myBMIbox)
    if(file.exists(fn_img)==TRUE){
      knitr::include_graphics(fn_img)
    } else {
      cat("Benthic macroinvertebrate index distributions are not available.\n")
    }
} else {
    cat(paste0("No benthic macroinvertebrate data for ", TargetSiteID,".\n"))
}

```

## *Comparator Site Information*

```{r bmicompsitesummarytable}
# Read file summarizing the comparator data and provide it in summary form

if(useBMI==TRUE){
    dir.sub3 <- "SiteInfo"
    mycomps <- paste0(TargetSiteID,"_BMI_SiteQualities.tab")
    fn_comps <- file.path(dir_results, TargetSiteID, dir.sub3, mycomps)
    msg_info <- paste0("Additional comparator site info, including a list of "
                       , "comparator sites and samples can be found in the '"
                       , paste0("Results/",TargetSiteID,dir.sub3), "' folder.\n\n")
    
    if(file.exists(fn_comps)==TRUE){
        cat(msg_info)
        dfcomps <- read.delim(fn_comps, header = TRUE, sep = "\t")
        dfcomps <- dplyr::select(dfcomps, -BioComm)
        compscaption <- paste0("Number of sites by type, group, and quality.")
        knitr::kable(dfcomps, format=report_format, colnames=colnames(dfcomps)
                     , caption = compscaption) %>%
        kableExtra::kable_styling(bootstrap_options = "condensed"
                                      , font_size = 12, full_width = FALSE
                                  , position = "left") %>%
        kableExtra::column_spec(1,bold = TRUE) %>%
        kableExtra::collapse_rows(columns=1:2, valign="top")
    } else {
      cat("")
    }

} else {
    cat(paste0("No benthic macroinvertebrate dataare available for ", TargetSiteID,".\n"))
}

```

```{r bmicompsitesummarystatement}
# Read file summarizing the comparator data and provide it in summary form

if(useBMI==TRUE){
    dir.sub3 <- "SiteInfo"
    mycompsamps <- paste0(TargetSiteID,"_COMPARATORS.tab")
    fncompsamps <- file.path(dir_results, TargetSiteID, dir.sub3, mycompsamps)

    if(file.exists(fncompsamps)==TRUE){
        dfcompsamps <- read.delim(fncompsamps, header = TRUE, sep = "\t"
                                  , stringsAsFactors = FALSE)
        dfcompsamps <- dfcompsamps %>%
            filter(StationID_Master != TargetSiteID)
        dfbcdist <- unique(dplyr::select(dfcompsamps, StationID_Master
                                         , BCdistance, Comment))
        totcompsamps <- nrow(dfbcdist)

        maxbcdist <- 1 - round(max(dfbcdist$BCdistance),2)
        dfbcdist <- dfbcdist %>%
            dplyr::select(StationID_Master, Comment) %>%
            dplyr::group_by(Comment) %>%
            dplyr::summarise(NumSites = n())
        
        numLTEQ <- dfbcdist %>%
            dplyr::filter(grepl("LTEQ",Comment)) %>%
            dplyr::select(NumSites)
        if (nrow(numLTEQ)==0) {
            numLTEQ <- as.numeric(0)
        } else {
            numLTEQ <- as.numeric(numLTEQ)
        }
        bc_cutoff <- as.character(stringr::str_extract(dfbcdist[1,1],"\\d{2}"))
        bc_cutoff <- as.numeric(paste0("0.",bc_cutoff))
        bc_cutoff <- 1-bc_cutoff
        numGT <- dfbcdist %>%
            dplyr::filter(grepl("GT",Comment)) %>%
            dplyr::select(NumSites)
        numGT <- as.numeric(numGT)
        
        if (numLTEQ==totcompsamps) {
            msgbcdist <- paste0("All ", numLTEQ, " comparator sites have >"
                                , maxbcdist*100, "% expected biological "
                                , "similarity.\n")
        } else if (numLTEQ<totcompsamps) {
            msgbcdist <- paste0(numLTEQ, " comparator sites have >"
                                , bc_cutoff*100, "% expected biological "
                                , "similarity and ", numGT, " comparator samples "
                                , "have between ", bc_cutoff*100, " and "
                                , maxbcdist*100, " percent expected biological "
                                , "similarity.\n")
        }
        
        cat(msgbcdist)
        
    }

} else {
    cat("")
}

```

```{r bmicompsiteflags}
# Read file summarizing the comparator data and provide it in summary form

if(useBMI==TRUE){
    dir.sub3 <- "SiteInfo"
    mycompsamps <- paste0(TargetSiteID,"_COMPARATORS.tab")
    fncompsamps <- file.path(dir_results, TargetSiteID, dir.sub3, mycompsamps)

    if(file.exists(fncompsamps)==TRUE){
        dfcompsamps <- read.delim(fncompsamps, header = TRUE, sep = "\t"
                                  , stringsAsFactors = FALSE)
        dfcompsamps <- dfcompsamps %>%
            filter(StationID_Master != TargetSiteID)

        dfcompflags <- dfcompsamps %>% 
            dplyr::select(RespSampID, Quality, RespSampFlag) %>%
            dplyr::mutate(RespSampFlag = ifelse(is.na(RespSampFlag)
                                                , "No flags", RespSampFlag)) %>%
            dplyr::group_by(RespSampFlag, Quality) %>%
            dplyr::summarise(NumSamps = n()) %>%
            tidyr::spread(key = Quality, value = NumSamps) %>%
            dplyr::rename(BMISampFlag = RespSampFlag)
        
        flagcaption <- paste0("Summary of numbers of samples flagged for "
                              , "possible inadequacies in the benthic "
                              , "macroinvertebrate data.")
        
        knitr::kable(dfcompflags, format=report_format
                     , colnames=colnames(dfcompflags)
                     , caption = flagcaption) %>%
        kableExtra::kable_styling(bootstrap_options = "condensed"
                                  , font_size = 12, full_width = FALSE
                                  , position = "left") %>%
        kableExtra::column_spec(1,bold = TRUE) %>%
        kableExtra::collapse_rows(columns=1, valign="top")

    }

} else {
    cat("")
}

```

```{r bmicompsiteflagstatement}
# Read file summarizing the comparator data and provide it in summary form

if(useBMI==TRUE){
    dir.sub3 <- "SiteInfo"
    mycompsamps <- paste0(TargetSiteID,"_COMPARATORS.tab")
    fncompsamps <- file.path(dir_results, TargetSiteID, dir.sub3, mycompsamps)

    if(file.exists(fncompsamps)==TRUE){

        msgflags <- paste0("* Insufficient individuals refers to samples "
                           , "containing fewer than 250 individuals.\n\n"
                           , "* Large percent ambiguity refers to samples "
                           , "with more than 50% ambiguous individuals.\n\n"
                           , "* Unknown refers to samples for which the "
                           , "percentage of ambiguous individuals is not "
                           , "recorded.\n\n")
        cat(msgflags)

    }
    
} else {
    cat("")
}

```

## *Weight of Evidence*

### Overall Findings

```{r WoEsummary_bmi}

if(useBMI==TRUE){
    dir.sub3 <- "WoE"
    dir_WoE_bmi <- file.path(dir_results, TargetSiteID, "BMI", dir.sub3)
    txt_grp_msg <- "Overall summary weight of evidence data"
    fn_target1 <- paste0(TargetSiteID,"_BMI_WoE_ExecSummary.tab")
    fn_WoE_ES  <- list.files(path=dir_WoE_bmi, full.names = TRUE
                                     , pattern=fn_target1)
    if(length(fn_WoE_ES)==0){
      txt_NoFile <- paste0("No ", tolower(txt_grp_msg)," exist.\n")
      cat(txt_NoFile)      
    } else if(file.exists(fn_WoE_ES[1])==TRUE){
        msg_files <- paste0(txt_grp_msg," are found in the file '", fn_target1
                          , "' in the'", dir_WoE_bmi, "' folder.\n")

        df_ES <- read.delim(file.path(dir_WoE_bmi, fn_target1), header=TRUE, sep="\t")
        df_ES <- dplyr::select(df_ES, -BioComm, BioDeg, StressorType, NumStressSamples
                               , NumStressors, WtTot_WoE, WtTotTS_barplot, WtTotCO_boxplot
                               , WtTotSR_InCase_LogRegr, WtTotSR_InCase_LinRegr
                               , WtTotSR_OutCase_LinRegr, WtTotVP_boxplot)
        df_ES <- dplyr::rename(df_ES, SiteID = StationID_Master
                               , Degraded = BioDeg
                               , Group = StressorType
                               , Stressor_Samples = NumStressSamples
                               , Stressors = NumStressors
                               , Overall_WoE = WtTot_WoE
                               , TS_Inside = WtTotTS_barplot
                               , CO_boxplot = WtTotCO_boxplot
                               , SR_Inside_LogRegr = WtTotSR_InCase_LogRegr
                               , SR_Inside_LinRegr = WtTotSR_InCase_LinRegr
                               , SR_Outside_LinRegr = WtTotSR_OutCase_LinRegr
                               , VP_Boxplot = WtTotVP_boxplot)
        df_ES <- dplyr::select(df_ES, SiteID, Degraded, Group, Stressor_Samples
                               , Stressors, Overall_WoE, TS_Inside, CO_boxplot
                               , SR_Inside_LogRegr, SR_Inside_LinRegr
                               , SR_Outside_LinRegr, VP_Boxplot)
        EScaption <- paste0("Scores for each line of evidence and overall weight "
                        , "of evidence, weighted by number of stressors in each "
                        , "group. An overall weight of evidence score of 1 "
                        , "indicates that all evaluated lines of evidence "
                        , "for all observed stressors in the group support the group "
                        , "as a cause of impairment. An overall weight of evidence "
                        , "score of -1 indicates that all evaluated lines of "
                        , "evidence for all observed stressors in the group "
                        , "refute the group as a cause of impairment.")
        knitr::kable(df_ES, format=report_format, colnames=colnames(df_ES)
                     , caption = EScaption, align = 'lllccccccccc') %>%
            kableExtra::kable_styling(bootstrap_options = "condensed"
                                      , font_size = 12) %>%
            kableExtra::collapse_rows(columns=1:2, valign="top")
    } else {
      cat(txt_NoFile)
    }
} else {
    cat(paste0("No benthic macroinvertebrate data are available for ", TargetSiteID,".\n"))
}

```

### Stressor-Specific Scores

```{r WoEscores_bmi}

if(useBMI==TRUE){
    dir.sub3 <- "WoE"
    dir_WoE_bmi <- file.path(dir_results, TargetSiteID, "BMI", dir.sub3)
    txt_grp_msg <- "Detailed weight of evidence data"
    fn_target2 <- paste0(TargetSiteID,"_BMI_WoE_ScoresTable.tab")
    fn_WoE_det  <- list.files(path=dir_WoE_bmi, full.names = TRUE
                                     , pattern=fn_target2)
    if(length(fn_WoE_det)==0){
      txt_NoFile <- "No detailed stressor-specific weight of evidence is available.\n"
      cat(txt_NoFile)      
    } else if(file.exists(fn_WoE_det[1])==TRUE){
        msg_files <- paste0(txt_grp_msg," are found in the file '", fn_target2
                          , "' in the'", dir_WoE_bmi, "' folder.\n")
        df_det <- read.delim(file.path(dir_WoE_bmi, fn_target2), header=TRUE, sep="\t")
        df_det <- dplyr::select(df_det, -Cluster, -BioComm, -Stressor, -NumInSupport
                                , -NumInRefute, -NumInIndet, -NumInNotEval
                                , -NumOutSupport, - NumOutRefute, -NumOutIndet
                                , -NumOutNotEval, -StationID_Master)
        df_det <- as.data.frame(unique(df_det))
        df_det <- dplyr::rename(df_det, Stressor = Label
                                , ResponseSampleID = RespSampID
                                , ResponseSampleDate = RespSampDate
                                , Degraded = BioDeg
                                , Narrative = BioNarrative
                                , StressorSampleID = StressSampID
                                , StressorSampleDate = StressSampDate
                                , Group = StressorType
                                , PercentRank = StressorPctRank
                                , TS_Inside = TS_barplot
                                , SR_Inside_LogRegr = SR_InCase_LogRegr
                                , SR_Inside_LinRegr = SR_InCase_LinRegr
                                , SR_Outside_LinRegr = SR_OutCase_LinRegr
                                , VP_SensitiveTaxa = VP_boxplot_senstaxa
                                , VP_TolerantTaxa = VP_boxplot_toltaxa)
        df_det <- dplyr::mutate(df_det, CSCI = round(CSCI,3)
                                , PercentRank = round(PercentRank, 3)
                                , StressorValue = ifelse(StressorValue<1
                                                         , format(StressorValue
                                                                 , digits=3)
                                                  , ifelse(StressorValue<10
                                                         , format(StressorValue
                                                                 , digits=2)
                                                  , ifelse(StressorValue<100
                                                         , format(StressorValue
                                                                 , digits=1
                                                                 , scientific=FALSE)
                                                         , format(StressorValue
                                                                 , digits=0
                                                                 , big.mark=",")))))
        df_det <- dplyr::select(df_det, Degraded, Narrative, CSCI, ResponseSampleDate
                                , ResponseSampleID, StressorSampleDate
                                , StressorSampleID, Group, Stressor, StressorValue
                                , PercentRank, WoE, TS_Inside, CO_boxplot
                                , SR_Inside_LogRegr, SR_Inside_LinRegr
                                , SR_Outside_LinRegr, VP_SensitiveTaxa
                                , VP_TolerantTaxa, SSD_ToxicityCurve, TotSupport
                                , TotRefute, TotIndet, TotNotEval)
        df_det <- dplyr::arrange(df_det, desc(Degraded), desc(CSCI), StressorSampleDate
                                , ResponseSampleID, StressorSampleID, Group
                                , Stressor, StressorValue)
    
        Detcaption <- paste0("Scores for each line of evidence equal 1 (supports), "
                             , "-1 (refutes), 0 (indeterminate), or NE (not evaluated).")
        knitr::kable(df_det, format=report_format, colnames=colnames(df_det)
                     , caption = Detcaption, align='llcclclllrrlcccccccccccc') %>%
            kableExtra::kable_styling(bootstrap_options = "condensed"
                                      , font_size = 12) %>%
            kableExtra::column_spec(1,bold = TRUE) %>%
            kableExtra::collapse_rows(columns=1:8, valign="top")
    } else {
      cat(txt_NoFile)
    }

} else {
    cat(paste0("No benthic macroinvertebrate data are available for ", TargetSiteID,".\n"))
}

```

# **ALGAE RESULTS**

## *Biological Index Distributions*

```{r alg_box, out.width="70%", out.extra='style="padding:10px"'}

if(useAlg==TRUE){
    dir.sub3 <- "SiteInfo"
    #TargetSiteID <- "SRCKN001.61"
    myBMIbox <- paste0(TargetSiteID,"_ALGAE_IndexBoxplots.png")
    fn_img <- file.path(dir_results, TargetSiteID, dir.sub3, myBMIbox)
    if(file.exists(fn_img)==TRUE){
      knitr::include_graphics(fn_img)
    } else {
      cat("Algae index distributions are not available.\n")
    }
} else {
    cat(paste0("No algal data are available for ", TargetSiteID,".\n"))
}

```

## *Comparator Site Information*

```{r algcompsiteinfo}
# Read file summarizing the comparator data and provide it in summary form

if(useAlg==TRUE){
    dir.sub3 <- "SiteInfo"
    mycomps <- paste0(TargetSiteID,"_ALGAE_SiteQualities.tab")
    fn_comps <- file.path(dir_results, TargetSiteID, dir.sub3, mycomps)
    msg_info <- paste0("Additional comparator site info, including a list of "
                       , "comparator sites can be found in the '"
                       , paste0("Results/",TargetSiteID,"/ALGAE/",dir.sub3)
                       , "' folder.")
    
    if(file.exists(fn_comps)==TRUE){
        cat(msg_info)
        dfcomps <- read.delim(fn_comps, header = TRUE, sep = "\t")
        dfcomps <- dplyr::select(dfcomps, -BioComm)
        compscaption <- paste0("Number of sites by type, group, and quality.")
        knitr::kable(dfcomps, format=report_format, colnames=colnames(dfcomps)
                     , caption = compscaption) %>%
        kableExtra::kable_styling(bootstrap_options = "condensed"
                                      , font_size = 12, full_width = FALSE
                                  , position = "left") %>%
        kableExtra::column_spec(1,bold = TRUE) %>%
        kableExtra::collapse_rows(columns=1:2, valign="top")
    } else {
      cat("No comparator site information is available for algae.\n")
    }    
} else {
    cat(paste0("No algal data are available for ", TargetSiteID,".\n"))
}

```

## *Weight of Evidence*

### Overall Findings

```{r WoEsummary_alg}

if(useAlg==TRUE){
    dir.sub3 <- "WoE"
    dir_WoE_alg <- file.path(dir_results, TargetSiteID, "ALGAE", dir.sub3)
    txt_grp_msg <- "Overall summary weight of evidence data"
    fn_target1 <- paste0(TargetSiteID,"_ALGAE_WoE_ExecSummary.tab")
    fn_WoE_ES  <- list.files(path=dir_WoE_alg, full.names = TRUE
                                     , pattern=fn_target1)
    if(length(fn_WoE_ES)==0){
      txt_NoFile <- paste0("No ", tolower(txt_grp_msg)," exist.\n")
      cat(txt_NoFile)      
    } else if(file.exists(fn_WoE_ES[1])==TRUE){
        msg_files <- paste0(txt_grp_msg," are found in the file '", fn_target1
                          , "' in the'", dir_WoE_alg, "' folder.\n")

        df_ES <- read.delim(file.path(dir_WoE_alg, fn_target1), header=TRUE, sep="\t")
        df_ES <- dplyr::select(df_ES, -BioComm, BioDeg, StressorType, NumStressSamples
                               , NumStressors, WtTot_WoE, WtTotTS_barplot, WtTotCO_boxplot
                               , WtTotSR_InCase_LogRegr, WtTotSR_InCase_LinRegr
                               , WtTotSR_OutCase_LinRegr, WtTotVP_boxplot)
        df_ES <- dplyr::rename(df_ES, SiteID = StationID_Master
                               , Degraded = BioDeg
                               , Group = StressorType
                               , Stressor_Samples = NumStressSamples
                               , Stressors = NumStressors
                               , Overall_WoE = WtTot_WoE
                               , TS_Inside = WtTotTS_barplot
                               , CO_boxplot = WtTotCO_boxplot
                               , SR_Inside_LogRegr = WtTotSR_InCase_LogRegr
                               , SR_Inside_LinRegr = WtTotSR_InCase_LinRegr
                               , SR_Outside_LinRegr = WtTotSR_OutCase_LinRegr
                               , VP_Boxplot = WtTotVP_boxplot)
        df_ES <- dplyr::select(df_ES, SiteID, Degraded, Group, Stressor_Samples
                               , Stressors, Overall_WoE, TS_Inside, CO_boxplot
                               , SR_Inside_LogRegr, SR_Inside_LinRegr
                               , SR_Outside_LinRegr, VP_Boxplot)
        EScaption <- paste0("Scores for each line of evidence and overall weight "
                        , "of evidence, weighted by number of stressors in each "
                        , "group. An overall weight of evidence score of 1 "
                        , "indicates that all evaluated lines of evidence "
                        , "for all observed stressors in the group support the group "
                        , "as a cause of impairment. An overall weight of evidence "
                        , "score of -1 indicates that all evaluated lines of "
                        , "evidence for all observed stressors in the group "
                        , "refute the group as a cause of impairment.")
        knitr::kable(df_ES, format=report_format, colnames=colnames(df_ES)
                     , caption = EScaption, align = 'lllccccccccc') %>%
            kableExtra::kable_styling(bootstrap_options = "condensed"
                                      , font_size = 12) %>%
            kableExtra::collapse_rows(columns=1:2, valign="top")
    } else {
      cat(txt_NoFile)
    }
} else {
    cat(paste0("No algae data are available for ", TargetSiteID,".\n"))
}
```

### Stressor-Specific Scores

```{r WoEscores_alg}

if(useAlg==TRUE){
    dir.sub3 <- "WoE"
    dir_WoE_alg <- file.path(dir_results, TargetSiteID, "ALGAE", dir.sub3)
    txt_grp_msg <- "Detailed weight of evidence data"
    fn_target2 <- paste0(TargetSiteID,"_ALGAE_WoE_ScoresTable.tab")
    fn_WoE_det  <- list.files(path=dir_WoE_alg, full.names = TRUE
                                     , pattern=fn_target2)
    if(length(fn_WoE_det)==0){
      txt_NoFile <- "No detailed stressor-specific weight of evidence is available.\n"
      cat(txt_NoFile)      
    } else if(file.exists(fn_WoE_det[1])==TRUE){
        msg_files <- paste0(txt_grp_msg," are found in the file '", fn_target2
                          , "' in the'", dir_WoE_alg, "' folder.\n")
        df_det <- read.delim(file.path(dir_WoE_alg, fn_target2), header=TRUE, sep="\t")
        df_det <- dplyr::select(df_det, -Cluster, -BioComm, -Stressor, -NumInSupport
                                , -NumInRefute, -NumInIndet, -NumInNotEval
                                , -NumOutSupport, - NumOutRefute, -NumOutIndet
                                , -NumOutNotEval, -StationID_Master)
        df_det <- as.data.frame(unique(df_det))
        df_det <- dplyr::rename(df_det, Stressor = Label
                                , ResponseSampleID = RespSampID
                                , ResponseSampleDate = RespSampDate
                                , Degraded = BioDeg
                                , Narrative = BioNarrative
                                , StressorSampleID = StressSampID
                                , StressorSampleDate = StressSampDate
                                , Group = StressorType
                                , PercentRank = StressorPctRank
                                , TS_Inside = TS_barplot
                                , SR_Inside_LogRegr = SR_InCase_LogRegr
                                , SR_Inside_LinRegr = SR_InCase_LinRegr
                                , SR_Outside_LinRegr = SR_OutCase_LinRegr
                                , VP_SensitiveTaxa = VP_boxplot_senstaxa
                                , VP_TolerantTaxa = VP_boxplot_toltaxa)
        df_det <- dplyr::mutate(df_det, MMIhybrid = round(MMIhybrid,3)
                                , PercentRank = round(PercentRank, 3)
                                , StressorValue = ifelse(StressorValue<1
                                                         , format(StressorValue
                                                                 , digits=3)
                                                  , ifelse(StressorValue<10
                                                         , format(StressorValue
                                                                 , digits=2)
                                                  , ifelse(StressorValue<100
                                                         , format(StressorValue
                                                                 , digits=1
                                                                 , scientific=FALSE)
                                                         , format(StressorValue
                                                                 , digits=0
                                                                 , big.mark=",")))))
        df_det <- dplyr::select(df_det, Degraded, Narrative, MMIhybrid, ResponseSampleDate
                                , ResponseSampleID, StressorSampleDate
                                , StressorSampleID, Group, Stressor, StressorValue
                                , PercentRank, WoE, TS_Inside, CO_boxplot
                                , SR_Inside_LogRegr, SR_Inside_LinRegr
                                , SR_Outside_LinRegr, VP_SensitiveTaxa
                                , VP_TolerantTaxa, SSD_ToxicityCurve, TotSupport
                                , TotRefute, TotIndet, TotNotEval)
        df_det <- dplyr::arrange(df_det, desc(Degraded), desc(MMIhybrid), StressorSampleDate
                                , ResponseSampleID, StressorSampleID, Group
                                , Stressor, StressorValue)
    
        Detcaption <- paste0("Scores for each line of evidence equal 1 (supports), "
                             , "-1 (refutes), 0 (indeterminate), or NE (not evaluated).")
        knitr::kable(df_det, format=report_format, colnames=colnames(df_det)
                     , caption = Detcaption, align='llcclclllrrlcccccccccccc') %>%
            kableExtra::kable_styling(bootstrap_options = "condensed"
                                      , font_size = 12) %>%
            kableExtra::column_spec(1,bold = TRUE) %>%
            kableExtra::collapse_rows(columns=1:8, valign="top")
    } else {
      cat(txt_NoFile)
    }

} else {
    cat(paste0("No algae data are available for ", TargetSiteID,".\n"))
}

```

# **DATA GAPS**
```{r datagaps}
dir_gaps <- file.path(dir_results, TargetSiteID)
fn_gaps <- file.path(dir_gaps, paste0(TargetSiteID,"_datagaps.tab"))
df_gaps <- read.delim(fn_gaps, header = TRUE, sep = "\t")

dfgen <- dplyr::filter(df_gaps, fxnname=="general")
dfpairs <- dplyr::filter(df_gaps, fxnname=="getCoOccurDataset")
dfoutliers <- dplyr::filter(df_gaps, fxnname=="Comparator outliers")
dflimitdata <- dplyr::filter(df_gaps, fxnname=="getStressorList")

if(any(dfpairs$result==0)) {
    nopairs <- dfpairs %>%
        dplyr::filter(result==0) %>%
        dplyr::select(comment)
    nopairs <- unique(as.vector(nopairs))
    for (sr in 1:length(nopairs)) {
        tempmsg <- nopairs[sr]
        if (sr==1) {
            msgNoPairs <- tempmsg
        } else {
            msgNoPairs <- c(msgNoPairs, tempmsg)
        }
    }
    rm(tempmsg)
    msgNoPairs <- as.character(msgNoPairs$comment)
    cat(msgNoPairs)
}


if (any(dfgen$result==0)) {
    nodatacond <- dfgen %>%
        dplyr::filter(result==0) %>%
        dplyr::select(condition)
    nodatacond <- unique(as.vector(nodatacond$condition))
    
    for (c in 1:length(nodatacond)) {
        
        cond <- nodatacond[c]
        tempmsg <- switch(cond
                          , "ChemStress"=paste0("No laboratory or field chemistry "
                                                , "data are available for "
                                                , TargetSiteID)
                          , "HabStress"=paste0("No physical habitat data are "
                                               ,"available for ", TargetSiteID)
                          , "useModStress"=paste0("No modeled flow data are "
                                                  ,"available for ", TargetSiteID)
                          , "useBMI"=paste0("No benthic macroinvertebrate response "
                                            , "data are available for ", TargetSiteID)
                          , "useALG"=paste0("No algal community response data "
                                            , "are available for ", TargetSiteID))
        
        if (c==1) {
            msgnodata <- tempmsg
        } else {
            msgnodata <- c(msgnodata, tempmsg)
        }
    
    }
    
    msgnodata <- as.data.frame(msgnodata)
    
    nodatacaption <- "Missing stressor or response data"
    knitr::kable(msgnodata, format=report_format, caption = nodatacaption
                 , col.names = "Data type") %>%
        kableExtra::kable_styling(bootstrap_options="condensed", font_size=12)

} else {
    
    msgnodata <- paste0("All stressor and response data types are available for "
                        , TargetSiteID, ".\n\n")
    cat(msgnodata)
    
}

if (nrow(dflimitdata)>0) {
    limdatacaption <- paste0("Limited data were available from comparator "
                             , "samples for the following stressors identified at "
                             , TargetSiteID, ". No evaluation is possible.")
    
    dflimitdata <- dflimitdata %>%
        dplyr::select(condition, result, comment) %>%
        dplyr::rename(Stressor = condition
                      , NumberPairedSamples = result
                      , Finding = comment)
    dflimitdata <- unique(as.data.frame(dflimitdata, row.names = NULL))

    knitr::kable(dflimitdata, format=report_format, caption = limdatacaption
                 , col.names = colnames(dflimitdata)) %>%
        kableExtra::kable_styling(bootstrap_options = "condensed", font_size = 12)

}

if (nrow(dfoutliers)>0) {
    
    dfoutliers <- dplyr::select(dfoutliers, -fxnname)
    dfoutliers$ComparatorSiteID <- stringr::str_extract(dfoutliers$comment
                                                        , "^[A-Z0-9]*")
    dfoutliers <- unique(as.data.frame(dfoutliers, row.names = NULL)) %>% 
        dplyr::rename(Stressor = condition, StressorValue = result) %>%
        dplyr::select(ComparatorSiteID, Stressor, StressorValue) %>%
        dplyr::arrange(ComparatorSiteID, Stressor)
    # dfoutliers <- unique(as.data.frame(dfoutliers, row.names = NULL))
    outcaption <- paste0("Comparator site outliers that were removed. "
                         , "Values were transformed prior to evaluating "
                         , "for outliers as necessary.")

    knitr::kable(dfoutliers, format=report_format, caption = outcaption
                 , col.names = colnames(dfoutliers)) %>%
        kableExtra::kable_styling(bootstrap_options = "condensed", font_size = 12)

} else {
    
    msgnooutliers <- "No outliers were identified among the comparator samples.\n\n"
    cat(msgnooutliers)
    
}


```




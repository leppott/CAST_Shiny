---
title: "Disclaimer and Plot Key"
#subtitle: "CAST"
#author: "`r Sys.getenv('USERNAME')`"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(results='asis', echo=FALSE, warning=FALSE)
#TargetSiteID <- "SRCKN001.61"
# dir_results <- "C:\\Users\\Erik.Leppo\\OneDrive - Tetra Tech, Inc\\MyDocs_OneDrive\\GitHub\\CASTfxn\\Results"
#~~~~~~~~~~~~~~~~~
# in global.R
dir_legends <- file.path(".", "Legends")
#~~~~~~~~~~~~~~~~~
# from getSiteInfo()
# data.Stations.Info
# data.cluster       <- data_Cluster_Hi
# col.clust.land.no <- "clust_noland"
# col.clust.land.yes <- "clust_land"
# all.map.sites <- merge(data.Stations.Info, data.cluster, by.x = "COMID_NHD2", by.y = "COMID")
#~~~~~~~~~~~~~~

# Legend Global Variables

## Plot, Variables, Colors
col_outline       <- "black"
col_flowline      <- "light blue"
col_sites_all     <- "dark gray"
col_sites_all_ref <- "blue"
col_sites_cl      <- "cyan3"
col_sites_cl_ref  <- col_sites_all_ref
col_sites_ref     <- "blue"
col_sites_targ    <- "red"
col_outliers      <- "black"
col_line          <- "black"

## Plot, Variables, Fill
fill_sites_all     <- col_sites_all
fill_sites_all_ref <- fill_sites_all
fill_sites_cl      <- col_sites_cl
fill_sites_cl_ref  <- fill_sites_cl 
fill_sites_targ    <- col_sites_targ
    
## Plot, Variables, Points    
pch_sites_all     <- 19 # solid circle
pch_sites_all_ref <- 21 # circle outline
pch_sites_cl      <- 19
pch_sites_cl_ref  <- pch_sites_all_ref
pch_sites_ref     <- 21 # circle outline 
pch_sites_targ    <- 17 # triangle
pch_outliers      <- 19

## Plot, Variables, Sizes
cex_mod           <- 1.5
cex_sites_all     <- 0.3 *2
cex_sites_all_ref <- cex_sites_all
cex_sites_ref     <- 0.9
cex_sites_cl      <- 1
cex_sites_cl_ref  <- cex_sites_cl
cex_sites_targ    <- 1.2
cex_outliers      <- 1

## Plot, Variables, Lines
lwd_outline    <- 1.5
lwd_flowline   <- 0.5
```

# Disclaimer
Text here about how this is a "tool" and also for "screening".  Meant to be used by a subject matter expert.  


# Plot Legend Key
The various plots generated by the tool are shown below with a description of the major points.


Legend for various plots generated by the tool.

## Box Plots, General
Box plots are used in many of the graphical representations of the data.  Below is the USGS standard key for box plots (https://owi.usgs.gov/blog/boxplots/).

Some box plots are rotated 90 degrees to allow for more values to be included on the plot.

Some box plots include additional points that are color coded.  These points are placed on the plot to show the distribution of select groups; e.g., reference, cluster, sites with better biological scores, target site, etc. The points are placed using the "jitter" command.  The jittering adds a small amount of random variation (x and y) to the location of the points so they are easier to visualize.  Thus the points should not be considered as exact locations and will be different each time the plots are generated.

```{r Leg_Box, echo=FALSE, eval=TRUE}
# USGS box plot legend
# https://github.com/usgs/wdfn-blog/blob/master/content/boxplot_defs.Rmd
# https://owi.usgs.gov/blog/boxplots/

library(ggplot2)
ggplot_box_legend <- function(family = "serif"){
  
  # Create data to use in the boxplot legend:
  set.seed(100)

  sample_df <- data.frame(parameter = "test",
                        values = sample(500))

  # Extend the top whisker a bit:
  sample_df$values[1:100] <- 701:800
  # Make sure there's only 1 lower outlier:
  sample_df$values[1] <- -350
  
  # Function to calculate important values:
  ggplot2_boxplot <- function(x){
  
    quartiles <- as.numeric(quantile(x, 
                                     probs = c(0.25, 0.5, 0.75)))
    
    names(quartiles) <- c("25th percentile", 
                          "50th percentile\n(median)",
                          "75th percentile")
    
    IQR <- diff(quartiles[c(1,3)])
  
    upper_whisker <- max(x[x < (quartiles[3] + 1.5 * IQR)])
    lower_whisker <- min(x[x > (quartiles[1] - 1.5 * IQR)])
      
    upper_dots <- x[x > (quartiles[3] + 1.5*IQR)]
    lower_dots <- x[x < (quartiles[1] - 1.5*IQR)]
  
    return(list("quartiles" = quartiles,
                "25th percentile" = as.numeric(quartiles[1]),
                "50th percentile\n(median)" = as.numeric(quartiles[2]),
                "75th percentile" = as.numeric(quartiles[3]),
                "IQR" = IQR,
                "upper_whisker" = upper_whisker,
                "lower_whisker" = lower_whisker,
                "upper_dots" = upper_dots,
                "lower_dots" = lower_dots))
  }
  
  # Get those values:
  ggplot_output <- ggplot2_boxplot(sample_df$values)
  
  # Lots of text in the legend, make it smaller and consistent font:
  update_geom_defaults("text", 
                     list(size = 3, 
                          hjust = 0,
                          family = family))
  # Labels don't inherit text:
  update_geom_defaults("label", 
                     list(size = 3, 
                          hjust = 0,
                          family = family))
  
  # Create the legend:
  # The main elements of the plot (the boxplot, error bars, and count)
  # are the easy part.
  # The text describing each of those takes a lot of fiddling to
  # get the location and style just right:
  explain_plot <- ggplot() +
    stat_boxplot(data = sample_df,
                 aes(x = parameter, y=values),
                 geom ='errorbar', width = 0.3) +
    geom_boxplot(data = sample_df,
                 aes(x = parameter, y=values), 
                 width = 0.3, fill = "lightgrey") +
    geom_text(aes(x = 1, y = 950, label = "500"), hjust = 0.5) +
    geom_text(aes(x = 1.17, y = 950,
                  label = "Number of values"),
              fontface = "bold", vjust = 0.4) +
    theme_minimal(base_size = 5, base_family = family) +
    geom_segment(aes(x = 2.3, xend = 2.3, 
                     y = ggplot_output[["25th percentile"]], 
                     yend = ggplot_output[["75th percentile"]])) +
    geom_segment(aes(x = 1.2, xend = 2.3, 
                     y = ggplot_output[["25th percentile"]], 
                     yend = ggplot_output[["25th percentile"]])) +
    geom_segment(aes(x = 1.2, xend = 2.3, 
                     y = ggplot_output[["75th percentile"]], 
                     yend = ggplot_output[["75th percentile"]])) +
    geom_text(aes(x = 2.4, y = ggplot_output[["50th percentile\n(median)"]]), 
              label = "Interquartile\nrange", fontface = "bold",
              vjust = 0.4) +
    geom_text(aes(x = c(1.17,1.17), 
                  y = c(ggplot_output[["upper_whisker"]],
                        ggplot_output[["lower_whisker"]]), 
                  label = c("Largest value within 1.5 times\ninterquartile range above\n75th percentile",
                            "Smallest value within 1.5 times\ninterquartile range below\n25th percentile")),
                  fontface = "bold", vjust = 0.9) +
    geom_text(aes(x = c(1.17), 
                  y =  ggplot_output[["lower_dots"]], 
                  label = "Outside value"), 
              vjust = 0.5, fontface = "bold") +
    geom_text(aes(x = c(1.9), 
                  y =  ggplot_output[["lower_dots"]], 
                  label = "-Value is >1.5 times and"), 
              vjust = 0.5) +
    geom_text(aes(x = 1.17, 
                  y = ggplot_output[["lower_dots"]], 
                  label = "<3 times the interquartile range\nbeyond either end of the box"), 
              vjust = 1.5) +
    geom_label(aes(x = 1.17, y = ggplot_output[["quartiles"]], 
                  label = names(ggplot_output[["quartiles"]])),
              vjust = c(0.4,0.85,0.4), 
              fill = "white", label.size = 0) +
    ylab("") + xlab("") +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank(),
          panel.grid = element_blank(),
          aspect.ratio = 4/3,
          plot.title = element_text(hjust = 0.5, size = 10)) +
    coord_cartesian(xlim = c(1.4,3.1), ylim = c(-600, 900)) +
    labs(title = "EXPLANATION")

  return(explain_plot) 
  
}

ggplot_box_legend()
```

## Site Info

### Map, Static
The static map is all sites in entire region of interest alont with NHD+ flowlines.

```{r Map_Static}
str_cat <- "static map"
dir.sub3 <- "SiteInfo"
TargetSiteID <- "403S01784"
fn_img <- file.path(dir_legends, dir.sub3, paste0(TargetSiteID,"_map.jpg"))
if(file.exists(fn_img)==TRUE){
  knitr::include_graphics(fn_img)
} else {
  print(paste0("No file exists; ", str_cat))
}
#~~~~~~~~~~~~~~~~

# Key

# https://stackoverflow.com/questions/48966645/how-can-i-create-a-legend-without-a-plot-in-r

## Plot, Variables, Text
txt_outline    <- "Outline of SMC region"
txt_flowline   <- "NHD+ flow line"
txt_sites_all  <- "All sites"
txt_sites_cl   <- "Sites in the the same cluster as Target site"
txt_sites_ref  <- "All reference sites (is a border around points)"
txt_sites_targ <- "Target site"

leg_name <- "Legend"
leg_labels <- c(txt_outline, txt_flowline, txt_sites_all, txt_sites_cl, txt_sites_ref, txt_sites_targ)
leg_shape  <- c(NA, NA, pch_sites_all, pch_sites_cl, pch_sites_ref, pch_sites_targ)
leg_size   <- cex_mod * c(NA, NA, cex_sites_all, cex_sites_ref, cex_sites_cl, cex_sites_targ)
leg_line   <- c(1, 1, rep(NA, 4))
leg_col    <- c(col_outline, col_flowline, col_sites_all, col_sites_cl, col_sites_ref, col_sites_targ)
#leg_fill   <- c(fill_sites_all_ref, fill_sites_targ)

plot(NULL, xaxt = "n", yaxt="n", bty="n", xlab="", ylab="", xlim=0:1, ylim=0:1)
legend("topleft"
       , legend = leg_labels
       , pch = leg_shape
       , pt.cex = leg_size
       , lty = leg_line
       , col = leg_col
       , cex = 1.5
       , bty = "n"
       #, title = ""
       )
mtext(leg_name, at=0.05, cex = 2)
```

### Map, Interactive
The interactive map behaves much like Google Earth.

The points have the same color coding as the static map.

```{r Map_Leaflet}
str_cat <- "interactive map"
dir.sub3 <- "SiteInfo"
TargetSiteID <- "403S01784"
fn_img <- file.path(dir_legends, dir.sub3, paste0(TargetSiteID, "_map_leaflet.png"))
if(file.exists(fn_img)==TRUE){
  knitr::include_graphics(fn_img)
} else {
  print(paste0("No file exists; ", str_cat))
  #print(paste0("\n", fn_img))
}
```

### Potential Anthropogenic Alteration Plots
Bar plots for target site with metrics from StreamCat.  Most plots have panels or facets that subdivide the data into categories. The numbers above the bars is the value of the bar.

The color of the bars is a shade of red to associated it with the "target" site.

```{r PotAnthAlt}
str_cat <- "potential anthropogenic alterations"
dir.sub3 <- "SiteInfo"
TargetSiteID <- "403S01784"
fn_img <- file.path(dir_legends, dir.sub3, paste0(TargetSiteID, "_bkgd_RoadDensity.png"))
if(file.exists(fn_img)==TRUE){
  knitr::include_graphics(fn_img)
} else {
  print(paste0("No file exists; ", str_cat))
  # print(paste0("\n", fn_img))
}
```

## Candidate Causes
Box plots by stressor category.

```{r CandCaus}
str_cat <- "candidate causes"
dir.sub3 <- "CandidateCauses"
TargetSiteID <- "403S01784"
fn_img <- file.path(dir_legends, dir.sub3, paste0(TargetSiteID, ".boxes.Water.quality.jpg"))
if(file.exists(fn_img)==TRUE){
  knitr::include_graphics(fn_img)
} else {
  print(paste0("No file exists; ", str_cat))
  # print(paste0("\n", fn_img))
}
#~~~~~~~~~~~~~~~~

# Key

## Plot, Variables, Text
txt_outline    <- "Outline of SMC region"
txt_flowline   <- "NHD+ flow line"
txt_sites_all  <- "All sites"
txt_sites_ref  <- "Non degraded sites (a border around points)"
txt_sites_targ <- "Target site"
txt_outliers   <- "box plot outliers"

## Plot, Variables, Legend
leg_name <- "Legend"
leg_labels <- c(txt_outliers, txt_sites_ref, txt_sites_targ)
leg_shape  <- c(pch_outliers, 21, pch_sites_targ)
leg_size   <- cex_mod * c(cex_outliers, cex_sites_ref, cex_sites_cl, cex_sites_targ)
leg_col    <- c(col_outliers, "cyan3", col_sites_targ)
leg_fill   <- c(col_outliers, "blue", col_sites_targ)
#leg_fill   <- c(fill_sites_all_ref, fill_sites_targ)

plot(NULL, xaxt = "n", yaxt="n", bty="n", xlab="", ylab="", xlim=0:1, ylim=0:1)
legend("topleft"
       , legend = leg_labels
       , pch = leg_shape
       , pt.cex = leg_size
       , col = leg_fill
       , pt.bg = leg_col
       , cex = 1.5
       , bty = "n"
       #, title = ""
       )
mtext(leg_name, at=0.05, cex = 2)
```


## CoOccurrence

Box plot and Stressor Response

```{r CO_box}
str_cat <- "co-occurrence, box plot"
dir.sub3 <- "CoOccurrence"
TargetSiteID <- "403S01784"
fn_img <- file.path(dir_legends, dir.sub3
                    , paste0(TargetSiteID, ".CoOccurrence.Box.SpecificConductivity_fld_uS_cm.jpg"))
if(file.exists(fn_img)==TRUE){
  knitr::include_graphics(fn_img)
} else {
  print(paste0("No file exists; ", str_cat))
  # print(paste0("\n", fn_img))
}
#~~~~~~~~~~~~~~~~

# Key

## Plot, Variables, Text
txt_outline    <- "Outline of SMC region"
txt_flowline   <- "NHD+ flow line"
txt_sites_all  <- "All sites"
txt_sites_ref  <- "Non degraded sites (a border around points)"
txt_sites_targ <- "Target site"
txt_outliers   <- "box plot outliers"

## Plot, Variables, Legend
leg_name <- "Legend"
leg_labels <- c(txt_outliers, "Bio.Deg Yes", "Bio.Deg No", "Target site", "Scoring boundaries")
leg_shape  <- c(pch_outliers, 21, pch_sites_targ, 19, NA, NA)
leg_size   <- cex_mod * c(cex_outliers, cex_sites_ref, cex_sites_cl, cex_sites_targ)
leg_col    <- c(col_outliers, "cyan3", col_sites_targ)
leg_fill   <- c(col_outliers, "blue", col_sites_targ)
#leg_fill   <- c(fill_sites_all_ref, fill_sites_targ)

plot(NULL, xaxt = "n", yaxt="n", bty="n", xlab="", ylab="", xlim=0:1, ylim=0:1)
legend("topleft"
       , legend = leg_labels
       , pch = leg_shape
       , pt.cex = leg_size
       , col = leg_fill
       , pt.bg = leg_col
       , lty = c(NA, NA, NA, 1, 1)
       , cex = 1.5
       , bty = "n"
       #, title = ""
       )
mtext(leg_name, at=0.05, cex = 2)
```

Red line = target site

points are cluster sites marked as biologically degraded Yes/No.

Biologically Degraded = No are the "better" sites.

N and score in text at the bottom.


```{r CO_SR}
str_cat <- "co-occurrence, stressor response"
dir.sub3 <- "CoOccurrence"
TargetSiteID <- "403S01784"
fn_img <- file.path(dir_legends, dir.sub3
                    , paste0(TargetSiteID, ".CoOccurrence.SR.SpecificConductivity_fld_uS_cm.jpg"))
if(file.exists(fn_img)==TRUE){
  knitr::include_graphics(fn_img)
} else {
  print(paste0("No file exists; ", str_cat))
  # print(paste0("\n", fn_img))
}
```

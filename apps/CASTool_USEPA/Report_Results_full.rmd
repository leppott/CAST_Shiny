---
title: "CASTool"
subtitle: "Full Report"
pagetitle: "`r paste0('CASTool Report: ', TargetSiteID)`"
author: "`r Sys.getenv('USERNAME')`"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  pdf_document:
    toc: true
  word_document:
    toc: yes
  html_document:
    toc: yes
    toc_depth: 4
    toc_float: yes
editor_options: 
  markdown: 
    wrap: 72
---

<!-- #  Copyright 2025 TetraTech. All rights reserved. -->

<!-- #  Use, copying, modification, or distribution of this file or any of its contents  -->

<!-- #  is expressly prohibited without prior written permission of TetraTech. -->

<!-- # Embed logo -->

<img src="CASTool.svg" style="position:absolute; top:0px; right:0px; padding:10px;"/>

<!-- # Add css for vertical alignment of table header cells -->

<head>

```{=html}
<style type="text/css">
    <!-- .dt-left {horizontal-align: left;} -->
    <!-- .dt-center {horizontal-align: center;} -->
    <!-- .dt-right {horizontal- align: right;} -->
    .dt-top {vertical-align: top;}
    .dt-middle {vertical-align: middle;}
    .dt-bottom {vertical-align: bottom;}
  </style>
```

</head>

```{r setup, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(results = 'asis', echo = FALSE, warning = FALSE)

# Define pipe and not_all_na
`%>%` <- dplyr::`%>%`
not_all_na <- function(x) {!all(is.na(x))}

```

# **DISCLAIMER**

The Causal Assessment Screening Tool (CASTool) is designed to assess
causes of biological impairment. CASTool is a data-driven tool that
relies on the quality and completeness of the biological response and
candidate stressor data provided by the user. It is most appropriately
used to identify candidate causes which merit additional evaluation. The
conceptual framework for the CASTool is the U.S. Environmental
Protection Agencyâ€™s Causal Analysis/Diagnosis Decision Information
System (CADDIS), which can be consulted for additional information on
causal assessment.

# **Target Site: `r TargetSiteID`**
## **Region: `r regionName`**

## **Parameterization**

```{r report_date, echo = FALSE}

  biocomms <- tolower(biocommlist)
  if (length(biocommlist) > 1) {
    biocomms <- toString(biocommlist[1:length(biocommlist) - 1])
    biocomms <- paste(biocomms, biocommlist[length(biocommlist)],
                      sep = " and ")
  }
  biocomms <- sub("bmi", "benthic macroinvertebrates", biocomms)
  biocomms <- sub("alg", "algae", biocomms)
  
  lagdays <- paste(lagdays, collapse = ", ")

  cat(paste("**Biological communities evaluated:** ", biocomms, "\n\n", sep = ""))
  cat(paste("**Remove outliers:** ", removeOutliers, "\n\n", sep = ""))
  cat(paste("**Use expected biological similarity filter:** ", useBC, "\n\n", sep = ""))
  cat(paste("**Minimum number of samples to identify candidate causes:** ", samplim, 
            "\n\n", sep = ""))
  cat(paste("**Number of allowable lag days between stressor and response measurements:** -",
            lagdays, "\n\n", sep = ""))
  cat(paste("**R2 cutoff:** ", r2_cutoff, "\n\n", sep = ""))
  cat(paste("**p-value cutoff:** ", p.val_cutoff, "\n\n", sep = ""))
  # cat(paste("**Cluster assignment file:** ", basename(fn.cluster), "\n", sep = ""))

```

## **Target site information**

### *Site map*

```{r map, out.width = "80%", echo = FALSE}

dir.sub <- "SiteInfo"
myMAP <- paste0(TargetSiteID,"_map.png")
fn_img <- file.path(dir_results, TargetSiteID, dir.sub, myMAP)

if (file.exists(fn_img) == TRUE) {
  knitr::include_graphics(fn_img)
} else {
  cat("No file exists; map.\n")
}

```

```{r photos, out.width = "50%", echo = FALSE}

header_name <- "<h3><em>Site photo(s)</em></h3>"

dir.sub <- "SiteInfo"
dir_SiteID <- file.path(dir_results, TargetSiteID, dir.sub, "Photos")
fn_all  <- list.files(path = dir_SiteID, full.names = TRUE,
                      pattern = ".jpg|.png|.mp4")

txt_grp_msg <- "media"
#
if (length(fn_all) > 0) {##IF.Media

  cat(header_name)
  
  msg_files <- paste0("All media ", txt_grp_msg," files are in the '",
                      paste0("Results/", TargetSiteID, "/", dir.sub, "/Photos"), 
                      "' folder.\n", "Static photos are shown here.\n\n")
  cat(msg_files)
  
  fn_Photos_jpg <- fn_all[grep("[.jpg|.png]", fn_all)]
  
  for (p in seq_along(fn_Photos_jpg)) {
    fn <- fn_Photos_jpg[p]
    cat(paste0("<img src = ", fn, " />"))
  }
  
} else {

  cat(header_name)
  
  msg_files <- paste0("No ", txt_grp_msg," files exist.\n")
  cat(msg_files)
  
}##IF.Media.END

```

### *Target site sample summary*

The table below lists any samples collected from `r TargetSiteID` over
time. Index scores are followed by their biological quality for benthic
macroinvertebrates (`r ifelse(!is.null(bmiIndex), bmiIndex, "N/A")`),
algae (`r ifelse(!is.null(algIndex), algIndex, "N/A")`), or fish
(`r ifelse(!is.null(fishIndex), fishIndex, "N/A")`).

```{r sampsummary, echo = FALSE}

# Read file summarizing the sample data and provide it in summary form
dfSamps <- data_sampSummary[data_sampSummary$StationID == TargetSiteID, ]
TScomid <- unique(dfSamps$COMID)
TScluster <- ifelse(useBC == TRUE, 
                    unique(dfSamps$OutcaseCol), 
                    unique(dfSamps$IncaseCol))

row.names(dfSamps) <- NULL

camelCaseToTitleCase <- function(camelCaseString) {
  # Insert spaces before uppercase letters (except the first character)
  tempString <- gsub("([A-Z])", " \\1", camelCaseString)
  
  # Capitalize the first letter of each word and convert the rest to lowercase
  # This handles the case where the original string starts with an uppercase
  # letter and ensures subsequent words are correctly capitalized.
  titleCaseString <- tools::toTitleCase(tempString)
  
  # Remove any leading spaces that might have been introduced if the original
  # string started with an uppercase letter
  titleCaseString <- trimws(titleCaseString)
  
  # Join "I D" to recreate "ID"
  titleCaseString <- sub("(I D)", "ID", titleCaseString)
  
  # Join "B M I" to recreate "BMI"
  titleCaseString <- sub("(B M I)", "BMI", titleCaseString)
  
  return(titleCaseString)
}

# Get sample data
if (nrow(dfSamps) > 0) {# Samples exist for target site
  
  dfSamps <- dplyr::select(dfSamps, !c(StationID, COMID, OutcaseCol, IncaseCol)) %>%
    tidyr::pivot_longer(cols = -SampleDate, names_to = "ColName", values_to = "Content") %>%
    dplyr::mutate(ColName = camelCaseToTitleCase(ColName)) %>%
    tidyr::pivot_wider(id_cols = SampleDate, names_from = ColName, values_from = Content)
  
  # Get response data
  if (!is.null(data_bmiMetrics)) {
    origcol <- which(colnames(dfSamps) == "BMI Sample ID")
    dfbmi <- dplyr::filter(data_bmiMetrics, StationID == TargetSiteID) %>%
      dplyr::select(RespSampleID, all_of(bmiIndex), Quality)
    dfSamps <- merge(dfSamps, dfbmi, by.x = "BMI Sample ID", by.y = "RespSampleID",
                     all.x = TRUE)
    dfSamps <- dplyr::rename(dfSamps, `BMI Quality` = Quality)
    dfSamps <- dfSamps[, c(2:(origcol), 1, (origcol + 1):ncol(dfSamps))]
  }
  if (!is.null(data_algMetrics)) {
    origcol <- which(colnames(dfSamps) == "Alg Sample ID")
    dfalg <- dplyr::filter(data_algMetrics, StationID == TargetSiteID) %>%
      dplyr::select(RespSampleID, all_of(algIndex), Quality)
    dfSamps <- merge(dfSamps, dfalg, by.x = "Alg Sample ID", by.y = "RespSampleID",
                     all.x = TRUE)
    dfSamps <- dplyr::rename(dfSamps, `Algae Quality` = Quality)
    dfSamps <- dfSamps[, c(2:(origcol), 1, (origcol + 1):ncol(dfSamps))]
  }
  if (!is.null(data_fishMetrics)) {
    origcol <- which(colnames(dfSamps) == "Fish Sample ID")
    dffish <- dplyr::filter(data_fishMetrics, StationID == TargetSiteID) %>%
      dplyr::select(RespSampleID, all_of(fishIndex), Quality)
    dfSamps <- merge(dfSamps, dffish, by.x = "Fish Sample ID", by.y = "RespSampleID",
                     all.x = TRUE)
    dfSamps <- dplyr::rename(dfSamps, `Fish Quality` = Quality)
    dfSamps <- dfSamps[, c(2:(origcol), 1, (origcol + 1):ncol(dfSamps))]
  }
  
  tblColNames <- colnames(dfSamps)
  
  if (report_format == "html") {
    
    tblCaption <- paste0("Samples collected from ", TargetSiteID,".")

    DT::datatable(dfSamps,
                  extensions = 'FixedColumns',
                  # caption = tblCaption,
                  options = list(layout = list(top1 = list(id = 'cellID',
                                                          className = 'cellClass',
                                                          features = list(
                                                            # div = list(
                                                              text = tblCaption)
                                                            # )
                                                          ),
                                               topStart = 'pageLength',
                                               topEnd = 'search',
                                               bottomStart = 'info',
                                               bottomEnd = 'paging'),
                                 pageLength = 10,
                                 menu = ifelse(nrow(dfSamps) > 10,
                                               c(10, 25, 50, 100), 10),
                                 bSort = FALSE,
                                 scrollX = TRUE,
                                 fixedColumns = TRUE,
                                 columnDefs = list(list(className = 'dt-center',
                                                        targets = '_all'),
                                                   list(className = 'dt-bottom',
                                                        targets = '_all'))),
                  colnames = tblColNames,
                  class = 'striped hover row-border',
                  filter = 'none',
                  rownames = FALSE) %>%
      DT::formatStyle(columns = colnames(dfSamps), fontSize = '85%') 
    
  } else {
    
    msg <- "Not displayed in non-html format."
    cat(msg)
    
  }

} else {
  
  cat(paste0("No sample data for ", TargetSiteID))
  
}

```

### *Comparator sites*

Comparator sites will depend upon several factors:

-   which version of the regional clustering file is used
-   whether or not an alternate method is used to assign comparator
    sites
-   whether or not a Bray-Curtis dissimilarity distance matrix is
    included in the evaluation

Comparator samples have a quality associated with them, that differs
based on the biological community index used. For these, please see the
biological community comparator samples section.

```{r cluster_fig, echo=FALSE, results='asis', fig.align='center', out.width="80%", fig.cap=caps}
# replicate then modify code from Setup tab (display_images_StressSumm.Rmd)

# includes caption (set in chunk header)
# images 80% (set in chunk header)

img_dir <- file.path(
  dir_results, # from render call (includes region), dn_results in global 
  dn_checked_sk # from global
)

fn_png <- "cluster_graphic.png"

# output image with caption (set in chunk header)
knitr::include_graphics(normalizePath(file.path(img_dir, fn_png)))
caps = "Abiotic clustering."
```

### *Watershed stressor summaries*

The downloadable zip file contains figures summarizing watershed
attributes of the target site compared to all reaches inside the case.
These figures may provide additional insight into causes of stream
impairment. For example, if nitrogen species were not measured and
provided to the CASTool, a relatively high agricultural surplus of nitrogen may indicate that
nitrogen pollution merits additional scrutiny as a potential candidate
cause of impairment.The variables for which the targe site value exceeded the median 
of comparator sites are outlined below. 

```{r ws stressor, echo = FALSE}
if(boo.WS == TRUE){
  fn_WSStressorSum <- file.path(dir_results, TargetSiteID, "SiteInfo", paste0(TargetSiteID, "WSStressHigh.csv"))

WSStressorSum <- read.csv(fn_WSStressorSum) %>% 
  dplyr::mutate(Comparator.Median = round(Comparator.Median, 3), Target.Site.Value = round(Target.Site.Value, 3)) %>% 
  dplyr::rename("Watershed Stressor" = "Watershed.Stressor",
                "Comparator Median" = "Comparator.Median",
                "Target Site Value" = "Target.Site.Value")

tblCaption <- paste0("Target site", TargetSiteID," reach watershed stressors greater than median of comparator reaches")
 
tblColNames <- colnames(WSStressorSum)

 DT::datatable(WSStressorSum,
               extensions = 'FixedColumns',
               # caption = tblCaption,
               options = list(layout = list(top1 = list(id = 'cellID',
                                                        className = 'cellClass',
                                                        features = list(
                                                          # div = list(
                                                          text = tblCaption)
                                                        # )
                                                        ),
                                            topStart = 'pageLength',
                                            topEnd = 'search',
                                            bottomStart = 'info',
                                            bottomEnd = 'paging'),
                              pageLength = 10,
                              menu = ifelse(nrow(WSStressorSum) > 10,
                                            c(10, 25, 50, 100), 10),
                              bSort = TRUE,
                              scrollX = TRUE,
                              fixedColumns = TRUE,
                              columnDefs = list(list(className = 'dt-center',
                                                     targets = '_all'),
                                                list(className = 'dt-bottom',
                                                     targets = '_all'))),
               colnames = tblColNames,
               class = 'striped hover row-border',
               filter = 'none',
               rownames = FALSE) %>%
   DT::formatStyle(columns = colnames(WSStressorSum), fontSize = '85%')
} else{
  cat("Watershed stressor analyses not requested or data not provided.")
}

```

``` {r BMIresults, child=if ("bmi" %in% biocommlist) 'BMI.rmd'}
```

``` {r ALGresults, child=if ("alg" %in% biocommlist) 'ALG.rmd'}
```

``` {r FISHresults, child=if ("fish" %in% biocommlist) 'FISH.rmd'}
```

---
title: "Summary Report"
subtitle: "CASTool"
author: "`r Sys.getenv('USERNAME')`"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
  word_document:
    toc: yes
  pdf_document:
    toc: true
---

<!-- #  Copyright 2020 TetraTech. All rights reserved. -->
<!-- #  Use, copying, modification, or distribution of this file or any of its contents  -->
<!-- #  is expressly prohibited without prior written permission of TetraTech. -->

<!-- # Embed logo -->
<img src="CASTool.svg" style="position:absolute; top:0px; right:0px; padding:10px;" />

```{r setup, include = FALSE}
knitr::opts_chunk$set(results = 'asis', echo = FALSE, warning = FALSE)
# Debugging
boo.DEBUG <- FALSE
DEBUG.CaseNumber <- 4
#
# Define pipe
`%>%` <- dplyr::`%>%`

if (algIndex == "MMIhybrid") { algIndexTxt <- "MMI Hybrid"}
#
if (boo.DEBUG == TRUE) {##IF.boo.DEBUG.START
  if (DEBUG.CaseNumber == 1) {##IF.DEBUG.CaseNumber.START
    TargetSiteID <- "SMC01049"
    dir_results <- "C:/Users/ann.lincoln/Documents/SEP_CAST/Results"
    probsHigh <- 0.75
    probsLow <- 0.25
    report_format = "html"
  } else if (DEBUG.CaseNumber == 2) {
    TargetSiteID <- "907S02774"
    dir_results <- "C:/Users/ann.lincoln/Documents/SEP_CAST/Results"
  } else if (DEBUG.CaseNumber == 3) {
    TargetSiteID <- "403S01272"
    dir_results <- "C:/Users/ann.lincoln/Documents/SEP_CAST/Results"
  } else if (DEBUG.CaseNumber == 4) {
    TargetSiteID <- "SMC00710"
    dir_data <- "C:/Users/ann.lincoln/Documents/SEP_CAST/Data"
    dir_results <- "C:/Users/ann.lincoln/Documents/SEP_CAST/Results"
    probsHigh <- 0.75
    probsLow <- 0.25
    useAlg <- TRUE
    useBMI <- TRUE
    report_format = "html"
    removeOutliers <- TRUE
    useBC <- TRUE # Use Bray-Curtis biological dissimilarity distance matrix
    lagdays = 10
    DOlim     <- 7
    pHlimLow  <- 6.5
    pHlimHigh <- 9
    siteQual2Plot = stringr::str_to_sentence("not degraded") # options:"reference","better than","not degraded"
  }##IF.DEBUG.CaseNumber.END
}##IF.boo.DEBUG.END

```

# **REPORT INFORMATION**

```{r report_date}
  # myReportDate <- format(Sys.time(), "%Y-%m-%d %H:%M:%S")
  # cat(paste("**Report Date and Time:** ", myReportDate, "\n\n", sep = ""))
  # myUser <- Sys.getenv("USERNAME")
  # cat(paste("**Generated By:** ", myUser, "\n\n", sep = ""))
  # # cat(paste("**CASTfxn Package Version:** ",packageVersion("CASTfxn"),"\n\n",sep=""))
  
  cat("**Selected parameters:**\n\n")
  cat(paste("\tRemove outliers? ", removeOutliers, "\n", sep = ""))
  cat(paste("\tUse expected biological similarity filter? ", useBC, "\n"
            , sep = ""))
  cat(paste("\tNumber of days lag time between stressor and response sample collection = "
            , lagdays, "\n", sep = ""))
  cat(paste("\tQuality of site displayed on analysis graphics? ", siteQual2Plot
            , "\n", sep = ""))
  cat(paste("\tLower and upper percentiles for identifying stressors = ", probsLow
            , "-", probsHigh, "\n", sep = ""))
  cat(paste("\tLimit above which DO is not identified as a stressor = ", DOlim
            , "\n", sep = ""))
  cat(paste("\tLimits between which pH is not identified as a stressor = "
            , pHlimLow, " and ", pHlimHigh, "\n\n", sep = ""))

```

# **DISCLAIMER**

The CASTool is a screening tool. It is intended to assist the City of San Diego and its agents to rapidly screen and assist with identifying causes of biological impairment. Due the tool's reliance on currently available and sometimes incomplete data, however, it is not intended to be a final arbiter on assessment analyses, nor does it represent any commitments by the City to perform any specific projects, studies, or other actions.

The most reliable results correspond with stressors for which many recent results are available and for which all lines of evidence used in this tool demonstrate similar results. If this screening-level analysis shows supporting evidence for a stressor as a cause of impairment, additional evaluation is warranted.

Stressors for which little data exists may or may not be identified as potential stressors by the CASTool and should be treated with caution. Moreover, care should be taken when using results based on data collected several years ago; those data (and therefore the results of the CASTool) may not reflect current conditions. 

Additional information on causal assessment is available in EPA's Stressor Identification Guidance Document. (U.S. Environmental Protection Agency. (2000). Stressor Identification Guidance Document. (EPA/822/B-00/025). Cincinnati, OH: U.S. Environmental Protection Agency, Office of Water, Office of Research and Development, National Exposure Research Laboratory) 

# **SITE INFORMATION**

```{r SiteID}
#list.dirs(file.path(getwd(), "Results"), full.names=FALSE, recursive=FALSE)

  cat(paste("**Site ID:** ",TargetSiteID,"\n\n",sep = ""))

```

```{r map, out.width = "80%"}
dir.sub3 <- "SiteInfo"
#TargetSiteID <- "SRCKN001.61"
myMAP <- paste0(TargetSiteID,"_map.png")
fn_img <- file.path(dir_results, TargetSiteID, dir.sub3, myMAP)
if (file.exists(fn_img) == TRUE) {
  knitr::include_graphics(fn_img)
} else {
  cat("No file exists; map.\n")
}
```

## *Site Photos*

```{r photos, out.width = "50%", out.extra = 'style = "padding:10px"'}
dir.sub3 <- "SiteInfo"
dir_SiteID <- file.path(dir_results, TargetSiteID, dir.sub3, "Photos")
fn_all  <- list.files(path = dir_SiteID, full.names = TRUE
                                 , pattern = ".jpg|.png|.mp4")
txt_grp_msg <- "media"
#
if (length(fn_all) > 0) {##IF.boo.pdf.START
  msg_files <- paste0("All ", txt_grp_msg," files are in the '"
                      , paste0("Results/",dir.sub3,"/Photos"), "' folder.\n"
                      , "Images are shown here.\n\n")
  cat(msg_files)
  
  fn_Photos_jpg <- fn_all[grep(".jpg", fn_all)]
  
    if (length(fn_Photos_jpg) == 0) {
      txt_NoFile <- "No file exists; photos.\n"
      cat(txt_NoFile)
    } else if (file.exists(fn_Photos_jpg[1]) == TRUE) {
      #
      fn_img <- fn_Photos_jpg
      knitr::include_graphics(fn_img)
      #
    } else {
      cat(txt_NoFile)
    }
  
} else if (length(fn_all) == 0) {
  msg_files <- paste0("No ", txt_grp_msg," files exist.\n")
  
} else {
  msg_files <- ""
  
}##IF.boo.pdf.START

cat(msg_files)
#
```

<!-- ## *Site Background* -->

<!-- ```{r bkgdplots, out.width = "100%", out.extra = 'style = "padding:10px"'} -->
<!-- dir.sub3 <- "SiteInfo" -->
<!-- dir_SiteID <- file.path(dir_results, TargetSiteID, dir.sub3) -->
<!-- fn_all  <- list.files(path = dir_SiteID, full.names = TRUE -->
<!--                                  , pattern = ".png") -->
<!-- txt_grp_msg <- "background bar graphs" -->
<!-- # -->
<!-- if (length(fn_all) > 0) {##IF.boo.pdf.START -->
<!--   msg_bkg <- paste0("All ", txt_grp_msg," are in the '" -->
<!--                     , paste0("Results/",TargetSiteID,"/",dir.sub3) -->
<!--                     , "' folder.\nSelected graphics are shown here.\n\n") -->
<!--   cat(msg_bkg) -->

<!--   desiredbkg <- c("DevelopLULC", "HousePopul", "Imperv", "StreamMetricsHydro") -->

<!--   fn_bkgd <- fn_all[grep(".png", fn_all)] -->
<!--   fn_bkgd <- fn_bkgd[grep("BKGD", fn_bkgd)] -->
<!--   fn_bkgd <- fn_bkgd[grep("DevelopLULC|HousePopul|Imperv|StreamMetricsHydro", fn_bkgd)] -->

<!--     if (length(fn_bkgd) == 0) { -->
<!--       txt_NoFile <- "No file exists; background bar plots.\n" -->
<!--       cat(txt_NoFile) -->
<!--     } else if (file.exists(fn_bkgd[1]) == TRUE) { -->
<!--       # -->
<!--       fn_img <- fn_bkgd -->
<!--       knitr::include_graphics(fn_img) -->
<!--       # -->
<!--     } else { -->
<!--       cat(txt_NoFile) -->
<!--     } -->

<!-- } else if (length(fn_all) == 0) { -->
<!--   msg_bkg <- paste0("No ", txt_grp_msg," files exist.\n") -->
<!--   cat(msg_bkg) -->

<!-- } else { -->
<!--   msg_bkg <- "" -->
<!--   cat(msg_bkg) -->

<!-- }##IF.boo.pdf.START -->
<!-- # -->
<!-- ``` -->

## *Site Sample Summary*

The table below lists any samples collected from `r TargetSiteID` over time. Red index scores indicate degraded biological quality for benthic macroinvertebrates (`r bmiIndex`) or algae (`r algIndexTxt`).

```{r sampsummary}
# Read file summarizing the comparator data and provide it in summary form
fnSamps <- file.path(dir_data,"SMCSiteSummary.tab")
dfSamps <- read.delim(fnSamps, header = TRUE, sep = "\t")
dfSamps <- dfSamps[dfSamps$StationID_Master == TargetSiteID,]
row.names(dfSamps) <- NULL
dfSamps <- dplyr::select(dfSamps, -SampYear) %>%
    dplyr::rename(Cluster = clust, SampleDate = SampDate) %>%
    dplyr::mutate(SampleDate = lubridate::mdy(SampleDate))
sampColNames <- colnames(dfSamps)
coreColNames <- c("StationID_Master", "COMID", "Cluster", "SampleDate")
sampColNames <- setdiff(sampColNames, coreColNames)

# Get bmiIndex values, if they exist
if (useBMI == TRUE) {
    
    fnBMI <- file.path(dir_data,"SMCBenthicMetricsFinal.tab")
    dfBMI <- read.delim(fnBMI, header = TRUE, sep = "\t")
    dfBMI <- dfBMI %>% 
        dplyr::filter(StationID_Master == TargetSiteID) %>%
        dplyr::select(StationID_Master, BMISampID, all_of(bmiIndex))
    if (nrow(dfBMI) > 0) { # There are BMI Index values
        dfSamps <- merge(dfSamps, dfBMI
              , by.x = c("StationID_Master","BMISampID")
              , by.y = c("StationID_Master","BMISampID")
              , all.x = TRUE)
    } else {# There are no BMI Index values, so add col and set all to NA
        dfSamps <- dfSamps %>% dplyr::mutate(BMI.Index = NA)
        colnames(dfSamps[,BMI.Index]) <- bmiIndex
    }
    dfSamps[[bmiIndex]] <- ifelse(is.na(dfSamps[[bmiIndex]]),NA
                                  ,round(dfSamps[[bmiIndex]],3))
    rm(fnBMI, dfBMI)

} else {
    dfSamps[[bmiIndex]] <- NA
}


# Get algIndex values, if they exist
if (useAlg == TRUE) {
    fnAlg <- file.path(dir_data,"SMCAlgaeMetricsFinal.tab")
    dfAlg <- read.delim(fnAlg, header = TRUE, sep = "\t")
    dfAlg <- dfAlg %>% 
        dplyr::filter(StationID_Master == TargetSiteID) %>%
        dplyr::select(StationID_Master, AlgSampID, eval(algIndex))
    if (nrow(dfAlg) > 0) { # There are BMI Index values
        dfSamps <- merge(dfSamps, dfAlg
              , by.x = c("StationID_Master","AlgSampID")
              , by.y = c("StationID_Master","AlgSampID")
              , all.x = TRUE)
    } else {# There are no Alg Index values, so add col and set all to NA
        dfSamps <- dfSamps %>% dplyr::mutate(Alg.Index = NA)
        colnames(dfSamps[,Alg.Index]) <- algIndex
    }
    dfSamps[[algIndex]] <- ifelse(is.na(dfSamps[[algIndex]]),NA
                                  ,round(dfSamps[[algIndex]],3))
    rm(fnAlg, dfAlg)
} else {
    # Need to add the appropriate data columns to the file here
    dfSamps[[algIndex]] <- NA
}

# Get BMISampFlag, if any
fnCompSamps <- file.path(dir_results, TargetSiteID, "SiteInfo"
                         , paste0(TargetSiteID,"_COMPARATORS.tab"))
dfCompSamps <- read.delim(fnCompSamps, header = TRUE, sep = "\t")

dfSiteFlags <- dfCompSamps %>%
    dplyr::filter(StationID_Master == TargetSiteID) %>%
    dplyr::select(RespSampID, RespSampFlag) %>%
    dplyr::rename(BMISampID = RespSampID, BMISampFlag = RespSampFlag)

dfSamps <- merge(dfSamps, dfSiteFlags, all.x = TRUE)

dfSamps <- dfSamps %>%
    dplyr::select(all_of(coreColNames), all_of(bmiIndex), BMISampFlag
                  , all_of(algIndex), all_of(sampColNames))


dfSamps <- dplyr::arrange(dfSamps, SampleDate, all_of(bmiIndex), all_of(algIndex))

  if (report_format == "html") {
    
    tblColNames <- c("Site", "Reach", "Cluster", "Sample Date", "CSCI", "BMI Sample Flag"
                 , "MMI Hybrid", "Lab Chemistry Sample ID", "Habitat Sample ID"
                 , "Field Chemistry Sample ID", "Modeled Flow ID (benthos)"
                 , "Modeled Flow ID (algae)", "BMI Sample ID", "Algae Sample ID"
                 , "Epiphyte Sample ID", "Integrated Algae Sample ID"
                 , "Macroalgae Sample ID", "Microalgae Sample ID")
    
    tblCaption <- paste0("<h5><em>Samples collected from ", TargetSiteID,".</em></h5>")
    
    if (nrow(dfSamps) < 1) {
      
        cat(paste0("No sample data for ", TargetSiteID))

    } else if (nrow(dfSamps <= 10)) {
      
      cat(tblCaption)
      
      DT::datatable(dfSamps
                    , extensions = 'FixedColumns'
                    , options = list(dom = 'ti'
                                     , pageLength = 10
                                     , bSort = FALSE
                                     , scrollX = TRUE
                                     , fixedColumns = TRUE
                                     , columnDefs = list(list(className = 'dt-center'
                                                             , targets = '_all')
                                                         , list(className = 'dt-bottom'
                                                             , targets = '_all')))
                    , colnames = tblColNames
                    , class = 'striped hover row-border'
                    , filter = 'none'
                    , rownames = FALSE) %>%
        DT::formatStyle(columns = colnames(dfSamps), fontSize = '85%') %>%
        DT::formatStyle('CSCI', color = DT::styleInterval(0.79, c('red', 'black'))
                        , fontWeight = DT::styleInterval(0.79, c('bold', 'normal'))) %>%
        DT::formatStyle('MMIhybrid', color = DT::styleInterval(0.82, c('red', 'black'))
                        , fontWeight = DT::styleInterval(0.82, c('bold', 'normal'))) %>%
        DT::formatStyle(c("ChemSampleID","PhabSampID", "FldChemSampID", "FlowBMISampID"
                          , "FlowAlgSampID", "BMISampID", "AlgSampID", "EpiphyteSampID"
                          , "IntegAlgSampID", "MacroalgSampID", "MicroalgSampID")
                        , "white-space" = "nowrap")

    } else {
      
      cat(tblCaption)
      
      DT::datatable(dfSamps
                    , extensions = 'FixedColumns'
                    , options = list(dom = 'lftip'
                                     , pageLength = 10
                                     , bSort = FALSE
                                     , scrollX = TRUE
                                     , fixedColumns = TRUE
                                     , columnDefs = list(list(className = 'dt-center'
                                                             , targets = '_all')
                                                         , list(className = 'dt-bottom'
                                                             , targets = '_all')))
                    , colnames = tblColNames
                    , class = 'striped hover row-border'
                    , filter = 'none'
                    , rownames = FALSE) %>%
        DT::formatStyle(columns = colnames(dfSamps), fontSize = '85%') %>%
        DT::formatStyle('CSCI', color = DT::styleInterval(0.79, c('red', 'black'))
                        , fontWeight = DT::styleInterval(0.79, c('bold', 'normal'))) %>%
        DT::formatStyle('MMIhybrid', color = DT::styleInterval(0.82, c('red', 'black'))
                        , fontWeight = DT::styleInterval(0.82, c('bold', 'normal')))
    }
  
  } else {
    
    msg <- "Not displayed in non-html format."
    cat(msg)
    
  }

cat("See data gaps for explanation of flag values.")

```

## *Potential Candidate Causes*

```{r BMIStrSelect}

if (useBMI == TRUE) {
    
    dir.sub3 <- "CandidateCauses"
    fn_stressBMI <- paste0(TargetSiteID,"_BMI_CandCauses_StressorsEvaluated.tab")
    fn_strUsedBMI <- file.path(dir_results,TargetSiteID,"BMI",dir.sub3,fn_stressBMI)
    fn_stressBMIexcl <- paste0(TargetSiteID,"_BMI_CandCauses_StressorsExcluded.tab")
    fn_strExclBMI <- file.path(dir_results,TargetSiteID,"BMI",dir.sub3,fn_stressBMIexcl)
    
    msgBMIExclReasons <- paste0("Modeled flow metrics may be excluded for analysis for one biological community because they are not expected to impact that community. These same metrics may be included for a different biological community. Dissolved oxygen (DO) may be excluded if it falls below the percentile threshold selected but is above the absolute threshold defined as acceptable. Similarly, pH may be excluded if it falls outside the selected percentile thresholds but inside the absolute values considered acceptable.")
      
        if (file.exists(fn_strUsedBMI)) {##IF.boo.pdf.START
            dfStrUsedBMI <- read.delim(fn_strUsedBMI, header = TRUE, sep = "\t")
            stressorlistBMI <- paste(as.vector(dfStrUsedBMI$Label), collapse = "\n\t * ")
            
            if (file.exists(fn_strExclBMI)) {
                dfStrExclBMI <- read.delim(fn_strExclBMI, header = TRUE, sep = "\t")
                notstressorlistBMI <- paste(as.vector(dfStrExclBMI$Label)
                                            , collapse = "; ")
                if (notstressorlistBMI[1] == "None") {
                    msgstrexclBMI <- paste0("**No stressors were excluded from "
                                             , "evaluation as potential candidate "
                                             , "causes of benthic macroinvertebrate "
                                             , "impairment.**\n")
                } else {
                    msgstrexclBMI <- paste0("**Stressors excluded as potential candidate "
                                  , "causes of benthic macroinvertebrate impairment "
                                  , "include:** ", notstressorlistBMI, "\n\n"
                                  , msgBMIExclReasons, "\n\n")
                }
            } else {
              msgstrexclBMI <- paste0("**No stressors were excluded from "
                                      , "evaluation as potential candidate "
                                      , "causes of benthic macroinvertebrate "
                                      , "impairment.**\n")
            }

            msg_strlistBMI <- paste0("**Stressors identified as potential candidate "
                                  , "causes of benthic macroinvertebrate impairment "
                                  , "include:**\n\t* ", stressorlistBMI, "\n\n"
                                  , msgstrexclBMI, "\n\n")
        } else if (!file.exists(fn_strUsedBMI)) {
            msg_strlistBMI <- paste0("**No stressors were identified as possible "
                                     , "candidate causes of benthic macroinvertebrate "
                                     , "community impairment.**\n\n")
        } else {
            msg_strlistBMI <- ""
        }##IF.boo.pdf.START
        #
    cat(msg_strlistBMI)
} else {
    cat(paste0("**No benthic macroinvertebrate data are available for "
               , TargetSiteID,".**\n\n"))
}

if (useAlg == TRUE) {
    
    dir.sub3 <- "CandidateCauses"
    fn_stressALGAE <- paste0(TargetSiteID, "_ALGAE_CandCauses_StressorsEvaluated.tab")
    fn_strUsedALGAE <- file.path(dir_results, TargetSiteID, "ALGAE", dir.sub3
                                 , fn_stressALGAE)
    fn_stressALGAEexcl <- paste0(TargetSiteID
                                 , "_ALGAE_CandCauses_StressorsExcluded.tab")
    fn_strExclALGAE <- file.path(dir_results, TargetSiteID, "ALGAE", dir.sub3
                                 , fn_stressALGAEexcl)
    
        msgAlgExclReasons <- paste0("Chlorophyll-a, pheophytin-a, and ash-free dry mass from algae are excluded as algal stressors because they represent measures of algae. Modeled flow metrics may be excluded for analysis for one biological community because they are not expected to impact that community. These same metrics may be included for a different biological community. Dissolved oxygen (DO) may be excluded if it falls below the percentile threshold selected but is above the absolute threshold defined as acceptable. Similarly, pH may be excluded if it falls outside the selected percentile thresholds but inside the absolute values considered acceptable.")
      
        if (file.exists(fn_strUsedALGAE)) {##IF.boo.pdf.START
            dfStrUsedALG <- read.delim(fn_strUsedALGAE, header = TRUE, sep = "\t")
            stressorlistALG <- paste(as.vector(dfStrUsedALG$Label), collapse = "\n\t* ")
            
            if (file.exists(fn_strExclALGAE)) {
                dfStrExclALG <- read.delim(fn_strExclALGAE, header = TRUE, sep = "\t")
                notstressorlistALG <- paste(as.vector(dfStrExclALG$Label)
                                            , collapse = "; ")
                if (notstressorlistALG[1] == "None") {
                    msgstrexclALG <- paste0("**No stressors were excluded from "
                                             , "evaluation as potential candidate "
                                             , "causes of algal community "
                                             , "impairment.**\n")
                } else {
                    msgstrexclALG <- paste0("**Stressors excluded as potential candidate "
                                  , "causes of algal community impairment "
                                  , "include:** ", notstressorlistALG, "\n\n"
                                  , msgAlgExclReasons, ".\n")
                }
            } else { 
              msgstrexclALG <- paste0("**No stressors were excluded from "
                                      , "evaluation as potential candidate "
                                      , "causes of algal community "
                                      , "impairment.**\n")
            }

            msg_strlistALG <- paste0("**Stressors identified as potential candidate "
                                  , "causes of algal community impairment "
                                  , "include:**\n\t* ", stressorlistALG, "\n\n"
                                  , msgstrexclALG, "\n\n")
        } else if (!file.exists(fn_strUsedALGAE)) {
            msg_strlistALG <- paste0("**No stressors were identified as possible " 
                                     , "candidate causes of algal community "
                                     , "impairment.**\n\n")
        } else {
            msg_strlistALG <- ""
        }##IF.boo.pdf.START
        #
    cat(msg_strlistALG)
} else {
    cat(paste0("**No algae data are available for ", TargetSiteID,".**\n\n"))
}
```

```{r files_BMIStrBoxes}

if (useBMI == TRUE) {
    dir.sub3 <- "CandidateCauses"
    txt_grp_file <- "CandCauses"
    txt_grp_msg <- "stressor box"
    fn_all <- list.files(file.path(dir_results, TargetSiteID, "BMI", dir.sub3)
                         , pattern = "png")
    #
    if (length(fn_all) < 1) {##IF.boo.pdf.START
      msg_strboxdir <- paste0("No ", txt_grp_msg," plots exist.\n")
    } else {
      msg_strboxdir <- ""
    }##IF.boo.pdf.START
    #
    cat(msg_strboxdir)

} else if (useAlg == TRUE) {
  
    dir.sub3 <- "CandidateCauses"
    txt_grp_file <- "CandCauses"
    txt_grp_msg <- "stressor box"
    fn_all <- list.files(file.path(dir_results, TargetSiteID, "ALGAE", dir.sub3)
                         , pattern = "png")
    #
    if (length(fn_all) < 1) {##IF.boo.pdf.START
      msg_strboxdir <- paste0("No ", txt_grp_msg," plots exist.\n")
    } else {
      msg_strboxdir <- ""
    }##IF.boo.pdf.START
    #
    cat(msg_strboxdir)

} else {
    cat("")
}

```

```{r StrBoxPlots, out.width = "100%", out.extra = 'style = "padding:10px"'}

if (useBMI == TRUE) {
    dir.sub3 <- "CandidateCauses"
    dir_SiteID <- file.path(dir_results, TargetSiteID, "BMI", dir.sub3)
    fn_BoxPlots  <- list.files(path = dir_SiteID, full.names = TRUE
                                     , pattern = "_BMI_CandCauses")
    fn_BoxPlots_jpg <- fn_BoxPlots[grep(".png", fn_BoxPlots)]
    if (length(fn_BoxPlots_jpg) == 0) {
      txt_NoFile <- ""
      cat(txt_NoFile)
    } else if (file.exists(fn_BoxPlots_jpg[1]) == TRUE) {
      #
      cat(paste("Box plots are arranged by stressor category. Stressors requiring"
                , " further evaluation fall outside the ", probsLow, "-", probsHigh
                , " quantile range.\n\n",sep = ""))
    
      fn_img <- fn_BoxPlots_jpg
      knitr::include_graphics(fn_img)
      #
    } else {
      cat(txt_NoFile)
    }
} else if (useAlg == TRUE) {
    dir.sub3 <- "CandidateCauses"
    dir_SiteID <- file.path(dir_results, TargetSiteID, "ALGAE", dir.sub3)
    fn_BoxPlots  <- list.files(path = dir_SiteID, full.names = TRUE
                                     , pattern = "_ALGAE_CandCauses")
    fn_BoxPlots_jpg <- fn_BoxPlots[grep(".png", fn_BoxPlots)]
    
    if (length(fn_BoxPlots_jpg) == 0) {
      txt_NoFile <- ""
      cat(txt_NoFile)
    } else if (file.exists(fn_BoxPlots_jpg[1]) == TRUE) {
      #
      cat(paste("Box plots are arranged by stressor category. Stressors requiring"
                , " further evaluation fall outside the ", probsLow, "-", probsHigh
                , " quantile range.\n\n",sep = ""))
    
      fn_img <- fn_BoxPlots_jpg
      knitr::include_graphics(fn_img)
      #
    } else {
      cat(txt_NoFile)
    }    
} else {
    cat("")
}

```

# **BMI RESULTS**

## *Biological Index Distributions*

```{r bmi_box, out.width = "70%", out.extra = 'style = "padding:10px"'}

if (useBMI == TRUE) {
    dir.sub3 <- "SiteInfo"
    #TargetSiteID <- "SRCKN001.61"
    myBMIbox <- paste0(TargetSiteID,"_BMI_IndexBoxplots.png")
    fn_img <- file.path(dir_results, TargetSiteID, dir.sub3, myBMIbox)
    if (file.exists(fn_img) == TRUE) {
      knitr::include_graphics(fn_img)
    } else {
      cat("Benthic macroinvertebrate index distributions are not available.\n")
    }
} else {
    cat(paste0("No benthic macroinvertebrate data for ", TargetSiteID,".\n"))
}

```

## *Comparator Site Information*

```{r bmicompsitesummarytable}
# Read file summarizing the comparator data and provide it in summary form

if (useBMI == TRUE) {
    dir.sub3 <- "SiteInfo"
    mycomps <- paste0(TargetSiteID,"_BMI_SiteQualities.tab")
    fn_comps <- file.path(dir_results, TargetSiteID, dir.sub3, mycomps)
    msg_info <- paste(paste0("Comparator site information, including a list "
                       , "of comparator sites, can be found in the '"
                       , paste(paste0("Results/",TargetSiteID,"/BMI/",dir.sub3)
                       , "' folder."))
                       , paste0("<h5><em>Numbers of sites by type (Comparator, "
                                , "cluster, or entire dataset), "
                                , "type (all samples or only those "
                                , "having better biology than those "
                                , "from the target site) and quality.</em></h5>"), ""
                       , sep = "\n\n")
    
    if (file.exists(fn_comps) == TRUE) {
      
        dfcomps <- read.delim(fn_comps, header = TRUE, sep = "\t")
        dfcomps <- dplyr::select(dfcomps, -BioComm)
      
        cat(msg_info)
        
        tcomps <- knitr::kable(dfcomps, format = report_format
                               , colnames = colnames(dfcomps))
        tcomps <- kableExtra::kable_styling(tcomps
                                            , bootstrap_options = "condensed"
                                            , font_size = 12, full_width = FALSE
                                            , position = "left")
        tcomps <- kableExtra::column_spec(tcomps, column = 1, bold = TRUE)
        tcomps <- kableExtra::collapse_rows(tcomps, columns = 1:2, valign = "top")
        tcomps
        
    } else {
      
      cat("No comparator site information is available for benthic macroinvertebrates.\n")
      
    }

} else {
    cat(paste0("No benthic macroinvertebrate data are available for ", TargetSiteID,".\n"))
}

```

```{r bmicompsitesummarystatement}
# Read file summarizing the comparator data and provide it in summary form

if (useBMI == TRUE) {
    dir.sub3 <- "SiteInfo"
    mycompsamps <- paste0(TargetSiteID,"_COMPARATORS.tab")
    fncompsamps <- file.path(dir_results, TargetSiteID, dir.sub3, mycompsamps)

    if (file.exists(fncompsamps) == TRUE) {
        dfcompsamps <- read.delim(fncompsamps, header = TRUE, sep = "\t"
                                  , stringsAsFactors = FALSE)
        dfcompsamps <- dfcompsamps %>%
            filter(StationID_Master != TargetSiteID)
        dfbcdist <- unique(dplyr::select(dfcompsamps, StationID_Master
                                         , BCdistance, Comment))
        totcompsamps <- nrow(dfbcdist)

        maxbcdist <- 1 - round(max(dfbcdist$BCdistance),2)
        dfbcdist <- dfbcdist %>%
            dplyr::select(StationID_Master, Comment) %>%
            dplyr::group_by(Comment) %>%
            dplyr::summarise(NumSites = n(), .groups = "drop_last")
        
        numLTEQ <- dfbcdist %>%
            dplyr::filter(grepl("LTEQ",Comment)) %>%
            dplyr::select(NumSites)
        if (nrow(numLTEQ) == 0) {
            numLTEQ <- as.numeric(0)
        } else {
            numLTEQ <- as.numeric(numLTEQ)
        }
        bc_cutoff <- as.character(stringr::str_extract(dfbcdist[1,1],"\\d{2}"))
        bc_cutoff <- as.numeric(paste0("0.",bc_cutoff))
        bc_cutoff <- 1 - bc_cutoff
        numGT <- dfbcdist %>%
            dplyr::filter(grepl("GT",Comment)) %>%
            dplyr::select(NumSites)
        numGT <- as.numeric(numGT)
        
        if (numLTEQ == totcompsamps) {
            msgbcdist <- paste0("All ", numLTEQ, " comparator sites have >"
                                , maxbcdist*100, "% expected biological "
                                , "similarity.\n")
        } else if (numLTEQ < totcompsamps) {
            msgbcdist <- paste0(numLTEQ, " comparator sites have >"
                                , bc_cutoff*100, "% expected biological "
                                , "similarity and ", numGT, " comparator samples "
                                , "have between ", bc_cutoff*100, " and "
                                , maxbcdist*100, " percent expected biological "
                                , "similarity.\n")
        }
        
        cat(msgbcdist)
        
    }

} else {
    cat("")
}

```

```{r bmicompsiteflags}
# Read file summarizing the comparator data and provide it in summary form

if (useBMI == TRUE) {
    dir.sub3 <- "SiteInfo"
    mycompsamps <- paste0(TargetSiteID,"_COMPARATORS.tab")
    fncompsamps <- file.path(dir_results, TargetSiteID, dir.sub3, mycompsamps)

    if (file.exists(fncompsamps) == TRUE) {
        dfcompsamps <- read.delim(fncompsamps, header = TRUE, sep = "\t"
                                  , stringsAsFactors = FALSE)
        dfcompsamps <- dfcompsamps %>%
            filter(StationID_Master != TargetSiteID) %>%
            filter(!is.na(CSCI))

        dfcompflags <- dfcompsamps %>% 
            dplyr::select(RespSampID, Quality, RespSampFlag) %>%
            dplyr::mutate(RespSampFlag = ifelse(is.na(RespSampFlag)
                                                , "No flags", RespSampFlag)) %>%
            dplyr::group_by(RespSampFlag, Quality) %>%
            dplyr::summarise(NumSamps = n(), .groups = "drop_last") %>%
            tidyr::spread(key = Quality, value = NumSamps) %>%
            dplyr::rename(BMISampFlag = RespSampFlag)
        
        flagcaption <- paste0("<h5><em>Summary of the numbers of samples "
                              , "flagged for possible inadequacies in the "
                              , "benthic macroinvertebrate data.</em></h5>")
        cat(flagcaption)
        
        tcompsamps <- knitr::kable(dfcompflags, format = report_format
                     , colnames = colnames(dfcompflags))
        tcompsamps <- kableExtra::kable_styling(tcompsamps
                                                , bootstrap_options = "condensed"
                                                , font_size = 12, full_width = FALSE
                                                , position = "left")
        tcompsamps <- kableExtra::column_spec(tcompsamps
                                              , column = 1, bold = TRUE)
        tcompsamps <- kableExtra::collapse_rows(tcompsamps
                                                , columns = 1, valign = "top")
        tcompsamps

    }

} else {
    cat("")
}

```

```{r bmicompsiteflagstatement}
# Read file summarizing the comparator data and provide it in summary form

if (useBMI == TRUE) {
    dir.sub3 <- "SiteInfo"
    mycompsamps <- paste0(TargetSiteID,"_COMPARATORS.tab")
    fncompsamps <- file.path(dir_results, TargetSiteID, dir.sub3, mycompsamps)

    if (file.exists(fncompsamps) == TRUE) {

        msgflags <- paste0("* Insufficient individuals refers to samples "
                           , "containing fewer than 250 individuals.\n\n"
                           , "* Large percent ambiguity refers to samples "
                           , "with more than 50% ambiguous individuals.\n\n"
                           , "* Unknown refers to samples for which the "
                           , "percentage of ambiguous individuals is not "
                           , "recorded.\n\n")
        cat(msgflags)

    }
    
} else {
    cat("")
}

```

## *Weight of Evidence*

### Overall Findings

The table below displays the scores for each line of evidence and overall weight of evidence, weighted by number of stressors in each group. Overall weight of evidence scores include:

* 1 indicates that all evaluated lines of evidence for all observed stressors in the group support the group as a cause of impairment
* -1 indicates that all evaluated lines of evidence for all observed stressors in the group refute the group as a cause of impairment
* 0 indicates that the evaluated lines of evidence for the observed stressors in the group are indeterminate regarding cause of impairment
* NE indicates that the stressor group was not evaluated

```{r in_out_msg}

msg1 <- "site samples and comparator samples, whereas data from outside the case include the site samples and cluster samples."
  
msg2 <- "site samples and cluster samples, whereas data from outside the case include the site samples and all other samples in the dataset."
  
```

Inside refers to evidence from data inside the case, and outside refers to evidence from data outside the case. Data from inside the case includes `r ifelse(useBC == TRUE, msg1, msg2)` Taxon sensitivity curves rely on laboratory toxicity tests and therefore represent data from outside the case.

```{r WoEsummary_bmi}

if (useBMI == TRUE) {
  
    dir.sub3 <- "WoE"
    dir_WoE_bmi <- file.path(dir_results, TargetSiteID, "BMI", dir.sub3)
    txt_grp_msg <- "Overall summary weight of evidence data"
    fn_target1 <- paste0(TargetSiteID,"_BMI_WoE_ExecSummary.tab")
    fn_WoE_ES  <- list.files(path = dir_WoE_bmi, full.names = TRUE
                                     , pattern = fn_target1)
    if (length(fn_WoE_ES) == 0) {
      
      txt_NoFile <- paste0("No ", tolower(txt_grp_msg)," exist.\n")
      cat(txt_NoFile)
      
    } else if (file.exists(fn_WoE_ES[1]) == TRUE) {
      
        msg_files <- paste0(txt_grp_msg," are found in the file '", fn_target1
                          , "' in the'", dir_WoE_bmi, "' folder.\n")

        df_ES <- read.delim(file.path(dir_WoE_bmi, fn_target1), header = TRUE
                            , sep = "\t")
        
        df_ES <- dplyr::select(df_ES, -BioComm, BioDeg, StressorType, NumStressSamples
                               , NumStressors, WtTot_WoE, WtTotTS_barplot, WtTotCO_boxplot
                               , WtTotSR_InCase_LogRegr, WtTotSR_InCase_LinRegr
                               , WtTotSR_OutCase_LinRegr, WtTotVP_boxplot)
        
        df_ES$Blank1 <- NA

        df_ES <- dplyr::rename(df_ES, SiteID = StationID_Master
                               , Degraded = BioDeg
                               , Group = StressorType
                               , Stressor_Samples = NumStressSamples
                               , Stressors = NumStressors
                               , Overall_WoE = WtTot_WoE
                               , TS_Inside = WtTotTS_barplot
                               , CO_boxplot = WtTotCO_boxplot
                               , SR_Inside_LogRegr = WtTotSR_InCase_LogRegr
                               , SR_Inside_LinRegr = WtTotSR_InCase_LinRegr
                               , SR_Outside_LinRegr = WtTotSR_OutCase_LinRegr
                               , VP_Boxplot = WtTotVP_boxplot)
        
        df_ES <- dplyr::select(df_ES
                               , SiteID
                               , Degraded
                               , Group
                               , Stressor_Samples
                               , Stressors
                               , Overall_WoE
                               , TS_Inside
                               , CO_boxplot
                               , SR_Inside_LogRegr
                               , SR_Inside_LinRegr
                               , VP_Boxplot
                               , Blank1
                               , SR_Outside_LinRegr)
        
        if (report_format == "html") { # Prepare HTML sumamry report
          
          tblCaption <- paste0("<h5><em>", txt_grp_msg, ".</em></h5>")
          cat(tblCaption)
    
          sketch <- htmltools::withTags(table(
            class = 'display'
            , thead(
              tr(
                th(rowspan = 2, 'Site')
                , th(rowspan = 2, 'Degraded')
                , th(rowspan = 2, 'Stressor Group')
                , th(rowspan = 2, 'Num. Stressor Samples')
                , th(rowspan = 2, 'Num. Stressors')
                , th(rowspan = 2, 'Overall Weight of Evidence')
                , th(colspan = 5, 'Inside the Case')
                , th(rowspan = 2, '')
                , th(colspan = 1, 'Outside the Case')
              )
              , tr(
                  lapply(c('Time Sequence', 'Co-occurrence', 'Stressor-response'
                           , 'Biological gradient', 'Verified prediction'
                           , 'Biological gradient'), th)
              )
            )
          ))
          
          if (nrow(df_ES) <= 10) {# Fewer than 11 rows in table
            DT::datatable(df_ES
                          , container = sketch
                          , extensions = 'FixedColumns'
                          , options = list(dom = 'ti'
                                           , pageLength = 10
                                           , bSort = FALSE
                                           , scrollX = TRUE
                                           , fixedColumns = list(leftColumns = 1)
                                           , autoWidth = TRUE
                                           , columnDefs = list(list(width = '140px'
                                                                      , targets = 1)
                                                               , list(className = 'dt-left'
                                                                    , targets = 2)
                                                               , list(className = 'dt-center'
                                                                    , targets = c(0:1,3:12))
                                                               , list(className = 'dt-bottom'
                                                                    , targets = '_all')))
                          , class = 'striped hover row-border'
                          , filter = 'none'
                          , rownames = FALSE) %>%
              DT::formatStyle(columns = colnames(df_ES), fontSize = '85%')
          } else {# More than 10 rows in table
            DT::datatable(df_ES
                          , container = sketch
                          , extensions = 'FixedColumns'
                          , options = list(dom = 'lftip'
                                           , pageLength = 10
                                           , bSort = FALSE
                                           , scrollX = TRUE
                                           , fixedColumns = list(leftColumns = 1)
                                           , autoWidth = TRUE
                                           , lengthMenu = ifelse(nrow(df_ES) > 10
                                                                 , c(10, 25, 50, 100)
                                                                 , 10)
                                           , columnDefs = list(list(width = '140px'
                                                                      , targets = 1)
                                                               , list(className = 'dt-left'
                                                                    , targets = 2)
                                                               , list(className = 'dt-center'
                                                                    , targets = c(0:1,3:12))
                                                               , list(className = 'dt-bottom'
                                                                    , targets = '_all')))
                          , class = ' striped hover row-border'
                          , filter = 'none'
                          , rownames = FALSE) %>%
              DT::formatStyle(columns = colnames(df_ES), fontSize = '85%')
          }
        
        } else {# Report format selected is not HTML
          
          msg <- "Not displayed in non-html format."
          cat(msg)
          
        }

    } else {# No WoE file found
      cat(txt_NoFile)
    }
} else {# UseBMI != TRUE
    cat(paste0("No benthic macroinvertebrate data are available for ", TargetSiteID,".\n"))
}

```

### Stressor-Specific Scores

The table below shows scores for each stressor identified in one or more samples obtained from the bioassessment site `r TargetSiteID`, along with each line of evidence Scores for each line of evidence include:

* 1 for evidence supporting the stressor as a cause of impairment
* -1 for evidence refuting the stressor as a cause of impairment
* 0 for indeterminate evidence
* NE for not evaluated

```{r WoEscores_bmi}

if (useBMI == TRUE) {
    dir.sub3 <- "WoE"
    dir_WoE_bmi <- file.path(dir_results, TargetSiteID, "BMI", dir.sub3)
    txt_grp_msg <- "Detailed weight of evidence data"
    fn_target2 <- paste0(TargetSiteID,"_BMI_WoE_ScoresTable.tab")
    fn_WoE_det  <- list.files(path = dir_WoE_bmi, full.names = TRUE
                                     , pattern = fn_target2)
    if (length(fn_WoE_det) == 0) {# No WoE file
      
      txt_NoFile <- "No detailed stressor-specific weight of evidence is available.\n"
      cat(txt_NoFile)      
      
    } else if (file.exists(fn_WoE_det[1]) == TRUE) {# WoE file exists
      
      msg_files <- paste0(txt_grp_msg," are found in the file '", fn_target2
                        , "' in the'", dir_WoE_bmi, "' folder.\n")
      
      df_det <- read.delim(file.path(dir_WoE_bmi, fn_target2), header = TRUE
                           , sep = "\t")
      
      df_det <- dplyr::select(df_det, -Cluster, -BioComm, -Stressor, -NumInSupport
                              , -NumInRefute, -NumInIndet, -NumInNotEval
                              , -NumOutSupport, -NumOutRefute, -NumOutIndet
                              , -NumOutNotEval, -StationID_Master)
      
      df_det <- as.data.frame(unique(df_det))
      
      df_det <- dplyr::rename(df_det, Stressor = Label
                              , ResponseSampleID = RespSampID
                              , ResponseSampleDate = RespSampDate
                              , Degraded = BioDeg
                              , Narrative = BioNarrative
                              , StressorSampleID = StressSampID
                              , StressorSampleDate = StressSampDate
                              , Group = StressorType
                              , PercentRank = StressorPctRank
                              , TS_Inside = TS_barplot
                              , SR_Inside_LogRegr = SR_InCase_LogRegr
                              , SR_Inside_LinRegr = SR_InCase_LinRegr
                              , SR_Outside_LinRegr = SR_OutCase_LinRegr
                              , VP_SensitiveTaxa = VP_boxplot_senstaxa
                              , VP_TolerantTaxa = VP_boxplot_toltaxa)
      
      df_det <- dplyr::mutate(df_det
                              , SiteID = TargetSiteID
                              , CSCI = round(CSCI,3)
                              , PercentRank = round(PercentRank, 3)
                              , StressorValue = ifelse(StressorValue < 1
                                                       , format(StressorValue
                                                               , digits = 3)
                                                , ifelse(StressorValue < 10
                                                       , format(StressorValue
                                                               , digits = 2)
                                                , ifelse(StressorValue < 100
                                                       , format(StressorValue
                                                               , digits = 1
                                                               , scientific = FALSE)
                                                       , format(StressorValue
                                                               , digits = 0
                                                               , big.mark = ","))))
                              , Blank1 = NA
                              , Blank2 = NA)

      df_det <- dplyr::select(df_det, SiteID, Degraded, Narrative, CSCI
                              , ResponseSampleDate, ResponseSampleID, StressorSampleDate
                              , StressorSampleID, Group, Stressor, StressorValue
                              , PercentRank, WoE, TS_Inside, CO_boxplot
                              , SR_Inside_LogRegr, SR_Inside_LinRegr
                              , VP_SensitiveTaxa, VP_TolerantTaxa, Blank1
                              , SR_Outside_LinRegr, SSD_ToxicityCurve, Blank2
                              , TotSupport, TotRefute, TotIndet, TotNotEval)
  
      df_det <- dplyr::arrange(df_det, desc(Degraded), desc(CSCI), StressorSampleDate
                              , ResponseSampleID, StressorSampleID, Group
                              , Stressor, StressorValue)
    
      if (report_format == "html") {
          
        tblCaption <- paste0("<h5><em>", txt_grp_msg, ".</em></h5>")
        cat(tblCaption)
    
        sketch <- htmltools::withTags(table(
          class = 'display'
          , thead(
            tr(
              th(rowspan = 3, 'Site')
              , th(rowspan = 3, 'Degraded')
              , th(rowspan = 3, 'Condition Narrative')
              , th(rowspan = 3, 'CSCI')
              , th(rowspan = 3, 'BMI Sample Date')
              , th(rowspan = 3, 'BMI Sample ID')
              , th(colspan = 6, 'Stressor')
              , th(rowspan = 3, 'Overall Weight of Evidence')
              , th(colspan = 6, 'Inside the Case')
              , th(rowspan = 3, '')
              , th(colspan = 2, 'Outside the Case')
              , th(rowspan = 3, '')
              , th(colspan = 4, "Total Lines of Evidence")
            )
            , tr(
              th(rowspan = 2, 'Sample Date')
              , th(rowspan = 2, 'Sample ID')
              , th(rowspan = 2, 'Group')
              , th(rowspan = 2, 'Name')
              , th(rowspan = 2, 'Value')
              , th(rowspan = 2, 'Percent Rank')
              , th(rowspan = 2, 'Time Sequence')
              , th(rowspan = 2, 'Co-occurrence')
              , th(rowspan = 2, 'Stressor-response')
              , th(rowspan = 2, 'Biological Gradient')
              , th(colspan = 2, 'Verified Prediction')
              , th(rowspan = 2, 'Biological Gradient')
              , th(rowspan = 2, 'Taxon Sensitivity Distribution')
              , th(rowspan = 2, 'Supporting')
              , th(rowspan = 2, 'Refuting')
              , th(rowspan = 2, 'Indeterminate')
              , th(rowspan = 2, 'Not evaluated')
            )
            , tr(
                lapply(c('Sensitive Taxa', 'Tolerant Taxa'), th)
            )
          )
        ))
        
        
        if (nrow(df_det) <= 10) {
          DT::datatable(df_det
                        , container = sketch
                        , extensions = 'FixedColumns'
                        , options = list(dom = 'ti'
                                         , pageLength = 10
                                         , bSort = FALSE
                                         , scrollX = TRUE
                                         , fixedColumns = list(leftColumns = 1)
                                         , autoWidth = TRUE
                                         , columnDefs = list(list(className = 'dt-left'
                                                                 , targets = c(8,9))
                                                             , list(className = 'dt-center'
                                                                 , targets = c(1:7,10:26))
                                                             , list(className = 'dt-bottom'
                                                                    , targets = "_all")))
                        , class = 'striped hover row-border'
                        , filter = 'none'
                        , rownames = FALSE) %>%
            DT::formatStyle(columns = colnames(df_det), fontSize = '85%') %>%
            DT::formatStyle("Stressor", "white-space" = "nowrap") %>%
            DT::formatStyle("StressorSampleID", "white-space" = "nowrap")
        } else {
          DT::datatable(df_det
                        , container = sketch
                        , extensions = 'FixedColumns'
                        , options = list(dom = 'lftip'
                                         , pageLength = 10
                                         , bSort = FALSE
                                         , scrollX = TRUE
                                         , fixedColumns = list(leftColumns = 1)
                                         , autoWidth = TRUE
                                         , lengthMenu = ifelse(nrow(df_det) > 10
                                                               , c(10, 25, 50, 100)
                                                               , 10)
                                         , columnDefs = list(list(className = 'dt-left'
                                                                 , targets = c(8,9))
                                                             , list(className = 'dt-center'
                                                                 , targets = c(1:7,10:26))
                                                             , list(className = 'dt-bottom'
                                                                    , targets = "_all")))
                        , class = 'striped hover row-border'
                        , filter = 'none'
                        , rownames = FALSE) %>%
            DT::formatStyle(columns = colnames(df_det), fontSize = '85%') %>%
            DT::formatStyle("Stressor", "white-space" = "nowrap") %>%
            DT::formatStyle("StressorSampleID", "white-space" = "nowrap")
        }
      
      } else {
        
        msg <- "Not displayed in non-html format."
        cat(msg)
        
      }
        
    } else {# No WoE file
      cat(txt_NoFile)
    }

} else {# UseBMI != TRUE
    cat(paste0("No benthic macroinvertebrate data are available for ", TargetSiteID,".\n"))
}

```

# **ALGAE RESULTS**

## *Biological Index Distributions*

```{r alg_box, out.width = "70%", out.extra = 'style = "padding:10px"'}

if (useAlg == TRUE) {
    dir.sub3 <- "SiteInfo"
    #TargetSiteID <- "SRCKN001.61"
    myBMIbox <- paste0(TargetSiteID,"_ALGAE_IndexBoxplots.png")
    fn_img <- file.path(dir_results, TargetSiteID, dir.sub3, myBMIbox)
    if (file.exists(fn_img) == TRUE) {
      knitr::include_graphics(fn_img)
    } else {
      cat("Algae index distributions are not available.\n")
    }
} else {
    cat(paste0("No algal data are available for ", TargetSiteID,".\n"))
}

```

## *Comparator Site Information*

```{r algcompsiteinfo}
# Read file summarizing the comparator data and provide it in summary form

if (useAlg == TRUE) {
    dir.sub3 <- "SiteInfo"
    mycomps <- paste0(TargetSiteID,"_ALGAE_SiteQualities.tab")
    fn_comps <- file.path(dir_results, TargetSiteID, dir.sub3, mycomps)
    msg_info <- paste(paste0("Comparator site information, including a list "
                       , "of comparator sites, can be found in the '"
                       , paste(paste0("Results/",TargetSiteID,"/BMI/",dir.sub3)
                       , "' folder."))
                       , paste0("<em>Numbers of sites by type (Comparator, "
                                , "cluster, or entire dataset), "
                                , "type (all samples or only those "
                                , "having better biology than those "
                                , "from the target site) and quality.</em>"), ""
                       , sep = "\n\n")
    
    if (file.exists(fn_comps) == TRUE) {
      
        dfcomps <- read.delim(fn_comps, header = TRUE, sep = "\t")
        dfcomps <- dplyr::select(dfcomps, -BioComm)
      
        cat(msg_info)
        
        tcomps <- knitr::kable(dfcomps, format = report_format
                               , colnames = colnames(dfcomps))
        tcomps <- kableExtra::kable_styling(tcomps
                                            , bootstrap_options = "condensed"
                                            , font_size = 12, full_width = FALSE
                                            , position = "left")
        tcomps <- kableExtra::column_spec(tcomps, column = 1, bold = TRUE)
        tcomps <- kableExtra::collapse_rows(tcomps, columns = 1:2, valign = "top")
        tcomps
        
    } else {
      
      cat("No comparator site information is available for algae.\n")
      
    }
    
} else {
  
    cat(paste0("No algal data are available for ", TargetSiteID,".\n"))
  
}

```

## *Weight of Evidence*

### Overall Findings

The table below displays the scores for each line of evidence and overall weight of evidence, weighted by number of stressors in each group. Overall weight of evidence scores include:

* 1 indicates that all evaluated lines of evidence for all observed stressors in the group support the group as a cause of impairment
* -1 indicates that all evaluated lines of evidence for all observed stressors in the group refute the group as a cause of impairment
* 0 indicates that the evaluated lines of evidence for the observed stressors in the group are indeterminate regarding cause of impairment
* NE indicates that the stressor group was not evaluated

Inside refers to evidence from data inside the case, and outside refers to evidence from data outside the case. Data from inside the case includes `r ifelse(useBC == TRUE, msg1, msg2)` Taxon sensitivity curves rely on laboratory toxicity tests and therefore represent data from outside the case.

```{r WoEsummary_alg}

if (useAlg == TRUE) {
    dir.sub3 <- "WoE"
    dir_WoE_alg <- file.path(dir_results, TargetSiteID, "ALGAE", dir.sub3)
    txt_grp_msg <- "Overall summary weight of evidence data"
    fn_target1 <- paste0(TargetSiteID,"_ALGAE_WoE_ExecSummary.tab")
    fn_WoE_ES  <- list.files(path = dir_WoE_alg, full.names = TRUE
                                     , pattern = fn_target1)
    if (length(fn_WoE_ES) == 0) {# No WoE file for Algae
      
      txt_NoFile <- paste0("No ", tolower(txt_grp_msg)," exist.\n")
      cat(txt_NoFile)      
      
    } else if (file.exists(fn_WoE_ES[1]) == TRUE) {# WoE file for Algae
      
      msg_files <- paste0(txt_grp_msg," are found in the file '", fn_target1
                        , "' in the'", dir_WoE_alg, "' folder.\n")

      df_ES <- read.delim(file.path(dir_WoE_alg, fn_target1), header = TRUE
                          , sep = "\t")
      
      df_ES <- dplyr::select(df_ES, -BioComm, BioDeg, StressorType, NumStressSamples
                             , NumStressors, WtTot_WoE, WtTotTS_barplot, WtTotCO_boxplot
                             , WtTotSR_InCase_LogRegr, WtTotSR_InCase_LinRegr
                             , WtTotSR_OutCase_LinRegr, WtTotVP_boxplot)
      
      df_ES$Blank1 <- NA
      
      df_ES <- dplyr::rename(df_ES, SiteID = StationID_Master
                             , Degraded = BioDeg
                             , Group = StressorType
                             , Stressor_Samples = NumStressSamples
                             , Stressors = NumStressors
                             , Overall_WoE = WtTot_WoE
                             , TS_Inside = WtTotTS_barplot
                             , CO_boxplot = WtTotCO_boxplot
                             , SR_Inside_LogRegr = WtTotSR_InCase_LogRegr
                             , SR_Inside_LinRegr = WtTotSR_InCase_LinRegr
                             , SR_Outside_LinRegr = WtTotSR_OutCase_LinRegr
                             , VP_Boxplot = WtTotVP_boxplot)
      
      df_ES <- dplyr::select(df_ES
                             , SiteID
                             , Degraded
                             , Group
                             , Stressor_Samples
                             , Stressors
                             , Overall_WoE
                             , TS_Inside
                             , CO_boxplot
                             , SR_Inside_LogRegr
                             , SR_Inside_LinRegr
                             , VP_Boxplot
                             , Blank1
                             , SR_Outside_LinRegr)
      
      if (report_format == "html") {# Generate DT table for HTML report format
          
        tblCaption <- paste0("<h5><em>", txt_grp_msg, ".</em></h5>")
        cat(tblCaption)
    
        sketch <- htmltools::withTags(table(
          class = 'display'
          , thead(
            tr(
              th(rowspan = 2, 'Site')
              , th(rowspan = 2, 'Degraded')
              , th(rowspan = 2, 'Stressor Group')
              , th(rowspan = 2, 'Num. Stressor Samples')
              , th(rowspan = 2, 'Num. Stressors')
              , th(rowspan = 2, 'Overall Weight of Evidence')
              , th(colspan = 5, 'Inside the Case')
              , th(rowspan = 2, '')
              , th(colspan = 1, 'Outside the Case')
            )
            , tr(
                lapply(c('Time Sequence', 'Co-occurrence', 'Stressor-response'
                         , 'Biological gradient', 'Verified prediction'
                         , 'Biological gradient'), th)
            )
          )
        ))
        
        if (nrow(df_ES) <= 10) {# Num WoE rows <11
          DT::datatable(df_ES
                        , container = sketch
                        , extensions = 'FixedColumns'
                        , options = list(dom = 'ti'
                                         , pageLength = 10
                                         , bSort = FALSE
                                         , scrollX = TRUE
                                         , fixedColumns = list(leftColumns = 1)
                                         , autoWidth = TRUE
                                         , columnDefs = list(list(width = '140px'
                                                                  , targets = 1)
                                                             , list(className = 'dt-left'
                                                                    , targets = 2)
                                                             , list(className = 'dt-center'
                                                                    , targets = c(0:1,3:12))
                                                             , list(className = 'dt-bottom'
                                                                    , targets = '_all')))
                        , class = 'striped hover row-border'
                        , filter = 'none'
                        , rownames = FALSE) %>%
            DT::formatStyle(columns = colnames(df_ES), fontSize = '85%')
          
        } else {# Num WoE rows >10
          
          DT::datatable(df_ES
                        , container = sketch
                        , extensions = 'FixedColumns'
                        , options = list(dom = 'lftip'
                                         , pageLength = 10
                                         , bSort = FALSE
                                         , scrollX = TRUE
                                         , fixedColumns = list(leftColumns = 1)
                                         , autoWidth = TRUE
                                         , lengthMenu = ifelse(nrow(df_ES) > 10
                                                               , c(10, 25, 50, 100)
                                                               , 10)
                                         , columnDefs = list(list(width = '140px'
                                                                  , targets = 1)
                                                             , list(className = 'dt-left'
                                                                    , targets = 2)
                                                             , list(className = 'dt-center'
                                                                    , targets = c(0:1,3:12))
                                                             , list(className = 'dt-bottom'
                                                                    , targets = '_all')))
                        , class = ' striped hover row-border'
                        , filter = 'none'
                        , rownames = FALSE) %>%
            DT::formatStyle(columns = colnames(df_ES), fontSize = '85%')
        }
      
      } else {# Report format selected is not HTML
        
        msg <- "Not displayed in non-html format."
        cat(msg)
        
      }
        
        
    } else {# No WoE file for algae
      cat(txt_NoFile)
    }
} else {# useAlg != TRUE
    cat(paste0("No algae data are available for ", TargetSiteID,".\n"))
}
```

### Stressor-Specific Scores

The table below shows scores for each stressor identified in one or more samples obtained from the bioassessment site `r TargetSiteID`, along with each line of evidence Scores for each line of evidence include:

* 1 for evidence supporting the stressor as a cause of impairment
* -1 for evidence refuting the stressor as a cause of impairment
* 0 for indeterminate evidence
* NE for not evaluated

```{r WoEscores_alg}

if (useAlg == TRUE) {
    dir.sub3 <- "WoE"
    dir_WoE_alg <- file.path(dir_results, TargetSiteID, "ALGAE", dir.sub3)
    txt_grp_msg <- "Detailed weight of evidence data"
    fn_target2 <- paste0(TargetSiteID,"_ALGAE_WoE_ScoresTable.tab")
    fn_WoE_det  <- list.files(path = dir_WoE_alg, full.names = TRUE
                                     , pattern = fn_target2)
    if (length(fn_WoE_det) == 0) {
      txt_NoFile <- "No detailed stressor-specific weight of evidence is available.\n"
      cat(txt_NoFile)      
    } else if (file.exists(fn_WoE_det[1]) == TRUE) {
      msg_files <- paste0(txt_grp_msg," are found in the file '", fn_target2
                        , "' in the'", dir_WoE_alg, "' folder.\n")
      df_det <- read.delim(file.path(dir_WoE_alg, fn_target2), header = TRUE
                           , sep = "\t")
      df_det <- dplyr::select(df_det, -Cluster, -BioComm, -Stressor, -NumInSupport
                              , -NumInRefute, -NumInIndet, -NumInNotEval
                              , -NumOutSupport, -NumOutRefute, -NumOutIndet
                              , -NumOutNotEval, -StationID_Master)
      df_det <- as.data.frame(unique(df_det))
      df_det <- dplyr::rename(df_det, Stressor = Label
                              , ResponseSampleID = RespSampID
                              , ResponseSampleDate = RespSampDate
                              , Degraded = BioDeg
                              , Narrative = BioNarrative
                              , StressorSampleID = StressSampID
                              , StressorSampleDate = StressSampDate
                              , Group = StressorType
                              , PercentRank = StressorPctRank
                              , TS_Inside = TS_barplot
                              , SR_Inside_LogRegr = SR_InCase_LogRegr
                              , SR_Inside_LinRegr = SR_InCase_LinRegr
                              , SR_Outside_LinRegr = SR_OutCase_LinRegr
                              , VP_SensitiveTaxa = VP_boxplot_senstaxa
                              , VP_TolerantTaxa = VP_boxplot_toltaxa)
      df_det <- dplyr::mutate(df_det, MMIhybrid = round(MMIhybrid,3)
                              , PercentRank = round(PercentRank, 3)
                              , StressorValue = ifelse(StressorValue < 1
                                                       , format(StressorValue
                                                               , digits = 3)
                                                , ifelse(StressorValue < 10
                                                       , format(StressorValue
                                                               , digits = 2)
                                                , ifelse(StressorValue < 100
                                                       , format(StressorValue
                                                               , digits = 1
                                                               , scientific = FALSE)
                                                       , format(StressorValue
                                                               , digits = 0
                                                               , big.mark = ","))))
                              , Blank1 = NA
                              , Blank2 = NA
                              , SiteID = TargetSiteID)

      df_det <- dplyr::select(df_det, SiteID, Degraded, Narrative, MMIhybrid
                              , ResponseSampleDate, ResponseSampleID
                              , StressorSampleDate, StressorSampleID, Group
                              , Stressor, StressorValue, PercentRank, WoE
                              , TS_Inside, CO_boxplot, SR_Inside_LogRegr
                              , SR_Inside_LinRegr, VP_SensitiveTaxa
                              , VP_TolerantTaxa, Blank1, SR_Outside_LinRegr
                              , SSD_ToxicityCurve, Blank2, TotSupport
                              , TotRefute, TotIndet, TotNotEval)
  
      df_det <- dplyr::arrange(df_det, desc(Degraded), desc(MMIhybrid), StressorSampleDate
                              , ResponseSampleID, StressorSampleID, Group
                              , Stressor, StressorValue)
    
    if (report_format == "html") {
          
      tblCaption <- paste0("<h5><em>", txt_grp_msg, ".</em></h5>")
      cat(tblCaption)
    
      sketch <- htmltools::withTags(table(
        class = 'display'
        , thead(
          tr(
            th(rowspan = 3, 'Site')
            , th(rowspan = 3, 'Degraded')
            , th(rowspan = 3, 'Condition Narrative')
            , th(rowspan = 3, 'MMI Hybrid')
            , th(rowspan = 3, 'Algae Sample Date')
            , th(rowspan = 3, 'Algae Sample ID')
            , th(colspan = 6, 'Stressor')
            , th(rowspan = 3, 'Overall Weight of Evidence')
            , th(colspan = 6, 'Inside the Case')
            , th(rowspan = 3, '')
            , th(colspan = 2, 'Outside the Case')
            , th(rowspan = 3, '')
            , th(colspan = 4, "Total Lines of Evidence")
          )
          , tr(
            th(rowspan = 2, 'Sample Date')
            , th(rowspan = 2, 'Sample ID')
            , th(rowspan = 2, 'Group')
            , th(rowspan = 2, 'Name')
            , th(rowspan = 2, 'Value')
            , th(rowspan = 2, 'Percent Rank')
            , th(rowspan = 2, 'Time Sequence')
            , th(rowspan = 2, 'Co-occurrence')
            , th(rowspan = 2, 'Stressor-response')
            , th(rowspan = 2, 'Biological Gradient')
            , th(colspan = 2, 'Verified Prediction')
            , th(rowspan = 2, 'Biological Gradient')
            , th(rowspan = 2, 'Taxon Sensitivity Distribution')
            , th(rowspan = 2, 'Supporting')
            , th(rowspan = 2, 'Refuting')
            , th(rowspan = 2, 'Indeterminate')
            , th(rowspan = 2, 'Not evaluated')
          )
          , tr(
              lapply(c('Sensitive Taxa', 'Tolerant Taxa'), th)
          )
        )
      ))
      
      
      if (nrow(df_det) <= 10) {
        DT::datatable(df_det
                      , container = sketch
                      , extensions = 'FixedColumns'
                      , options = list(dom = 'ti'
                                       , pageLength = 10
                                       , bSort = FALSE
                                       , scrollX = TRUE
                                       , fixedColumns = list(leftColumns = 1)
                                       , autoWidth = TRUE
                                       , columnDefs = list(list(className = 'dt-left'
                                                               , targets = c(8,9))
                                                           , list(className = 'dt-center'
                                                               , targets = c(1:7,10:26))
                                                           , list(className = 'dt-bottom'
                                                                  , targets = "_all")))
                      , class = 'striped hover row-border'
                      , filter = 'none'
                      , rownames = FALSE) %>%
          DT::formatStyle(columns = colnames(df_det), fontSize = '85%') %>%
          DT::formatStyle("Stressor", "white-space" = "nowrap") %>%
          DT::formatStyle("StressorSampleID", "white-space" = "nowrap")
      } else {
        DT::datatable(df_det
                      , container = sketch
                      , extensions = 'FixedColumns'
                      , options = list(dom = 'lftip'
                                       , pageLength = 10
                                       , bSort = FALSE
                                       , scrollX = TRUE
                                       , fixedColumns = list(leftColumns = 1)
                                       , autoWidth = TRUE
                                       , lengthMenu = ifelse(nrow(df_det) > 10
                                                             , c(10, 25, 50, 100)
                                                             , 10)
                                       , columnDefs = list(list(className = 'dt-left'
                                                               , targets = c(8,9))
                                                           , list(className = 'dt-center'
                                                               , targets = c(1:7,10:26))
                                                           , list(className = 'dt-bottom'
                                                                  , targets = "_all")))
                      , class = 'striped hover row-border'
                      , filter = 'none'
                      , rownames = FALSE) %>%
          DT::formatStyle(columns = colnames(df_det), fontSize = '85%') %>%
          DT::formatStyle("Stressor", "white-space" = "nowrap") %>%
          DT::formatStyle("StressorSampleID", "white-space" = "nowrap")
      }
    
    } else {
      
      msg <- "Not displayed in non-html format."
      cat(msg)
      
    }
        
    } else {
      cat(txt_NoFile)
    }

} else {
    cat(paste0("No algae data are available for ", TargetSiteID,".\n"))
}

```

# **DATA GAPS**
```{r datagaps}
dir_gaps <- file.path(dir_results, TargetSiteID)
fn_gaps <- file.path(dir_gaps, paste0(TargetSiteID,"_datagaps.tab"))
df_gaps <- read.delim(fn_gaps, header = TRUE, sep = "\t")

dfgen <- dplyr::filter(df_gaps, fxnname == "general")
dfpairs <- dplyr::filter(df_gaps, fxnname == "getCoOccurDataset")
dfoutliers <- dplyr::filter(df_gaps, fxnname == "Comparator outliers")
dflimitdata <- dplyr::filter(df_gaps, fxnname == "getStressorList")

if (any(dfpairs$result == 0)) {
    nopairs <- dfpairs %>%
        dplyr::filter(result == 0) %>%
        dplyr::select(comment)
    nopairs <- unique(as.vector(nopairs))
    for (sr in 1:length(nopairs)) {
        tempmsg <- nopairs[sr]
        if (sr == 1) {
            msgNoPairs <- tempmsg
        } else {
            msgNoPairs <- c(msgNoPairs, tempmsg)
        }
    }
    rm(tempmsg)
    msgNoPairs <- as.character(msgNoPairs$comment)
    cat(msgNoPairs)
}


if (any(dfgen$result == 0)) {
    nodatacond <- dfgen %>%
        dplyr::filter(result == 0) %>%
        dplyr::select(condition)
    nodatacond <- unique(as.vector(nodatacond$condition))
    
    for (c in 1:length(nodatacond)) {
        
        cond <- nodatacond[c]
        tempmsg <- switch(cond
                          , "ChemStress" = paste0("No laboratory or field chemistry "
                                                , "data are available for "
                                                , TargetSiteID)
                          , "HabStress" = paste0("No physical habitat data are "
                                               ,"available for ", TargetSiteID)
                          , "useModStress" = paste0("No modeled flow data are "
                                                  ,"available for ", TargetSiteID)
                          , "useBMI" = paste0("No benthic macroinvertebrate response "
                                            , "data are available for ", TargetSiteID)
                          , "useALG" = paste0("No algal community response data "
                                            , "are available for ", TargetSiteID))
        
        if (c == 1) {
            msgnodata <- tempmsg
        } else {
            msgnodata <- c(msgnodata, tempmsg)
        }
    
    }
    
    msgnodata <- as.data.frame(msgnodata)
    
    nodatacaption <- "Missing stressor or response data"
    tnodata <- knitr::kable(msgnodata
                            , format = report_format
                            , caption = nodatacaption
                            , col.names = "Data type")
    tnodata <- kableExtra::kable_styling(tnodata
                                         , bootstrap_options = "condensed"
                                         , font_size = 12)
    tnodata

} else {
    
    msgnodata <- paste0("All stressor and response data types are available for "
                        , TargetSiteID, ".\n\n")
    cat(msgnodata)
    
}

if (nrow(dflimitdata) > 0) {
    limdatacaption <- paste0("Limited data were available from comparator "
                             , "samples for the following stressors identified at "
                             , TargetSiteID, ". No evaluation is possible.")
    
    dflimitdata <- dflimitdata %>%
        dplyr::select(condition, result, comment) %>%
        dplyr::rename(Stressor = condition
                      , NumberPairedSamples = result
                      , Finding = comment)
    dflimitdata <- unique(as.data.frame(dflimitdata, row.names = NULL))

    tlimit <- knitr::kable(dflimitdata
                           , format = report_format
                           , caption = limdatacaption
                           , col.names = colnames(dflimitdata))
    tlimit <- kableExtra::kable_styling(tlimit
                                        , bootstrap_options = "condensed"
                                        , font_size = 12)
    tlimit

}

if (nrow(dfoutliers) > 0) {
    
    dfoutliers <- dplyr::select(dfoutliers, -fxnname)
    dfoutliers$ComparatorSiteID <- stringr::str_extract(dfoutliers$comment
                                                        , "^[A-Z0-9]*")
    dfoutliers <- unique(as.data.frame(dfoutliers, row.names = NULL)) %>% 
        dplyr::rename(Stressor = condition, StressorValue = result) %>%
        dplyr::select(ComparatorSiteID, Stressor, StressorValue) %>%
        dplyr::arrange(ComparatorSiteID, Stressor)
    # dfoutliers <- unique(as.data.frame(dfoutliers, row.names = NULL))
    outcaption <- paste0("Comparator site outliers that were removed. "
                         , "Values were transformed prior to evaluating "
                         , "for outliers as necessary.")

    toutlier <- knitr::kable(dfoutliers
                             , format = report_format
                             , caption = outcaption
                             , col.names = colnames(dfoutliers))
    toutlier <- kableExtra::kable_styling(toutlier
                                          , bootstrap_options = "condensed"
                                          , font_size = 12)
    toutlier

} else {
    
    msgnooutliers <- "No outliers were identified among the comparator samples.\n\n"
    cat(msgnooutliers)
    
}


```




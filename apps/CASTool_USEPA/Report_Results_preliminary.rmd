---
title: "Preliminary Report"
subtitle: "CASTool"
author: "`r Sys.getenv('USERNAME')`"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
  word_document:
    toc: yes
  pdf_document:
    toc: true
---

<!-- #  Copyright 2021 TetraTech. All rights reserved. -->
<!-- #  Use, copying, modification, or distribution of this file or any of its contents  -->
<!-- #  is expressly prohibited without prior written permission of TetraTech. -->

<!-- # Embed logo -->
<img src="CASTool.svg" style="position:absolute; top:0px; right:0px; padding:10px;" />

<!-- # Add css for vertical alignment of table header cells -->
<head>
  <style type="text/css">
    .dt-top {vertical-align: top;}
    .dt-middle {vertical-align: middle;}
    .dt-bottom {vertical-align: bottom;}
  </style>
</head>

```{r setup, include = FALSE}
knitr::opts_chunk$set(results = 'asis', echo = FALSE, warning = FALSE)
# Debugging
boo.DEBUG <- FALSE
DEBUG.CaseNumber <- 1
#
# Define pipe and not_all_na
`%>%` <- dplyr::`%>%`
not_all_na <- function(x) {!all(is.na(x))}

# Define breaks and labels for CSCI narrative rating
BioNarBrk <- c(-2, 0.62, 0.799, 0.919, 2)
BioNarLab <- c("very likely altered", "likely altered", "possibly altered "
               , "likely intact")

# Identify file containing stressor field names and labels
fn_stresslabs <- "SMC_AllStressInfo.tab"

# Identify all parameters used in the bulk run conducted by TT in March 2021 
probsHigh <- 0.75
probsLow <- 0.25
# useBMI <- TRUE # Determined from results data
# useAlg <- TRUE # Determined from results data
useBC <- TRUE # Use Bray-Curtis biological dissimilarity distance matrix
removeOutliers <- TRUE
DOlim     <- 7
pHlimLow  <- 6.5
pHlimHigh <- 9
lagdays <- 10
bmiIndex <- "CSCI"
algIndex <- "MMIhybrid"
algIndexTxt <- "MMI Hybrid"
# report_type <- "preliminary"
report_format <- "html"
siteQual2Plot <- stringr::str_to_sentence("not degraded") # options:"reference","better than", "not degraded"

#
if (boo.DEBUG == TRUE) {##IF.boo.DEBUG.START
  if (DEBUG.CaseNumber == 1) {##IF.DEBUG.CaseNumber.START
    TargetSiteID <- "402BA0031"
    dir_data <- "C:/Users/ann.lincoln/Documents/SEP_CAST/Data"
    dir_results <- "C:/Users/ann.lincoln/Documents/SEP_CAST/Results"
  }##IF.DEBUG.CaseNumber.END
}##IF.boo.DEBUG.END



```

# **REPORT INFORMATION**

```{r report_date}
  # myReportDate <- format(Sys.time(), "%Y-%m-%d %H:%M:%S")
  # cat(paste("**Report Date and Time:** ", myReportDate, "\n\n", sep = ""))
  # myUser <- Sys.getenv("USERNAME")
  # cat(paste("**Generated By:** ", myUser, "\n\n", sep = ""))
  # # cat(paste("**CASTfxn Package Version:** ",packageVersion("CASTfxn"),"\n\n",sep=""))
  
  cat("**Selected parameters:**\n\n")
  cat(paste("\tRemove outliers? ", removeOutliers, "\n", sep = ""))
  cat(paste("\tUse expected biological similarity filter? ", useBC, "\n"
            , sep = ""))
  cat(paste("\tNumber of days lag time between stressor and response sample collection = "
            , lagdays, "\n", sep = ""))
  cat(paste("\tQuality of site displayed on analysis graphics? ", siteQual2Plot
            , "\n", sep = ""))
  cat(paste("\tLower and upper percentiles for identifying stressors = ", probsLow
            , "-", probsHigh, "\n", sep = ""))
  cat(paste("\tLimit above which DO is not identified as a stressor = ", DOlim
            , "\n", sep = ""))
  cat(paste("\tLimits between which pH is not identified as a stressor = "
            , pHlimLow, " and ", pHlimHigh, "\n\n", sep = ""))

```

# **DISCLAIMER**

The CASTool is a screening tool. It is intended to assist the City of San Diego and its agents to rapidly screen and assist with identifying causes of biological impairment. Due the tool's reliance on currently available and sometimes incomplete data, however, it is not intended to be a final arbiter on assessment analyses, nor does it represent any commitments by the City to perform any specific projects, studies, or other actions.

The most reliable results correspond with stressors for which many recent results are available and for which all lines of evidence used in this tool demonstrate similar results. If this screening-level analysis shows supporting evidence for a stressor as a cause of impairment, additional evaluation is warranted.

Stressors for which little data exists may or may not be identified as potential stressors by the CASTool and should be treated with caution. Moreover, care should be taken when using results based on data collected several years ago; those data (and therefore the results of the CASTool) may not reflect current conditions. 

Additional information on causal assessment is available in EPA's Stressor Identification Guidance Document. (U.S. Environmental Protection Agency. (2000). Stressor Identification Guidance Document. (EPA/822/B-00/025). Cincinnati, OH: U.S. Environmental Protection Agency, Office of Water, Office of Research and Development, National Exposure Research Laboratory) 

# **Target Site: `r TargetSiteID`**

```{r SiteID, echo=FALSE}

  df_stresslabs <- read.delim(file.path(dir_data, fn_stresslabs), header = TRUE
                              , sep = "\t")
  df_stresslabs <- unique(df_stresslabs[,c("Analyte", "Label")])

```

## *Site Sample Summary*

The table below lists any samples collected from `r TargetSiteID` over time. Red index scores indicate degraded biological quality for benthic macroinvertebrates (`r bmiIndex`) or algae (`r algIndexTxt`).

```{r sampsummary}

# Read file summarizing the comparator data and provide it in summary form
fnSamps <- file.path(dir_data,"SMCSiteSummary.tab")
dfSamps <- read.delim(fnSamps, header = TRUE, sep = "\t")
dfSamps <- dfSamps[dfSamps$StationID_Master == TargetSiteID,]
row.names(dfSamps) <- NULL

# Get sample data
if (nrow(dfSamps) > 0) {# Samples exist for target site
  
  dfSamps <- dplyr::select(dfSamps, -SampYear) %>%
      dplyr::rename(Cluster = clust, SampleDate = SampDate) %>%
      dplyr::mutate(SampleDate = lubridate::mdy(SampleDate))
  sampColNames <- colnames(dfSamps)
  coreColNames <- c("StationID_Master", "COMID", "Cluster", "SampleDate")
  sampColNames <- setdiff(sampColNames, coreColNames)
  
  # Check for BMI samples
  if (not_all_na(dfSamps$BMISampID)) {
    
    fnBMI <- file.path(dir_data,"SMCBenthicMetricsFinal.tab")
    dfBMI <- read.delim(fnBMI, header = TRUE, sep = "\t")
    dfBMI <- dfBMI %>% 
        dplyr::filter(StationID_Master == TargetSiteID) %>%
        dplyr::select(StationID_Master, BMISampID, all_of(bmiIndex))
    
    # Check for BMI index values
    if (nrow(dfBMI) > 0) { # There are BMI Index values
      
        dfSamps <- merge(dfSamps, dfBMI
              , by.x = c("StationID_Master","BMISampID")
              , by.y = c("StationID_Master","BMISampID")
              , all.x = TRUE)
        
    } else {# There are no BMI Index values, so add col and set all to NA
      
        dfSamps <- dfSamps %>% dplyr::mutate(BMI.Index = NA)
        colnames(dfSamps[,BMI.Index]) <- bmiIndex
    }
    
    dfSamps[[bmiIndex]] <- ifelse(is.na(dfSamps[[bmiIndex]])
                                  , NA
                                  , round(dfSamps[[bmiIndex]], 3))
    rm(fnBMI, dfBMI)

  } else {# There are no bmi samples
    
    dfSamps[[bmiIndex]] <- NA
    
  }
  
  # Check for algae samples
  if (not_all_na(dfSamps$AlgSampID)) {# There are algal samples
    
    fnAlg <- file.path(dir_data,"SMCAlgaeMetricsFinal.tab")
    dfAlg <- read.delim(fnAlg, header = TRUE, sep = "\t")
    dfAlg <- dfAlg %>% 
        dplyr::filter(StationID_Master == TargetSiteID) %>%
        dplyr::select(StationID_Master, AlgSampID, eval(algIndex))
    
    # Check for algal index data
    if (nrow(dfAlg) > 0) { # There are Algae Index values
      
        dfSamps <- merge(dfSamps, dfAlg
              , by.x = c("StationID_Master","AlgSampID")
              , by.y = c("StationID_Master","AlgSampID")
              , all.x = TRUE)
        
    } else {# There are no Alg Index values, so add col and set all to NA
      
        dfSamps <- dplyr::mutate(dfSamps, Alg.Index = NA)
        colnames(dfSamps[, Alg.Index]) <- algIndex
        
    }
    
    dfSamps[[algIndex]] <- ifelse(is.na(dfSamps[[algIndex]])
                                  , NA
                                  , round(dfSamps[[algIndex]], 3))
    rm(fnAlg, dfAlg)

  } else {# There are no algal samples
    dfSamps[[algIndex]] <- NA
  }
  
  dfSamps <- dfSamps %>%
  dplyr::select(all_of(coreColNames), all_of(bmiIndex)
                  , all_of(algIndex), all_of(sampColNames)) %>%
  dplyr::arrange(SampleDate)

  if (report_format == "html") {
    
      tblColNames <- c("Site", "Reach", "Cluster", "Sample Date", "CSCI"
                   , "MMI Hybrid", "Lab Chemistry Sample ID", "Habitat Sample ID"
                   , "Field Chemistry Sample ID", "Modeled Flow ID"
                   , "BMI Sample ID", "Algae Sample ID", "Epiphyte Sample ID"
                   , "Integrated Algae Sample ID", "Macroalgae Sample ID"
                   , "Microalgae Sample ID")
      
      tblCaption <- paste0("<h5><em>Samples collected from ", TargetSiteID,".</em></h5>")
    
      cat(tblCaption)

    if (nrow(dfSamps) <= 10) {
      
      DT::datatable(dfSamps
                    , extensions = 'FixedColumns'
                    , options = list(dom = 'ti'
                                     , pageLength = 10
                                     , bSort = FALSE
                                     , scrollX = TRUE
                                     , fixedColumns = TRUE
                                     , columnDefs = list(list(className = 'dt-center'
                                                             , targets = '_all')
                                                         , list(className = 'dt-bottom'
                                                             , targets = '_all')))
                    , colnames = tblColNames
                    , class = 'striped hover row-border'
                    , filter = 'none'
                    , rownames = FALSE) %>%
        DT::formatStyle(columns = colnames(dfSamps), fontSize = '85%') %>%
        DT::formatStyle('CSCI', color = DT::styleInterval(0.79, c('red', 'black'))
                        , fontWeight = DT::styleInterval(0.79, c('bold', 'normal'))) %>%
        DT::formatStyle('MMIhybrid', color = DT::styleInterval(0.82, c('red', 'black'))
                        , fontWeight = DT::styleInterval(0.82, c('bold', 'normal'))) %>%
        DT::formatStyle(c("ChemSampleID","PhabSampID", "FldChemSampID", "FlowSampID"
                          , "BMISampID", "AlgSampID", "EpiphyteSampID", "IntegAlgSampID"
                          , "MacroalgSampID", "MicroalgSampID"), "white-space" = "nowrap")

    } else {
      
      DT::datatable(dfSamps
                    , extensions = 'FixedColumns'
                    , options = list(dom = 'lftip'
                                     , pageLength = 10
                                     , bSort = FALSE
                                     , scrollX = TRUE
                                     , fixedColumns = TRUE
                                     , columnDefs = list(list(className = 'dt-center'
                                                             , targets = '_all')
                                                         , list(className = 'dt-bottom'
                                                             , targets = '_all')))
                    , colnames = tblColNames
                    , class = 'striped hover row-border'
                    , filter = 'none'
                    , rownames = FALSE) %>%
        DT::formatStyle(columns = colnames(dfSamps), fontSize = '85%') %>%
        DT::formatStyle('CSCI', color = DT::styleInterval(0.79, c('red', 'black'))
                        , fontWeight = DT::styleInterval(0.79, c('bold', 'normal'))) %>%
        DT::formatStyle('MMIhybrid', color = DT::styleInterval(0.82, c('red', 'black'))
                        , fontWeight = DT::styleInterval(0.82, c('bold', 'normal')))
    }
  
  } else {
    
    msg <- "Not displayed in non-html format."
    cat(msg)
    
  }

} else {
  
  cat(paste0("No sample data for ", TargetSiteID))
  
}

        

```

## *Benthic Macroinvertebrate Results*

### Overall Weight of Evidence

The table below displays the scores for each line of evidence and overall weight of evidence, weighted by number of stressors in each group. Overall weight of evidence scores include:

* 1 indicates that all evaluated lines of evidence for all observed stressors in the group support the group as a cause of impairment
* -1 indicates that all evaluated lines of evidence for all observed stressors in the group refute the group as a cause of impairment
* 0 indicates that the evaluated lines of evidence for the observed stressors in the group are indeterminate regarding cause of impairment
* NE indicates that the stressor group was not evaluated

```{r in_out_msg}

msg1 <- "site samples and comparator samples, whereas data from outside the case include the site samples and cluster samples."
  
msg2 <- "site samples and cluster samples, whereas data from outside the case include the site samples and all other samples in the dataset."
  
```

Inside refers to evidence from data inside the case, and outside refers to evidence from data outside the case. Data from inside the case includes `r ifelse(useBC == TRUE, msg1, msg2)` Taxon sensitivity curves rely on laboratory toxicity tests and therefore represent data from outside the case.

```{r WoESummaryBMI}

fn_WoE_ES <- file.path(dir_results
                        , max(list.files(dir_results, pattern = "OverallWoESummary")))

df_WoE_ES <- read.delim(fn_WoE_ES, header = TRUE, sep = "\t")
df_WoE_ES <- df_WoE_ES %>%
  dplyr::filter(StationID_Master == TargetSiteID)

if (nrow(df_WoE_ES) > 0) {# TargetSite exists in overall WoE
  
  # Subset for BMI and for Algae
  df_BMI_ES <- df_WoE_ES %>%
    dplyr::filter(BioComm == "BMI")
  
  if (nrow(df_BMI_ES) == 0) {# No BMI stressors
    boo_BMI <- FALSE
  } else {# BMI stressors exist
    boo_BMI <- TRUE
  }
  
  df_ALG_ES <- df_WoE_ES %>%
    dplyr::filter(BioComm == "ALGAE")
  
  if (nrow(df_ALG_ES) == 0) {# No BMI stressors
    boo_ALG <- FALSE
  } else {# BMI stressors exist
    boo_ALG <- TRUE
  }

  
} else {# TargetSite does not exist in overall WoE
  
  txt_NoData <- "No stressors were identified."
  boo_BMI <- FALSE
  boo_ALG <- FALSE

}


if (boo_BMI == TRUE) {

  df_BMI_ES <- dplyr::select(df_BMI_ES, -BioComm, BioDeg, StressorType, NumStressSamples
                             , NumStressors, Overall_WoE, WtTotTS_barplot, WtTotCO_boxplot
                             , WtTotSR_InCase_LogRegr, WtTotSR_InCase_LinRegr
                             , WtTotSR_OutCase_LinRegr, WtTotVP_boxplot)
  df_BMI_ES$Blank1 <- NA
  df_BMI_ES <- dplyr::rename(df_BMI_ES, SiteID = StationID_Master
                         , Degraded = BioDeg
                         , Group = StressorType
                         , Stressor_Samples = NumStressSamples
                         , Stressors = NumStressors
                         , TS_Inside = WtTotTS_barplot
                         , CO_boxplot = WtTotCO_boxplot
                         , SR_Inside_LogRegr = WtTotSR_InCase_LogRegr
                         , SR_Inside_LinRegr = WtTotSR_InCase_LinRegr
                         , SR_Outside_LinRegr = WtTotSR_OutCase_LinRegr
                         , VP_Boxplot = WtTotVP_boxplot)
  df_BMI_ES <- dplyr::select(df_BMI_ES
                             , SiteID
                             , Degraded
                             , Group
                             , Stressor_Samples
                             , Stressors
                             , Overall_WoE
                             , TS_Inside
                             , CO_boxplot
                             , SR_Inside_LogRegr
                             , SR_Inside_LinRegr
                             , VP_Boxplot
                             , Blank1
                             , SR_Outside_LinRegr)

  # tblColNames <- c("Site"
  #                  , "Degraded"
  #                  , "Stressor Group"
  #                  , "Number of Stressor Samples"
  #                  , "Number of Stressors"
  #                  , "Overall Weight of Evidence"
  #                  , "Time Sequence (inside)"
  #                  , "Co-occurrence (inside)"
  #                  , "Stressor-Response (inside)"
  #                  , "Biological Gradient (inside)"
  #                  , "Verified Prediction (inside)"
  #                  , "Blank1"
  #                  , "Biological Gradient (outside)")
  
  if (report_format == "html") {
    
    sketch <- htmltools::withTags(table(
      class = 'display'
      , thead(
        tr(
          th(rowspan = 2, 'Site')
          , th(rowspan = 2, 'Degraded')
          , th(rowspan = 2, 'Stressor Group')
          , th(rowspan = 2, 'Num. Stressor Samples')
          , th(rowspan = 2, 'Num. Stressors')
          , th(rowspan = 2, 'Overall Weight of Evidence')
          , th(colspan = 5, 'Inside the Case')
          , th(rowspan = 2, '')
          , th(colspan = 1, 'Outside the Case')
        )
        , tr(
            lapply(c('Time Sequence', 'Co-occurrence', 'Stressor-response'
                     , 'Biological gradient', 'Verified prediction'
                     , 'Biological gradient'), th)
        )
      )
    ))
    
    if (nrow(df_BMI_ES) <= 10) {
      DT::datatable(df_BMI_ES
                    , container = sketch
                    , extensions = 'FixedColumns'
                    , options = list(dom = 'ti'
                                     , pageLength = 10
                                     , bSort = FALSE
                                     , scrollX = TRUE
                                     , fixedColumns = TRUE
                                     , columnDefs = list(list(className = 'dt-left'
                                                              , targets = 2)
                                                         , list(className = 'dt-center'
                                                              , targets = c(0:1,3:12))
                                                         , list(className = 'dt-bottom'
                                                              , targets = '_all')))
                    , class = 'striped hover row-border'
                    , filter = 'none'
                    , rownames = FALSE) %>%
        DT::formatStyle(columns = colnames(df_BMI_ES), fontSize = '85%')
    } else {
      DT::datatable(df_BMI_ES
                    , container = sketch
                    , extensions = 'FixedColumns'
                    , options = list(dom = 'lftip'
                                     , pageLength = 10
                                     , bSort = FALSE
                                     , scrollX = TRUE
                                     , fixedColumns = TRUE
                                     , lengthMenu = ifelse(nrow(df_BMI_ES) > 10
                                                           , c(10, 25, 50, 100)
                                                           , 10)
                                     , columnDefs = list(list(className = 'dt-left'
                                                              , targets = 2)
                                                         , list(className = 'dt-center'
                                                              , targets = c(0:1,3:12))
                                                         , list(className = 'dt-bottom'
                                                              , targets = '_all')))
                    , class = ' striped hover row-border'
                    , filter = 'none'
                    , rownames = FALSE) %>%
        DT::formatStyle(columns = colnames(df_BMI_ES), fontSize = '85%')
    }
  
  } else {
    
    msg <- "Not displayed in non-html format."
    cat(msg)
    
  }

} else {
  
  cat(paste0("No paired stressor/benthic macroinvertebrate data are available for ", TargetSiteID, ".\n"))
  
}

```

### Stressor-Specific Results

The table below shows scores for each stressor identified in one or more samples obtained from the bioassessment site `r TargetSiteID`, along with each line of evidence Scores for each line of evidence include:

* 1 for evidence supporting the stressor as a cause of impairment
* -1 for evidence refuting the stressor as a cause of impairment
* 0 for indeterminate evidence
* NE for not evaluated

```{r WoEscores_bmi}

if (boo_BMI == TRUE) {
  
  fn_WoE_Det <- file.path(dir_results
                        , max(list.files(dir_results, pattern = "OverallWoEDetails")))

  df_WoE_Det <- read.delim(fn_WoE_Det, header = TRUE, sep = "\t")
  df_WoE_Det <- df_WoE_Det %>%
    dplyr::filter(StationID_Master == TargetSiteID) %>%
    dplyr::select(-Cluster, -FinalLatitude, -FinalLongitude)
  
  df_BMI_Det <- dplyr::filter(df_WoE_Det, BioComm == "BMI")
  
  df_BMI_Det <- df_BMI_Det %>%
    dplyr::mutate(RespSampDate = sub(".*(\\d{1,2}\\/\\d{1,2}\\/\\d{4}).*"
                                           , " \\1", RespSampID)
                  , ResponseSampleDate = lubridate::mdy(RespSampDate)
                  , StressSampDate = sub(".*(\\d{4}\\-\\d{1,2}\\-\\d{1,2})"
                                           , " \\1", StressSampID)
                  , StressorSampleDate = lubridate::ymd(StressSampDate)
                  , BioNarrative = cut(IndexScore, breaks = BioNarBrk
                                       , labels = BioNarLab)) %>%
    dplyr::select(-BioComm, -RespSampDate, -StressSampDate) %>%
    dplyr::rename(CSCI = IndexScore
                  , ResponseSampleID = RespSampID
                  , Degraded = BioDeg
                  , Narrative = BioNarrative
                  , StressorSampleID = StressSampID
                  , Group = StressorType
                  , PercentRank = StressorPctRank
                  , TS_Inside = TS_barplot
                  , SR_Inside_LogRegr = SR_InCase_LogRegr
                  , SR_Inside_LinRegr = SR_InCase_LinRegr
                  , SR_Outside_LinRegr = SR_OutCase_LinRegr
                  , VP_SensitiveTaxa = VP_boxplot_senstaxa
                  , VP_TolerantTaxa = VP_boxplot_toltaxa)
  
  df_BMI_Det <- dplyr::mutate(df_BMI_Det, CSCI = round(CSCI,3)
                              , PercentRank = round(PercentRank, 3)
                              , StressorValue = ifelse(StressorValue < 1
                                                       , format(StressorValue
                                                                , digits = 3)
                                              , ifelse(StressorValue < 10
                                                       , format(StressorValue
                                                                , digits = 2)
                                              , ifelse(StressorValue < 100
                                                       , format(StressorValue
                                                                , digits = 1
                                                                , scientific = FALSE)
                                                       , format(StressorValue
                                                                , digits = 0
                                                                , big.mark = ",")))))
  
  df_BMI_Det <- merge(df_BMI_Det, df_stresslabs, by.x = "Stressor", by.y = "Analyte"
                      , all.x = TRUE)
  
  df_BMI_Det <- df_BMI_Det %>%
    dplyr::select(-Stressor) %>%
    dplyr::rename(Stressor = Label, SiteID = StationID_Master)
  
  LoEcols = c("TS_Inside", "CO_boxplot", "SR_Inside_LogRegr", "SR_Inside_LinRegr"
              , "SR_Outside_LinRegr", "VP_SensitiveTaxa", "VP_TolerantTaxa"
              , "SSD_ToxicityCurve")
  df_BMI_Det$TotSupport <- rowSums(df_BMI_Det[, LoEcols] == 1)
  df_BMI_Det$TotRefute <- rowSums(df_BMI_Det[, LoEcols] == -1)
  df_BMI_Det$TotIndet <- rowSums(df_BMI_Det[, LoEcols] == 0)
  df_BMI_Det$TotNotEval <- rowSums(df_BMI_Det[, LoEcols] == "NE")
  df_BMI_Det$Blank1 <- NA
  df_BMI_Det$Blank2 <- NA

  
  df_BMI_Det <- dplyr::select(df_BMI_Det, SiteID, Degraded, Narrative, CSCI
                              , ResponseSampleDate, ResponseSampleID, StressorSampleDate
                              , StressorSampleID, Group, Stressor, StressorValue
                              , PercentRank, WoE, TS_Inside, CO_boxplot
                              , SR_Inside_LogRegr, SR_Inside_LinRegr
                              , VP_SensitiveTaxa, VP_TolerantTaxa, Blank1
                              , SR_Outside_LinRegr, SSD_ToxicityCurve, Blank2
                              , TotSupport, TotRefute, TotIndet, TotNotEval)
  
  df_BMI_Det <- dplyr::arrange(df_BMI_Det, desc(Degraded), desc(CSCI), StressorSampleDate
                               , ResponseSampleID, StressorSampleID, Group
                               , Stressor, StressorValue)
  
  # tblColNames <- c("Site"
  #                  , "Degraded"
  #                  , "Condition Narrative"
  #                  , "CSCI"
  #                  , "BMI Sample Date"
  #                  , "BMI Sample ID"
  #                  , "Stressor Sample Date"
  #                  , "Stressor Sample ID"
  #                  , "Stressor Group"
  #                  , "Stressor"
  #                  , "Stressor Value"
  #                  , "Stressor Percent Rank"
  #                  , "Overall Weight of Evidence"
  #                  , "Time Sequence (inside)"
  #                  , "Co-occurrence (inside)"
  #                  , "Stressor-Response (inside)"
  #                  , "Biological Gradient (inside)"
  #                  , "Verified Prediction/ Sensitive Taxa (inside)"
  #                  , "Verified Prediction/ Tolerant Taxa (inside)"
  #                  , "Blank1"
  #                  , "Biological Gradient (outside)"
  #                  , "Taxon Sensitivity Distribution (outside)"
  #                  , "Blank2"
  #                  , "Total Supporting", "Total Refuting", "Total Indeterminate"
  #                  , "Total Not Evaluated")
  
  if (report_format == "html") {
    
    sketch <- htmltools::withTags(table(
      class = 'display'
      , thead(
        tr(
          th(rowspan = 3, 'Site')
          , th(rowspan = 3, 'Degraded')
          , th(rowspan = 3, 'Condition Narrative')
          , th(rowspan = 3, 'CSCI')
          , th(rowspan = 3, 'BMI Sample Date')
          , th(rowspan = 3, 'BMI Sample ID')
          , th(colspan = 6, 'Stressor')
          , th(rowspan = 3, 'Overall Weight of Evidence')
          , th(colspan = 6, 'Inside the Case')
          , th(rowspan = 3, '')
          , th(colspan = 2, 'Outside the Case')
          , th(rowspan = 3, '')
          , th(colspan = 4, "Total Lines of Evidence")
        )
        , tr(
          th(rowspan = 2, 'Sample Date')
          , th(rowspan = 2, 'Sample ID')
          , th(rowspan = 2, 'Group')
          , th(rowspan = 2, 'Name')
          , th(rowspan = 2, 'Value')
          , th(rowspan = 2, 'Percent Rank')
          , th(rowspan = 2, 'Time Sequence')
          , th(rowspan = 2, 'Co-occurrence')
          , th(rowspan = 2, 'Stressor-response')
          , th(rowspan = 2, 'Biological Gradient')
          , th(colspan = 2, 'Verified Prediction')
          , th(rowspan = 2, 'Biological Gradient')
          , th(rowspan = 2, 'Taxon Sensitivity Distribution')
          , th(rowspan = 2, 'Supporting')
          , th(rowspan = 2, 'Refuting')
          , th(rowspan = 2, 'Indeterminate')
          , th(rowspan = 2, 'Not evaluated')
        )
        , tr(
            lapply(c('Sensitive Taxa', 'Tolerant Taxa'), th)
        )
      )
    ))
    
    if (nrow(df_BMI_Det) <= 10) {
      DT::datatable(df_BMI_Det
                    , container = sketch
                    , extensions = 'FixedColumns'
                    , options = list(dom = 'ti'
                                     , pageLength = 10
                                     , bSort = FALSE
                                     , scrollX = TRUE
                                     , fixedColumns = TRUE
                                     , columnDefs = list(list(className = 'dt-left'
                                                             , targets = c(8,9))
                                                         , list(className = 'dt-center'
                                                             , targets = c(1:7,10:26))
                                                         , list(className = 'dt-bottom'
                                                                , targets = "_all")))
                    , class = 'striped hover row-border'
                    , filter = 'none'
                    , rownames = FALSE) %>%
        DT::formatStyle(columns = colnames(df_BMI_Det), fontSize = '85%') %>%
        DT::formatStyle("Stressor", "white-space" = "nowrap") %>%
        DT::formatStyle("StressorSampleID", "white-space" = "nowrap")
    } else {
      DT::datatable(df_BMI_Det
                    , container = sketch
                    , extensions = 'FixedColumns'
                    , options = list(dom = 'lftip'
                                     , pageLength = 10
                                     , bSort = FALSE
                                     , scrollX = TRUE
                                     , fixedColumns = TRUE
                                     , lengthMenu = ifelse(nrow(df_BMI_Det) > 10
                                                           , c(10, 25, 50, 100)
                                                           , 10)
                                     , columnDefs = list(list(className = 'dt-left'
                                                             , targets = c(8,9))
                                                         , list(className = 'dt-center'
                                                             , targets = c(1:7,10:26))
                                                         , list(className = 'dt-bottom'
                                                                , targets = "_all")))
                    , class = 'striped hover row-border'
                    , filter = 'none'
                    , rownames = FALSE) %>%
        DT::formatStyle(columns = colnames(df_BMI_Det), fontSize = '85%') %>%
        DT::formatStyle("Stressor", "white-space" = "nowrap") %>%
        DT::formatStyle("StressorSampleID", "white-space" = "nowrap")
    }
  
  } else {
    
    msg <- "Not displayed in non-html format."
    cat(msg)
    
  }

} else {
  
  cat(paste0("No paired stressor/benthic macroinvertebrate data are available for ", TargetSiteID, ".\n"))
  
}

```

## *Algae Results*

### Overall Weight of Evidence

The table below displays the scores for each line of evidence and overall weight of evidence, weighted by number of stressors in each group. Overall weight of evidence scores include:

* 1 indicates that all evaluated lines of evidence for all observed stressors in the group support the group as a cause of impairment
* -1 indicates that all evaluated lines of evidence for all observed stressors in the group refute the group as a cause of impairment
* 0 indicates that the evaluated lines of evidence for the observed stressors in the group are indeterminate regarding cause of impairment
* NE indicates that the stressor group was not evaluated

Inside refers to evidence from data inside the case, and outside refers to evidence from data outside the case. Data from inside the case includes `r ifelse(useBC == TRUE, msg1, msg2)` Taxon sensitivity curves rely on laboratory toxicity tests and therefore represent data from outside the case.

```{r WoESummaryALG}

if (boo_ALG == TRUE) {

  df_ALG_ES <- dplyr::select(df_ALG_ES, -BioComm, BioDeg, StressorType, NumStressSamples
                             , NumStressors, Overall_WoE, WtTotTS_barplot, WtTotCO_boxplot
                             , WtTotSR_InCase_LogRegr, WtTotSR_InCase_LinRegr
                             , WtTotSR_OutCase_LinRegr, WtTotVP_boxplot)
  df_ALG_ES$Blank1 <- NA
  df_ALG_ES <- dplyr::rename(df_ALG_ES, SiteID = StationID_Master
                         , Degraded = BioDeg
                         , Group = StressorType
                         , Stressor_Samples = NumStressSamples
                         , Stressors = NumStressors
                         , TS_Inside = WtTotTS_barplot
                         , CO_boxplot = WtTotCO_boxplot
                         , SR_Inside_LogRegr = WtTotSR_InCase_LogRegr
                         , SR_Inside_LinRegr = WtTotSR_InCase_LinRegr
                         , SR_Outside_LinRegr = WtTotSR_OutCase_LinRegr
                         , VP_Boxplot = WtTotVP_boxplot)
  df_ALG_ES <- dplyr::select(df_ALG_ES
                             , SiteID
                             , Degraded
                             , Group
                             , Stressor_Samples
                             , Stressors
                             , Overall_WoE
                             , TS_Inside
                             , CO_boxplot
                             , SR_Inside_LogRegr
                             , SR_Inside_LinRegr
                             , VP_Boxplot
                             , Blank1
                             , SR_Outside_LinRegr)

  # tblColNames <- c("Site"
  #                  , "Degraded"
  #                  , "Stressor Group"
  #                  , "Number of Stressor Samples"
  #                  , "Number of Stressors"
  #                  , "Overall Weight of Evidence"
  #                  , "Time Sequence (inside)"
  #                  , "Co-occurrence (inside)"
  #                  , "Stressor-Response (inside)"
  #                  , "Biological Gradient (inside)"
  #                  , "Verified Prediction (inside)"
  #                  , "Blank1"
  #                  , "Biological Gradient (outside)")
  
  if (report_format == "html") {
    
    sketch <- htmltools::withTags(table(
      class = 'display'
      , thead(
        tr(
          th(rowspan = 2, 'Site')
          , th(rowspan = 2, 'Degraded')
          , th(rowspan = 2, 'Stressor Group')
          , th(rowspan = 2, 'Num. Stressor Samples')
          , th(rowspan = 2, 'Num. Stressors')
          , th(rowspan = 2, 'Overall Weight of Evidence')
          , th(colspan = 5, 'Inside the Case')
          , th(rowspan = 2, '')
          , th(colspan = 1, 'Outside the Case')
        )
        , tr(
            lapply(c('Time Sequence', 'Co-occurrence', 'Stressor-response'
                     , 'Biological gradient', 'Verified prediction'
                     , 'Biological gradient'), th)
        )
      )
    ))
    
    if (nrow(df_ALG_ES) <= 10) {
      DT::datatable(df_ALG_ES
                    , container = sketch
                    , extensions = 'FixedColumns'
                    , options = list(dom = 'ti'
                                     , pageLength = 10
                                     , bSort = FALSE
                                     , scrollX = TRUE
                                     , fixedColumns = TRUE
                                     , columnDefs = list(list(className = 'dt-left'
                                                              , targets = 2)
                                                         , list(className = 'dt-center'
                                                              , targets = c(0:1,3:12))
                                                         , list(className = 'dt-bottom'
                                                              , targets = '_all')))
                    , class = 'striped hover row-border'
                    , filter = 'none'
                    , rownames = FALSE) %>%
        DT::formatStyle(columns = colnames(df_ALG_ES), fontSize = '85%')
    } else {
      DT::datatable(df_ALG_ES
                    , container = sketch
                    , extensions = 'FixedColumns'
                    , options = list(dom = 'lftip'
                                     , pageLength = 10
                                     , bSort = FALSE
                                     , scrollX = TRUE
                                     , fixedColumns = TRUE
                                     , lengthMenu = ifelse(nrow(df_ALG_ES) > 10
                                                           , c(10, 25, 50, 100)
                                                           , 10)
                                     , columnDefs = list(list(className = 'dt-left'
                                                              , targets = 2)
                                                         , list(className = 'dt-center'
                                                              , targets = c(0:1,3:12))
                                                         , list(className = 'dt-bottom'
                                                              , targets = '_all')))
                    , class = ' striped hover row-border'
                    , filter = 'none'
                    , rownames = FALSE) %>%
        DT::formatStyle(columns = colnames(df_ALG_ES), fontSize = '85%')
    }
  
  } else {
    
    msg <- "Not displayed in non-html format."
    cat(msg)
    
  }

} else {
  
  cat(paste0("No paired stressor/algal data are available for ", TargetSiteID, ".\n"))
  
}

```

### Stressor-Specific Results

The table below shows scores for each stressor identified in one or more samples obtained from the bioassessment site `r TargetSiteID`, along with each line of evidence Scores for each line of evidence include:

* 1 for evidence supporting the stressor as a cause of impairment
* -1 for evidence refuting the stressor as a cause of impairment
* 0 for indeterminate evidence
* NE for not evaluated

```{r WoEscores_ALG}

if (boo_ALG == TRUE) {
  
  df_ALG_Det <- dplyr::filter(df_WoE_Det, BioComm == "ALGAE")
  
  df_ALG_Det <- df_ALG_Det %>%
    dplyr::mutate(RespSampDate = sub(".*(\\d{1,2}\\/\\d{1,2}\\/\\d{4}).*"
                                           , " \\1"
                                     , RespSampID)
                  , ResponseSampleDate = lubridate::mdy(RespSampDate)
                  , StressSampDate = sub(".*(\\d{4}\\-\\d{1,2}\\-\\d{1,2})"
                                           , " \\1"
                                         , StressSampID)
                  , StressorSampleDate = lubridate::ymd(StressSampDate)
                  , BioNarrative = ifelse(BioDeg == "Yes"
                                          , "Degraded"
                                          , "Not Degraded")) %>%
    dplyr::select(-BioComm, -RespSampDate, -StressSampDate) %>%
    dplyr::rename(MMI_Hybrid = IndexScore
                  , ResponseSampleID = RespSampID
                  , Degraded = BioDeg
                  , Narrative = BioNarrative
                  , StressorSampleID = StressSampID
                  , Group = StressorType
                  , PercentRank = StressorPctRank
                  , TS_Inside = TS_barplot
                  , SR_Inside_LogRegr = SR_InCase_LogRegr
                  , SR_Inside_LinRegr = SR_InCase_LinRegr
                  , SR_Outside_LinRegr = SR_OutCase_LinRegr
                  , VP_SensitiveTaxa = VP_boxplot_senstaxa
                  , VP_TolerantTaxa = VP_boxplot_toltaxa)
  
  df_ALG_Det <- dplyr::mutate(df_ALG_Det, MMI_Hybrid = round(MMI_Hybrid,3)
                              , PercentRank = round(PercentRank, 3)
                              , StressorValue = ifelse(StressorValue < 1
                                                       , format(StressorValue
                                                                , digits = 3)
                                              , ifelse(StressorValue < 10
                                                       , format(StressorValue
                                                                , digits = 2)
                                              , ifelse(StressorValue < 100
                                                       , format(StressorValue
                                                                , digits = 1
                                                                , scientific = FALSE)
                                                       , format(StressorValue
                                                                , digits = 0
                                                                , big.mark = ",")))))
  
  df_ALG_Det <- merge(df_ALG_Det, df_stresslabs, by.x = "Stressor", by.y = "Analyte"
                      , all.x = TRUE)
  
  df_ALG_Det <- df_ALG_Det %>%
    dplyr::select(-Stressor) %>%
    dplyr::rename(Stressor = Label, SiteID = StationID_Master)
  
  LoEcols = c("TS_Inside", "CO_boxplot", "SR_Inside_LogRegr", "SR_Inside_LinRegr"
              , "SR_Outside_LinRegr", "VP_SensitiveTaxa", "VP_TolerantTaxa"
              , "SSD_ToxicityCurve")
  df_ALG_Det$TotSupport <- rowSums(df_ALG_Det[, LoEcols] == 1)
  df_ALG_Det$TotRefute <- rowSums(df_ALG_Det[, LoEcols] == -1)
  df_ALG_Det$TotIndet <- rowSums(df_ALG_Det[, LoEcols] == 0)
  df_ALG_Det$TotNotEval <- rowSums(df_ALG_Det[, LoEcols] == "NE")
  df_ALG_Det$Blank1 <- NA
  df_ALG_Det$Blank2 <- NA
  
  df_ALG_Det <- dplyr::select(df_ALG_Det, SiteID, Degraded, Narrative, MMI_Hybrid
                              , ResponseSampleDate, ResponseSampleID
                              , StressorSampleDate, StressorSampleID, Group
                              , Stressor, StressorValue, PercentRank, WoE
                              , TS_Inside, CO_boxplot, SR_Inside_LogRegr
                              , SR_Inside_LinRegr, VP_SensitiveTaxa
                              , VP_TolerantTaxa, Blank1, SR_Outside_LinRegr
                              , SSD_ToxicityCurve, Blank2, TotSupport
                              , TotRefute, TotIndet, TotNotEval)
  
  df_ALG_Det <- dplyr::arrange(df_ALG_Det, desc(Degraded), desc(MMI_Hybrid)
                               , StressorSampleDate, ResponseSampleID
                               , StressorSampleID, Group, Stressor, StressorValue)
  
  # tblColNames <- c("Site"
  #                  , "Degraded"
  #                  , "Condition Narrative"
  #                  , "MMI Hybrid"
  #                  , "BMI Sample Date"
  #                  , "BMI Sample ID"
  #                  , "Stressor Sample Date"
  #                  , "Stressor Sample ID"
  #                  , "Stressor Group"
  #                  , "Stressor"
  #                  , "Stressor Value"
  #                  , "Stressor Percent Rank"
  #                  , "Overall Weight of Evidence"
  #                  , "Time Sequence (inside)"
  #                  , "Co-occurrence (inside)"
  #                  , "Stressor-Response (inside)"
  #                  , "Biological Gradient (inside)"
  #                  , "Verified Prediction/ Sensitive Taxa (inside)"
  #                  , "Verified Prediction/ Tolerant Taxa (inside)"
  #                  , "Blank1"
  #                  , "Biological Gradient (outside)"
  #                  , "Taxon Sensitivity Distribution (outside)"
  #                  , "Blank2"
  #                  , "Total Supporting", "Total Refuting", "Total Indeterminate"
  #                  , "Total Not Evaluated")
  
  if (report_format == "html") {
    
    sketch <- htmltools::withTags(table(
      class = 'display'
      , thead(
        tr(
          th(rowspan = 3, 'Site')
          , th(rowspan = 3, 'Degraded')
          , th(rowspan = 3, 'Condition Narrative')
          , th(rowspan = 3, 'MMI Hybrid')
          , th(rowspan = 3, 'Algae Sample Date')
          , th(rowspan = 3, 'Algae Sample ID')
          , th(colspan = 6, 'Stressor')
          , th(rowspan = 3, 'Overall Weight of Evidence')
          , th(colspan = 6, 'Inside the Case')
          , th(rowspan = 3, '')
          , th(colspan = 2, 'Outside the Case')
          , th(rowspan = 3, '')
          , th(colspan = 4, "Total Lines of Evidence")
        )
        , tr(
          th(rowspan = 2, 'Sample Date')
          , th(rowspan = 2, 'Sample ID')
          , th(rowspan = 2, 'Group')
          , th(rowspan = 2, 'Name')
          , th(rowspan = 2, 'Value')
          , th(rowspan = 2, 'Percent Rank')
          , th(rowspan = 2, 'Time Sequence')
          , th(rowspan = 2, 'Co-occurrence')
          , th(rowspan = 2, 'Stressor-response')
          , th(rowspan = 2, 'Biological Gradient')
          , th(colspan = 2, 'Verified Prediction')
          , th(rowspan = 2, 'Biological Gradient')
          , th(rowspan = 2, 'Taxon Sensitivity Distribution')
          , th(rowspan = 2, 'Supporting')
          , th(rowspan = 2, 'Refuting')
          , th(rowspan = 2, 'Indeterminate')
          , th(rowspan = 2, 'Not evaluated')
        )
        , tr(
            lapply(c('Sensitive Taxa', 'Tolerant Taxa'), th)
        )
      )
    ))
    
    if (nrow(df_ALG_Det) <= 10) {
      DT::datatable(df_ALG_Det
                    , container = sketch
                    , extensions = 'FixedColumns'
                    , options = list(dom = 'ti'
                                     , pageLength = 10
                                     , bSort = FALSE
                                     , scrollX = TRUE
                                     , fixedColumns = TRUE
                                     , columnDefs = list(list(className = 'dt-left'
                                                             , targets = c(8,9))
                                                         , list(className = 'dt-center'
                                                             , targets = c(1:7,10:26))
                                                         , list(className = 'dt-bottom'
                                                                , targets = "_all")))
                    , class = 'striped hover row-border'
                    , filter = 'none'
                    , rownames = FALSE) %>%
        DT::formatStyle(columns = colnames(df_ALG_Det), fontSize = '85%') %>%
        DT::formatStyle("Stressor", "white-space" = "nowrap") %>%
        DT::formatStyle("StressorSampleID", "white-space" = "nowrap")
    } else {
      DT::datatable(df_ALG_Det
                    , container = sketch
                    , extensions = 'FixedColumns'
                    , options = list(dom = 'lftip'
                                     , pageLength = 10
                                     , bSort = FALSE
                                     , scrollX = TRUE
                                     , fixedColumns = TRUE
                                     , lengthMenu = c(10, 25, 50, 100)
                                     , columnDefs = list(list(className = 'dt-left'
                                                             , targets = c(8,9))
                                                         , list(className = 'dt-center'
                                                             , targets = c(1:7,10:26))
                                                         , list(className = 'dt-bottom'
                                                                , targets = "_all")))
                    , class = 'striped hover row-border'
                    , filter = 'none'
                    , rownames = FALSE) %>%
        DT::formatStyle(columns = colnames(df_ALG_Det), fontSize = '85%') %>%
        DT::formatStyle("Stressor", "white-space" = "nowrap") %>%
        DT::formatStyle("StressorSampleID", "white-space" = "nowrap")
    }
  
  } else {
    
    msg <- "Not displayed in non-html format."
    cat(msg)
    
  }
  
} else {
  
  cat(paste0("No paired stressor/algal data are available for ", TargetSiteID, ".\n"))
  
}

```





---
title: "Map, Leaflet"
subtitle: "RPPTool"
author: "`r Sys.getenv('USERNAME')`"
date: "`r format(Sys.time(), '%Y-%m-%d %H:%M:%S')`"
output:
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: yes
  word_document:
    toc: yes
  pdf_document:
    toc: true
params:
  sites: !r sp_sites
  boundary: !r sp_outline
  reaches: !r sp_flowline
  cxns: !r sp_cxns
  targ: !r sp_target
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(results='asis', echo=FALSE, warning=FALSE)
#TargetSiteID <- "SRCKN001.61"
# dir_results <- "C:\\Users\\Erik.Leppo\\OneDrive - Tetra Tech, Inc\\MyDocs_OneDrive\\GitHub\\CASTfxn\\Results"
#~~~~~~~~~~~~~~~~~
# from getSiteInfo()
# data_Sites
# data_cluster       <- data_Cluster_Hi
# all.map.sites <- merge(data_Sites, data_cluster, by.x = "COMID_NHD2", by.y = "COMID")
```

# Interactive Map

```{r map_leaflet, echo=FALSE, eval=TRUE}

'%>%' <- dplyr::'%>%'

  # Leaflet
  ## Data
  lf_sp_sites <- sf::as_Spatial(params$sites)
  sp_outline <- sf::as_Spatial(params$boundary)
  sp_flowline <- sf::as_Spatial(params$reaches)
  sp_cxns <- sf::as_Spatial(params$cxns)
  sp_targ <- sf::as_Spatial(params$targ)
  sp_cxnsTarg <- rbind(sp_cxns, sp_targ)

  ### Mark sites for legend
  myPCH <- c(19,19,21,17)
  myCEX <- c(0.3, 0.9, 1, 1.2)
  GIS_offset <- 0.75
  
  BCGlevels = c(1,2,3,4,5,6)
  palBCG <- leaflet::colorFactor(palette = viridis::viridis(n=6, option = "C")
                          , domain = BCGlevels, reverse = TRUE, na.color="white")
  palScores <- leaflet::colorNumeric(palette = "viridis", domain = c(0,1)
                              , na.color = "white")
  palCSCI <- leaflet::colorNumeric(palette = "viridis", domain = c(0, 1.5))
  palRank <- leaflet::colorNumeric(palette = grDevices::colorRamp(c("#d8b365", "#fab4ac"))
                                                , sp_flowline$RankByIndexType)

    if (nrow(sp_cxns)==0) { # No TargetCOMID (Just base version)
        
        lmap <- leaflet::leaflet(data = sp_outline) %>%
            # Groups, Base
            # leaflet::addTiles(group = "OSM (default)") %>%
            leaflet::addProviderTiles(leaflet::providers$Stamen.TonerLite
                                      , group="TonerLite (default)") %>%
            leaflet::addProviderTiles(leaflet::providers$Stamen.Terrain
                                      , group = "Terrain") %>%
            # Groups, Overlay
            leaflet::addPolygons(data = sp_outline, color="black" # Boundary
                                 , group = "SMC Region") %>%
            leaflet::addPolylines(data = sp_flowline # All reaches
                                  , color = "lightblue"
                                  , group = "All streams"
                                  , opacity = 0.6
                                  , popup = ~popupText) %>%
            leaflet::addPolylines(data = sp_flowline # All reaches, Rank
                                  , group = "Rank"
                                  , color = ~palRank(RankByIndexType)
                                  , weight = 8
                                  , opacity = 0.8
                                  , popup = ~popupText) %>%
            leaflet::addPolylines(data = sp_flowline # All reaches RPP Index (both types)
                                  , group = "RPP Index"
                                  , color = ~palScores(RPPIndex)
                                  , weight = 8
                                  , opacity = 0.8
                                  , popup = ~popupText) %>%
            leaflet::addCircleMarkers(data=sp_sites # All Sites
                                      , group = "All sites"
                                      , color = "white"
                                      , fillColor = ~palCSCI(CSCI)
                                      , radius = 4
                                      , stroke = TRUE
                                      , weight = 1
                                      , fillOpacity = 0.6
                                      , opacity = 0.6
                                      , popup = ~paste0(StationID_Master, as.character("<br>")
                                                        , "CSCI =", CSCI, as.character("<br>")
                                                        , "BCG Tier =", BCGLevel)) %>%
            # Add Layer Control
            leaflet::addLayersControl(
                baseGroups = c("TonerLite (default)", "Terrain")
                , overlayGroups = c("All sites", "Rank", "RPP Index", "All streams")
                , options = leaflet::layersControlOptions(collapsed = TRUE, autoZIndex = TRUE)) %>%

            # Legend
            leaflet::addLegend("bottomleft", pal = palBCG, values = ~BCGlevels
                               , title = "BCG Tiers", opacity = 1) %>%
            leaflet::addLegend("bottomleft", pal = palCSCI, values = c(0, 1.5)
                               , bins=5, title = "Site CSCI Scores"
                               , opacity = 1) %>%
            leaflet::addLegend("bottomleft", pal = palScores, values = c(0,1)
                               , bins=4, title = "RPPTool Scores", opacity = 1) %>%
            leaflet::addMiniMap("bottomleft")
        
    } else {  # Zoom to connected reaches bounding box
        
        lmap <- leaflet::leaflet(data = sp_outline) %>%
            # Groups, Base
            # leaflet::addTiles(group = "OSM (default)") %>%
            leaflet::addProviderTiles(leaflet::providers$Stamen.TonerLite
                                      , group="TonerLite (default)") %>%
            leaflet::addProviderTiles(leaflet::providers$Stamen.Terrain
                                      , group = "Terrain") %>%
            # Groups, Overlay
            leaflet::addPolygons(data = sp_outline, color="black" # Boundary
                                 , group = "SMC Region") %>%
            leaflet::addPolylines(data = sp_flowline # All reaches
                                  , color = "lightblue"
                                  , group = "All streams"
                                  , opacity = 0.6
                                  , popup = ~popupText) %>%
            leaflet::addPolylines(data = sp_flowline # All reaches, Rank
                                  , group = "Rank"
                                  , color = ~palRank(RankByIndexType)
                                  , weight = 8
                                  , opacity = 0.8
                                  , popup = ~popupText) %>%
            leaflet::addPolylines(data = sp_flowline # All reaches RPP Index (both types)
                                , group = "RPP Index"
                                , color = ~palScores(RPPIndex)
                                , weight = 8
                                , opacity = 0.8
                                , popup = ~popupText) %>%
            leaflet::addCircleMarkers(data=sp_sites # All Sites
                                  , group = "All sites"
                                  , color = "white"
                                  , fillColor = ~palCSCI(CSCI)
                                  , radius = 4
                                  , stroke = TRUE
                                  , weight = 1
                                  , fillOpacity = 0.6
                                  , opacity = 0.6
                                  , popup = ~paste0(StationID_Master, as.character("<br>")
                                                    , "CSCI =", CSCI, as.character("<br>")
                                                    , "BCG Tier =", BCGLevel)) %>%
            # Add Layer Control
            leaflet::addLayersControl(
                baseGroups = c("TonerLite (default)", "Terrain")
                , overlayGroups = c("All sites", "Rank", "RPP Index", "All streams")
                , options = leaflet::layersControlOptions(collapsed = TRUE, autoZIndex = TRUE)) %>%
            # Bounding (to connected reaches)
            leaflet::fitBounds(lng1 = sp_bbox[1]
                               , lat1 = sp_bbox[4]
                               , lng2 = sp_bbox[3]
                               , lat2 = sp_bbox[2]) %>%
            # Legend
            leaflet::addLegend("bottomleft", pal = palBCG, values = ~BCGlevels
                               , title = "BCG Tiers", opacity = 1) %>%
            leaflet::addLegend("bottomleft", pal = palCSCI, values = c(0, 1.5)
                               , bins=5, title = "Site CSCI Scores"
                               , opacity = 1) %>%
            leaflet::addLegend("bottomleft", pal = palScores, values = c(0,1)
                               , bins=4, title = "RPPTool Scores", opacity = 1) %>%
            leaflet::addMiniMap("bottomleft")
        
    }    
  
  # MAP#leaflet::addProviderTiles("CartoDB.Positron") %>% (not working)
  # m1 <- leaflet::leaflet(data=df_leaflet) %>% 
  #               leaflet::addProviderTiles(leaflet::providers$Stamen.TonerLite) %>%
  #               leaflet::addCircleMarkers(lng = ~FinalLongitude
  #                                , lat = ~FinalLatitude
  #                                , color = ~myColors(MapLeg)
  #                                , radius=3
  #                                , stroke=FALSE
  #                                , fillOpacity = 0.8
  #                                , opacity = 0.8
  #                                , popup=~StationID_Master) %>%
  #               leaflet::addCircles(data=df_leaflet[df_leaflet$CARefSite_2017==1,]
  #                          , lng=~FinalLongitude
  #                          , lat=~FinalLatitude
  #                          , color="blue") %>% 
  #               leaflet::addCircles(data=df_leaflet[df_leaflet[,"StationID_Master"]==TargetSiteID, ]
  #                           , lng=~FinalLongitude
  #                           , lat=~FinalLatitude
  #                          , color="red"
  #                          , radius=5) %>%
  #               leaflet::fitBounds(lng1 = df_leaflet[df_leaflet$StationID_Master==TargetSiteID
  #                                                    , "FinalLongitude"]+GIS_offset
  #                     , lat1 = df_leaflet[df_leaflet$StationID_Master==TargetSiteID
  #                                         , "FinalLatitude"]+GIS_offset
  #                     , lng2 = df_leaflet[df_leaflet$StationID_Master==TargetSiteID
  #                                         , "FinalLongitude"]-GIS_offset
  #                     , lat2 = df_leaflet[df_leaflet$StationID_Master==TargetSiteID
  #                                         , "FinalLatitude"]-GIS_offset)
  # 
  # 
  # m1              
                
# # save widget              
# library(htmlwidgets)
# fn_map_leaflet <- file.path(getwd(), "Results", TargetSiteID, paste0(TargetSiteID,".map.leaflet.html"))
# htmlwidgets::saveWidget(m1, fn_map_leaflet)
```
